<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>AGB-Star-Deprojection API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#DataArray1D">DataArray1D</a>
            </li>
            <li>
                    <a class="variable" href="#DataArray3D">DataArray3D</a>
            </li>
            <li>
                    <a class="variable" href="#Matrix2x2">Matrix2x2</a>
            </li>
            <li>
                    <a class="variable" href="#VelocityModel">VelocityModel</a>
            </li>
            <li>
                    <a class="class" href="#FITSHeaderError">FITSHeaderError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#CondensedData">CondensedData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CondensedData.__init__">CondensedData</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.x_offsets">x_offsets</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.y_offsets">y_offsets</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.v_offsets">v_offsets</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.star_name">star_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.distance_to_star">distance_to_star</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.v_exp">v_exp</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.v_sys">v_sys</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.beta">beta</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.r_dust">r_dust</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.beam_maj">beam_maj</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.beam_min">beam_min</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.beam_angle">beam_angle</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.header">header</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.mean">mean</a>
                        </li>
                        <li>
                                <a class="variable" href="#CondensedData.std">std</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StarData">StarData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StarData.__init__">StarData</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.v0">v0</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.X">X</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.Y">Y</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.V">V</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.distance_to_star">distance_to_star</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.B">B</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.beam_maj">beam_maj</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.beam_min">beam_min</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.beam_angle">beam_angle</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.mean">mean</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.std">std</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.v_sys">v_sys</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.v_exp">v_exp</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.beta">beta</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.r_dust">r_dust</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.radius">radius</a>
                        </li>
                        <li>
                                <a class="variable" href="#StarData.beta_velocity_law">beta_velocity_law</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.export">export</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.get_filtered_data">get_filtered_data</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.beam_filter">beam_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.get_expansion">get_expansion</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.plot_velocity_vs_intensity">plot_velocity_vs_intensity</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.plot_radius_vs_intensity">plot_radius_vs_intensity</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.plot_radius_vs_velocity">plot_radius_vs_velocity</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.plot_channel_maps">plot_channel_maps</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.create_mask">create_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#StarData.plot_3D">plot_3D</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
AGB-Star-Deprojection    </h1>

                        <div class="docstring"><p>Python package for visualising the circumstellar envelopes of AGB stars.</p>
</div>

                        <input id="mod-AGB-Star-Deprojection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-AGB-Star-Deprojection-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Python package for visualising the circumstellar envelopes of AGB stars.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io.fits</span><span class="w"> </span><span class="kn">import</span> <span class="n">PrimaryHDU</span><span class="p">,</span> <span class="n">Header</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colormaps</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ellipse</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">float64</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpn</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize.elementwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_root</span><span class="p">,</span> <span class="n">bracket_root</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span> 
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">integrate</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.widgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">LassoSelector</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">AxesImage</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backend_bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">MouseEvent</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="c1"># custom type aliases</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="n">DataArray1D</span> <span class="o">=</span> <span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">dtype</span><span class="p">[</span><span class="n">float64</span><span class="p">]]</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="n">DataArray3D</span> <span class="o">=</span> <span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">dtype</span><span class="p">[</span><span class="n">float64</span><span class="p">]]</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="n">Matrix2x2</span> <span class="o">=</span> <span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="p">[</span><span class="n">float64</span><span class="p">]]</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="n">VelocityModel</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">ndarray</span><span class="p">]</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="c1"># custom errors</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FITSHeaderError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    Raised when the FITS file header is missing necessary information, or storing it as the wrong type.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="k">pass</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="nd">@dataclass</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CondensedData</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    Container for storing a condensed version of the data cube and its associated metadata.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    **Attributes**</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">    - `x_offsets` (`DataArray1D`): 1D array of x-coordinates (offsets) in AU.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    - `y_offsets` (`DataArray1D`): 1D array of y-coordinates (offsets) in AU.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    - `v_offsets` (`DataArray1D`): 1D array of velocity offsets in km/s.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    - `data` (`DataArray3D`): 3D data array (velocity, y, x) containing the intensity values.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">    - `star_name` (`str`): Name of the star or object.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    - `distance_to_star` (`float`): Distance to the star in AU.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">    - `v_exp` (`float`): Expansion velocity in km/s.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">    - `v_sys` (`float`): Systemic velocity in km/s.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    - `beta` (`float`): Beta parameter of the velocity law.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">    - `r_dust` (`float`): Dust formation radius in AU.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">    - `beam_maj` (`float`): Major axis of the beam in degrees.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    - `beam_min` (`float`): Minor axis of the beam in degrees.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">    - `beam_angle` (`float`): Beam position angle in degrees.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">    - `header` (`Header`): FITS header containing metadata.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">    - `mean` (`float` or `None`, optional): Mean intensity of the data (default is None).</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    - `std` (`float` or `None`, optional): Standard deviation of the data (default is None).</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="n">x_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="n">y_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="n">v_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="n">star_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>    <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="n">r_dust</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="n">beam_maj</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="n">beam_min</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="n">beam_angle</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="n">header</span><span class="p">:</span> <span class="n">Header</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StarData</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    Class for manipulating and analyzing astronomical data cubes of radially expanding circumstellar envelopes.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">    The StarData class provides a comprehensive interface for loading, processing, analyzing, and visualizing</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">    3D data cubes (typically from FITS files) representing the emission from expanding circumstellar shells.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">    It supports both direct loading from FITS files and from preprocessed CondensedData objects, and manages</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">    all relevant metadata and derived quantities.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">    Key Features</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">    ------------</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">    - **Data Loading:** Supports initialization from FITS files or CondensedData objects.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">    - **Metadata Management:** Stores and exposes all relevant observational and physical parameters, including</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">      beam properties, systemic and expansion velocities, beta velocity law parameters, and FITS header information.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">    - **Noise Estimation:** Automatically computes mean and standard deviation of background noise for filtering.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    - **Filtering:** Provides methods to filter data by significance (standard deviations) and to remove small clumps</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">      of points that fit within the beam (beam filtering).</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    - **Coordinate Transformations:** Handles conversion between velocity space and spatial (cartesian) coordinates,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">      supporting both constant velocity models and general velocity laws.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">    - **Time Evolution:** Can compute the expansion of the envelope over time, transforming the data cube accordingly.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">    - **Visualization:** Includes a variety of plotting methods:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        - Channel maps (2D slices through velocity channels)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        - 3D volume rendering (with Plotly)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        - Diagnostic plots for velocity/intensity and radius/velocity relationships</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">    - **Interactive Masking:** Supports interactive creation of masks for manual data cleaning.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">    Attributes</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">    ------------</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    - `data` (`DataArray3D`): The main data cube (v, y, x) containing intensity values.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">    - `X` (`DataArray1D`): 1D array of x-coordinates (offsets) in AU.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">    - `Y` (`DataArray1D`): 1D array of y-coordinates (offsets) in AU.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">    - `V` (`DataArray1D`): 1D array of velocity offsets in km/s.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">    - `distance_to_star` (`float`): Distance to the star in AU.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">    - `beam_maj` (`float`): Major axis of the beam in degrees.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">    - `beam_min` (`float`): Minor axis of the beam in degrees.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">    - `beam_angle` (`float`): Beam position angle in degrees.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">    - `mean` (`float`): Mean intensity of the background noise.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">    - `std` (`float`): Standard deviation of the background noise.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">    - `v_sys` (`float`): Systemic velocity in km/s.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">    - `v_exp` (`float`): Expansion velocity in km/s.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">    - `beta` (`float`): Beta parameter of the velocity law.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">    - `r_dust` (`float`): Dust formation radius in AU.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    - `radius` (`float`): Characteristic radius (e.g., maximum intensity change) in AU.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    - `beta_velocity_law` (`VelocityModel`): Callable implementing the beta velocity law with the current object&#39;s parameters.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">    - `star_name` (`str`): Name of the star or object.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    Methods</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">    -------</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    - `export() -&gt; CondensedData`: Export all defining attributes to a CondensedData object.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    - `get_filtered_data(stds=5)`: Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">    - `beam_filter(filtered_data)`: Remove clumps of points that fit inside the beam, setting these values to np.nan.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    - `get_expansion(years, v_func, ...)`: Compute the expanded data cube after a given time interval.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    - `plot_channel_maps(...)`: Plot the data cube as a set of 2D channel maps.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    - `plot_3D(...)`: Plot a 3D volume rendering of the data cube using Plotly.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    - `plot_velocity_vs_intensity(...)`: Plot velocity vs. intensity at the center of the xy plane.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    - `plot_radius_vs_intensity()`: Plot radius vs. intensity at the center of the xy plane.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">    - `plot_radius_vs_velocity(...)`: Plot radius vs. velocity at the center of the xy plane.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">    - `create_mask(...)`: Launch an interactive mask creator for the data cube.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>    <span class="n">_c</span> <span class="o">=</span> <span class="mf">299792.458</span>  <span class="c1"># speed of light, km/s</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>    <span class="n">v0</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># km/s, speed of sound</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="n">info_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">CondensedData</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="n">rest_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="n">maskfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">beta_law_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        Initialize a StarData object by reading data from a FITS file or a CondensedData object.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">        - `info_source` (`str` or `CondensedData`): Path to a FITS file or a CondensedData object containing preprocessed data.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        - `distance_to_star` (`float` or `None`, optional): Distance to the star in AU (required if info_source is a FITS file).</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        - `rest_frequency` (`float` or `None`, optional): Rest frequency in Hz (required if info_source is a FITS file).</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        - `maskfile` (`str` or `None`, optional): Path to a .npy file containing a mask to apply to the data.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        - `beta_law_params` (`tuple` of `float` or `None`, optional): (r_dust (AU), beta) parameters for the beta velocity law. If None, will be fit from data.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">        - `v_exp` (`float` or `None`, optional): Expansion velocity in km/s. If None, will be fit from data.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">        - `v_sys` (`float` or `None`, optional): Systemic velocity in km/s. If None, will be fit from data.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        - `absolute_star_pos` (`tuple` of `float` or `None`, optional): Absolute (RA, Dec) position of the star in degrees. If None, taken to be the centre of the image.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        **Raises**</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">        - `ValueError`: If required parameters are missing when reading from a FITS file.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">        - `FITSHeaderError`: If any attribute in the FITS file header is an incorrect type.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="k">if</span> <span class="n">distance_to_star</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rest_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distance to star and rest frequency required when reading from FITS file.&quot;</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__load_from_fits_file</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="n">distance_to_star</span><span class="p">,</span> <span class="n">rest_frequency</span><span class="p">,</span> <span class="n">absolute_star_pos</span><span class="p">,</span> <span class="n">v_sys</span> <span class="o">=</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">()</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">beta_law_params</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>            <span class="c1"># load from CondensedData</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">x_offsets</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">y_offsets</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_V</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_offsets</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_exp</span> <span class="k">if</span> <span class="n">v_exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_exp</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_sys</span> <span class="k">if</span> <span class="n">v_sys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_sys</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">r_dust</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beta</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_maj</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_min</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">header</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__process_beam</span><span class="p">()</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="c1"># compute mean and standard deviation</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>            <span class="k">if</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mean_and_std</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="k">if</span> <span class="n">maskfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="c1"># mask data (permanent)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">maskfile</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">*</span> <span class="n">mask</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>    <span class="c1"># ---- READ ONLY ATTRIBUTES ----</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>    <span class="nd">@property</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        DataArray3D </span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        </span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">        Stores the intensity of light at each data point.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">        </span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">        Dimensions: k x m x n, where k is the number of frequency channels,</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">        m is the number of declination channels, and n is the number of right ascension channels.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>    <span class="nd">@property</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        DataArray1D </span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">        </span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">        Stores the x-coordinates relative to the centre in AU.</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">        Obtained from right ascension coordinates.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="nd">@property</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">        DataArray1D</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">         </span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">        Stores the y-coordinates relative to the centre in AU.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">        Obtained from declination coordinates.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="nd">@property</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">V</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">        DataArray1D</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">        </span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">        Stores the velocity offsets relative to the star velocity in km/s.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">        Obtained from frequency channels.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_V</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>    <span class="nd">@property</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">distance_to_star</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        Distance to star in AU.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="nd">@property</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix2x2</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        Matrix2x2</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        Ellipse matrix of beam. For 1x2 vectors v, w with coordinates (ra, dec) in degrees,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        if (v-w)^T B (v-w) &lt; 1, then v is within the beam centred at w.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="nd">@property</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_maj</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        Major axis of the beam in degrees.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>    <span class="nd">@property</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        Minor axis of the beam in degrees.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>    <span class="nd">@property</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">        Beam position angle in degrees.</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="nd">@property</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">        The mean intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="nd">@property</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">        The standard deviation of the intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="nd">@property</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">        The systemic velocity of the star in km/s.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>    <span class="nd">@property</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        The maximum radial expansion speed in km/s.</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>    <span class="nd">@property</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">        Beta parameter of the velocity law.</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>    <span class="nd">@property</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">r_dust</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        Dust formation radius in AU.</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="nd">@property</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        Characteristic radius (e.g., maximum intensity change).</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="nd">@property</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta_velocity_law</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VelocityModel</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">        VelocityModel</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">        Returns a callable implementing the beta velocity law with the current object&#39;s parameters.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">law</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="k">return</span> <span class="n">law</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>    <span class="c1"># ---- EXPORT ----</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">        Export all defining attributes to a CondensedData object.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="k">return</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span> 
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="c1"># ---- HELPER METHODS FOR INITIALISATION ----</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__header_check</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        Check that the FITS header contains all required values with appropriate types.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        Parameters</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        ----------</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        header : Header</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">            FITS header object to check.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">        Returns</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">        -------</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">        missing_beam : bool</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">            True if beam parameters are missing from the header, False otherwise.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        Raises</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        ------</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        FITSHeaderError</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">            If any required attribute is present but has an incorrect type.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">missing_beam</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="n">types_to_check</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="s2">&quot;BSCALE&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>            <span class="s2">&quot;BZERO&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="s2">&quot;OBJECT&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="s2">&quot;BMAJ&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="s2">&quot;BMIN&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="s2">&quot;BPA&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>            <span class="s2">&quot;BTYPE&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="s2">&quot;BUNIT&quot;</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="p">}</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CTYPE&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CDELT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="c1"># check if beam is present in data</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="k">if</span> <span class="s2">&quot;BMAJ&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="s2">&quot;BMIN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="s2">&quot;BPA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="n">missing_beam</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">types_to_check</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">,</span> <span class="s2">&quot;BMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">missing_beam</span><span class="p">:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>                <span class="k">continue</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">attr_type</span> <span class="o">=</span> <span class="n">types_to_check</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="ow">is</span> <span class="n">attr_type</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                <span class="k">raise</span> <span class="n">FITSHeaderError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Header attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> should have type </span><span class="si">{</span><span class="n">attr_type</span><span class="si">}</span><span class="s2">, instead is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">return</span> <span class="n">missing_beam</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__load_from_fits_file</span><span class="p">(</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="n">rest_freq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        Load data and metadata from a FITS file and initialize StarData attributes.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">        Parameters</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        ----------</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">        filename : str</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">            Path to the FITS file.</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        distance_to_star : float</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">            Distance to the star in AU.</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        rest_freq : float</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">            Rest frequency in Hz.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">        absolute_star_pos : tuple of float or None, optional</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">            Absolute (RA, Dec) position of the star in degrees. If None, use image center.</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        v_sys : float or None, optional</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">            Systemic velocity in km/s. If None, will be fit from data.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        v_exp : float or None, optional</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">            Expansion velocity in km/s. If None, will be fit from data.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        Returns</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        -------</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        None</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        Raises</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        ------</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        FITSHeaderError</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">            If the FITS header is missing required attributes or has incorrect types.</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        AssertionError</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">            If the FITS file does not contain data.</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="c1"># read data from file</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="n">hdu</span><span class="p">:</span> <span class="n">PrimaryHDU</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># type: ignore</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="n">missing_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__header_check</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>  <span class="c1"># check that all the information is available before proceeding</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">:</span> <span class="n">Header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>            <span class="k">if</span> <span class="n">missing_beam</span><span class="p">:</span>  <span class="c1"># data is in hdul[1].data instead</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>                <span class="n">beam_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                <span class="n">str_to_conversion</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>                    <span class="s2">&quot;arcsec&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>                    <span class="s2">&quot;deg&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                    <span class="s2">&quot;degrees&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                    <span class="s2">&quot;degree&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="p">}</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                <span class="n">unit_maj</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TUNIT1&quot;</span><span class="p">]</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                <span class="n">unit_min</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>                <span class="c1"># 1 arcsec = 1/3600 degree</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span><span class="o">*</span><span class="n">str_to_conversion</span><span class="p">[</span><span class="n">unit_maj</span><span class="p">]</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span><span class="o">*</span><span class="n">str_to_conversion</span><span class="p">[</span><span class="n">unit_min</span><span class="p">]</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="n">brightness_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BSCALE&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="n">brightness_zero</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BZERO&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="c1"># scale data to be in specified brightness units</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>            <span class="k">assert</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">float64</span><span class="p">)</span><span class="o">*</span><span class="n">brightness_scale</span><span class="o">+</span><span class="n">brightness_zero</span>  <span class="c1">#freq, dec, ra</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span> <span class="o">=</span> <span class="n">distance_to_star</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="c1"># get velocities from frequencies</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="n">freq_range</span><span class="p">:</span> <span class="n">DataArray1D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="n">vel_range</span><span class="p">:</span> <span class="n">DataArray1D</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freq_range</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">rest_freq</span><span class="p">)</span><span class="o">*</span><span class="n">rest_freq</span><span class="o">*</span><span class="n">StarData</span><span class="o">.</span><span class="n">_c</span>  <span class="c1"># velocity in km/s</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="k">if</span> <span class="n">vel_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># array is backwards</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="n">vel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">vel_range</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="c1"># get X and Y coordinates</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">ra_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">dec_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># reverse !!</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="k">if</span> <span class="n">absolute_star_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="n">ra_offsets</span> <span class="o">=</span> <span class="n">ra_vals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ra_vals</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="n">dec_offsets</span> <span class="o">=</span> <span class="n">dec_vals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_vals</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="n">ra_offsets</span> <span class="o">=</span> <span class="n">ra_vals</span> <span class="o">-</span> <span class="n">absolute_star_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="n">dec_offsets</span> <span class="o">=</span> <span class="n">dec_vals</span> <span class="o">-</span> <span class="n">absolute_star_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">ra_offsets</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>  <span class="c1"># measured in AU</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">dec_offsets</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__process_beam</span><span class="p">()</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># get mean and standard deviation of intensity values of noise</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mean_and_std</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="c1"># get velocity offsets</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_star_and_exp_velocity</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">v_sys</span> <span class="o">=</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_V</span> <span class="o">=</span> <span class="n">vel_range</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__process_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        Compute the beam ellipse matrix and pixel offsets for the beam and its boundary.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        Returns</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">        -------</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">        None</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">        Notes</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="sd">        -----</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        Sets the attributes `_B`, `_offset_in_beam`, and `_boundary_offset` for use in beam-related calculations.</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="c1"># get matrix for elliptical distance corresponding to beam</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="n">major</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>  <span class="c1"># type: ignore</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>        <span class="n">minor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="o">/</span><span class="mi">2</span>  <span class="c1"># type: ignore</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>        <span class="c1"># degress -&gt; radians</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>  <span class="c1"># type: ignore</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="p">])</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">minor</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">major</span><span class="p">])</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B</span> <span class="o">=</span> <span class="n">R</span><span class="nd">@D@D@R</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># beam matrix: (v-w)^T B (v-w) &lt; 1 means v is within beam centred at w</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pixels_in_beam</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__pixels_in_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">major</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">        Determine which pixel offsets are inside or on the boundary of the beam ellipse.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        Parameters</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        ----------</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">        major : float</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">            Length of the major axis of the ellipse, in degrees.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">        Returns</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        -------</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">        pixels_in_beam : list of tuple of int</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">            List of (x, y) offsets inside the beam ellipse, relative to the center.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">        pixels_on_bdry : list of tuple of int</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">            List of (x, y) offsets on the boundary of the beam ellipse, relative to the center.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="n">delta_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="n">delta_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="n">bound_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">major</span><span class="o">/</span><span class="n">delta_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># square to bound search in x direction</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="n">bound_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">major</span><span class="o">/</span><span class="n">delta_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># y direction</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="n">pixels_on_bdry</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="n">pixels_in_beam</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">for</span> <span class="n">x_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">bound_x</span><span class="p">,</span> <span class="n">bound_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="k">for</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">bound_y</span><span class="p">,</span> <span class="n">bound_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                <span class="c1"># get position and elliptic distance from origin</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delta_x</span><span class="o">*</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">delta_y</span><span class="o">*</span><span class="n">y_offset</span><span class="p">])</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="n">pos</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="c1"># determine if on boundary or inside ellipse</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="mf">1.2</span><span class="p">:</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                    <span class="n">pixels_on_bdry</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">))</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                <span class="k">elif</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                    <span class="n">pixels_in_beam</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">))</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">return</span> <span class="n">pixels_in_beam</span><span class="p">,</span> <span class="n">pixels_on_bdry</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_header_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        Get coordinate values from the FITS header for RA, DEC, or FREQ axes.</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        Parameters</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">        ----------</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">        num : {1, 2, 3}</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">            Axis number: 1 for RA, 2 for DEC, 3 for FREQ.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        Returns</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        -------</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        vals : DataArray1D</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">            1-D array of coordinate values for the specified axis, computed from the header.</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="n">vals_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vals_length</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="c1"># vals[i] should be delta*(i - x0) + y0, for 1-indexing. but we are 0-indexed</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y0</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="k">return</span> <span class="n">vals</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__mean_and_std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        Calculate the mean and standard deviation of the background noise, by looking at points away from the center.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">        Returns</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">        -------</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">        mean : float</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">            Mean intensity of the background noise.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        std : float</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">            Standard deviation of the background noise.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="c1"># trim, as edges can be unreliable</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">outer_trim</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># remove outer 1/20th</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="n">frames</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">x_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="n">trimmed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">:</span><span class="n">x_obs</span> <span class="o">-</span> <span class="n">x_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">]</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">frames</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">x_obs</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="c1"># take edges of trimmed data</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="n">inner_trim</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># take outer 1/5 th</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="n">left_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="n">right_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="n">top_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="n">bottom_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">-</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">left_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:</span><span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">right_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">top_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">bottom_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">-</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="n">ring</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">left_close</span><span class="p">,</span> <span class="n">right_close</span><span class="p">,</span> <span class="n">top_close</span><span class="p">,</span> <span class="n">bottom_close</span><span class="p">,</span> <span class="n">left_far</span><span class="p">,</span> <span class="n">right_far</span><span class="p">,</span> <span class="n">top_far</span><span class="p">,</span> <span class="n">bottom_far</span><span class="p">))</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ring</span><span class="p">)]</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Only {len(ring)} data points selected for finding mean and standard deviation of noise.&quot;</span><span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>        <span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>        <span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__multiply_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        Generate a list of pixel offsets that represent the beam, scaled by a factor.</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">        Parameters</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        ----------</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        times : float or int</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">            Scaling factor for the beam size.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        Returns</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">        -------</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">        insides : list of tuple of int</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">            List of (x, y) offsets inside the scaled beam.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="k">if</span> <span class="n">times</span> <span class="o">&lt;=</span> <span class="mf">0.0001</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="n">insides</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="n">beam_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">]))</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="c1"># search a square around the origin</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                <span class="c1"># check if point would shrink into beam</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">times</span><span class="p">))</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                    <span class="n">insides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="k">return</span> <span class="n">insides</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_centre_intensities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_widths</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">        Calculate the mean intensity at the center of each velocity channel, averaged over a region the size of the beam.</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        Parameters</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        ----------</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">        beam_widths : float or int, optional</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">            Scale factor of beam (default is 1).</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        Returns</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">        -------</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        all_densities : DataArray1D</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">            Array of mean intensities for each velocity channel.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="c1"># centre index</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="n">beam_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_beam</span><span class="p">(</span><span class="n">beam_widths</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">density_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="c1"># compute average density</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="n">total</span> <span class="o">=</span>  <span class="mi">0</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="n">beam_pixels</span><span class="p">:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                    <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                <span class="k">if</span> <span class="n">intensity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intensity</span><span class="p">):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                    <span class="n">total</span> <span class="o">+=</span> <span class="n">intensity</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="n">density_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">beam_pixels</span><span class="p">))</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="n">all_densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="k">return</span> <span class="n">all_densities</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_star_and_exp_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        Computes the systemic and expansion velocities, in km/s, by fitting a parabola to the centre intensities.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">        Parameters</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">        ----------</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        vel_range : DataArray1D</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">            1-D array of channel velocities in km/s.</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        plot : bool, optional</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">            If True, plot the iterative process (default is False).</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        fit_parabola : bool, optional</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">            If True, plot a fitted parabola (default is False).</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        v_sys : float or None, optional</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">            If provided, use this as the systemic velocity (default is None).</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        v_exp : float or None, optional</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">            If provided, use this as the expansion velocity (default is None).</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        Returns</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        -------</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">        v_sys : float</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">            Systemic velocity in km/s.</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        v_exp : float</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">            Expansion velocity in km/s.</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="n">given_v_sys</span> <span class="o">=</span> <span class="n">v_sys</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="n">given_v_exp</span> <span class="o">=</span> <span class="n">v_exp</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="k">if</span> <span class="n">given_v_exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">given_v_sys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="k">return</span> <span class="n">given_v_sys</span><span class="p">,</span> <span class="n">given_v_exp</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="n">all_densities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_centre_intensities</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="n">v_exp_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="n">v_sys_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="n">densities</span> <span class="o">=</span> <span class="n">all_densities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>  <span class="c1"># loop until computation converges</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="n">densities</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">densities</span><span class="p">)</span> <span class="c1"># normalise</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>            <span class="n">v_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">given_v_sys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">given_v_sys</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="n">v_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">vel_range</span> <span class="o">-</span> <span class="n">v_sys</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">densities</span><span class="p">))</span> <span class="k">if</span> <span class="n">given_v_exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">given_v_exp</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v_exp_seen</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v_sys_seen</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">)):</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            <span class="n">v_exp_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_exp_seen</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="n">v_sys_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_sys_seen</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="n">densities</span> <span class="o">=</span> <span class="n">all_densities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="n">densities</span><span class="p">[</span><span class="n">vel_range</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">v_sys</span> <span class="o">-</span> <span class="n">v_exp</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="n">densities</span><span class="p">[</span><span class="n">vel_range</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">v_sys</span> <span class="o">+</span> <span class="n">v_exp</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Systemic and expansion velocity computation did not converge after 100 iterations.&quot;</span><span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="k">break</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">fit_parabola</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="n">parabola</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span><span class="p">((</span><span class="n">vel_range</span> <span class="o">-</span> <span class="n">v_sys</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">v_exp</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="n">parabola</span><span class="p">[</span><span class="n">parabola</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="n">parabola</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">parabola</span><span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">parabola</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;parabola&quot;</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Determining v_sys, v_exp&quot;</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Relative velocity (km/s)&quot;</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at centre point (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="k">return</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_beta_law</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_intensities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_velocities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_beta_law</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        Fit the beta velocity law to the data and return the dust formation radius, beta parameter, and the radius of maximum intensity change.</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">        Parameters</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        ----------</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">        plot_intensities : bool, optional</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">            If True, plot intensity vs. radius (default is False).</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">        plot_velocities : bool, optional</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="sd">            If True, plot velocity vs. radius (default is False).</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="sd">        plot_beta_law : bool, optional</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="sd">            If True, plot the fitted beta law (default is False).</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">        Returns</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">        -------</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">        r_dust : float</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">            Dust formation radius.</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        beta : float</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">            Beta parameter of the velocity law.</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        radius : float</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">            Radius of maximum intensity change.</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_centre_intensities</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">v_from_i</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensities</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>    
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">centre_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">centre_idx</span><span class="p">]</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="n">max_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">))</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="n">precision</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">))</span><span class="o">//</span><span class="mi">2</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>  <span class="c1"># average intensity in each ring</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="n">ring</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="o">&amp;</span>  <span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            <span class="n">avg_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ring</span><span class="p">)])</span> 
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">avg_intensity</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">outer</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deltas</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">inner</span><span class="p">[(</span><span class="n">inner</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outer</span><span class="p">[</span><span class="n">outer</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]))</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">v_from_i</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">V</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">V</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">radius_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">radius</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">radius_index</span><span class="p">]</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="k">if</span> <span class="n">plot_intensities</span><span class="p">:</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;intensities&quot;</span><span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Radius (AU)&quot;</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average intensity at each radius&quot;</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="n">v_fit</span> <span class="o">=</span> <span class="n">V</span><span class="p">[(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">r_fit</span> <span class="o">=</span> <span class="n">R</span><span class="p">[(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="k">if</span> <span class="n">plot_velocities</span><span class="p">:</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">,</span> <span class="n">r_fit</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span>  <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="k">if</span> <span class="n">plot_velocities</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;velocities&quot;</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="k">if</span> <span class="n">plot_beta_law</span><span class="p">:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                <span class="n">LAW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;beta law&quot;</span><span class="p">)</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Radius (AU)&quot;</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Velocity (km/s)&quot;</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Velocity at each radius&quot;</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="k">return</span> <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">radius</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__general_beta_velocity_law</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">r_dust</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        General beta velocity law.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        Parameters</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        ----------</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        r : array_like</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">            Radius values.</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">        r_dust : float</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">            Dust formation radius.</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        beta : float</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">            Beta parameter.</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">        Returns</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">        -------</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">        v : array_like</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">            Velocity at each radius.</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">r_dust</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="n">beta</span><span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>    
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="c1"># ---- FILTERING DATA ----</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_filtered_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        - `stds` (`float` or `int`, optional): Number of standard deviations to filter by (default is 5).</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        **Returns**</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): Filtered data array.</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="n">filtered_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># creates a deep copy</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">filtered_data</span><span class="p">[</span><span class="n">filtered_data</span> <span class="o">&lt;</span> <span class="n">stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="k">return</span> <span class="n">filtered_data</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtered_data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        Remove clumps of points that fit inside the beam, setting these values to np.nan.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): 3-D array with the same dimensions as the data array.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        **Returns**</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        - `beam_filtered_data` (`DataArray3D`): 3-D array with small clumps of points removed.</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="n">beam_filtered_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)):</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="k">for</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">])):</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>                <span class="k">for</span> <span class="n">x_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">])):</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">][</span><span class="n">x_idx</span><span class="p">]):</span>  <span class="c1"># ignore empty points</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                        <span class="k">continue</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>                    
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>                    <span class="c1"># filled point that we are searching around</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>                
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                    <span class="n">erase</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>                    <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_offset</span><span class="p">:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>                        <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>                        <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]):</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>                                <span class="n">erase</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># there is something present on the border - saved!</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>                                <span class="k">break</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># in case x_check, y_check are out of range</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                            <span class="k">pass</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                    <span class="k">if</span> <span class="n">erase</span><span class="p">:</span>  <span class="c1"># consider ellipse to be an anomaly</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                        <span class="c1"># erase entire inside of ellipse centred at w</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                        <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">:</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                            <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>                            <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                                <span class="n">beam_filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># erase</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>                                <span class="k">pass</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="k">return</span> <span class="n">beam_filtered_data</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>    <span class="c1"># ---- HELPER METHODS FOR PLOTTING ----</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__crop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fill_data</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">special_v</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">        Crop the data arrays to the smallest region containing all valid (non-NaN) data.</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        Parameters</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        ----------</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        x, y, v : DataArray1D</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">            Small coordinate arrays.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">            Data array to use for crop.</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">        crop_leeway : int or float, optional</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">            Fractional leeway to expand the crop region (default is 0).</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        fill_data : DataArray3D or None, optional</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">            Data array to use for filling values (default is None).</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">        Returns</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        -------</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">        cropped_x, cropped_y, cropped_v : DataArray1D</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">            Cropped coordinate arrays.</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        cropped_data : DataArray3D</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">            Cropped data array.</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">fill_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="n">fill_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>        
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="n">v_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="c1"># gets indices</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="n">v_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">v_max</span><span class="p">)</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">y_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_max</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="n">x_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_max</span><span class="p">)</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="c1"># turn into flat arrays</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="n">V_IDX</span><span class="p">,</span> <span class="n">Y_IDX</span><span class="p">,</span> <span class="n">X_IDX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">v_indices</span><span class="p">,</span> <span class="n">y_indices</span><span class="p">,</span> <span class="n">x_indices</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="c1"># filter out nan data</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="n">valid_V</span> <span class="o">=</span> <span class="n">V_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="n">valid_X</span> <span class="o">=</span> <span class="n">X_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="n">valid_Y</span> <span class="o">=</span> <span class="n">Y_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="c1"># indices to crop at</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="n">v_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_V</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_V</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>        <span class="n">v_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_V</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="n">v_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_V</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="k">if</span> <span class="n">special_v</span><span class="p">:</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v_hi</span><span class="p">],</span> <span class="s2">&quot;v should be increasing&quot;</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">:</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="c1"># get last time v &lt; -self.v_exp:</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                <span class="n">offsets</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">offsets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                    <span class="n">offsets</span><span class="p">[</span><span class="n">offsets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                    <span class="n">v_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="c1"># want greatest neg value</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>                    <span class="n">v_lo</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">v_hi</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">:</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>                <span class="n">offsets</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">)</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">offsets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>                    <span class="n">offsets</span><span class="p">[</span><span class="n">offsets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>                    <span class="n">v_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="c1"># want smallest pos value</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>                    <span class="n">v_hi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="n">x_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_X</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_X</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">x_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_X</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="n">x_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_X</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="n">y_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="n">y_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="n">y_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1"># crop x, y, v, data</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="n">cropped_data</span> <span class="o">=</span> <span class="n">fill_data</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>        <span class="n">cropped_v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span> <span class="n">v_hi</span><span class="p">]</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">cropped_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y_lo</span><span class="p">:</span> <span class="n">y_hi</span><span class="p">]</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">cropped_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x_lo</span><span class="p">:</span> <span class="n">x_hi</span><span class="p">]</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="k">return</span> <span class="n">cropped_x</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_data</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__filter_and_crop</span><span class="p">(</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="bp">self</span><span class="p">,</span> 
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>            <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">        Filter and crop data as specified.</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">        Parameters</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        ----------</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        filter_stds : float, int, or None</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">            Number of standard deviations to filter by, or None.</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">        filter_beam : bool</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">            If True, apply beam filtering.</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        crop_leeway : float</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">            Fractional leeway to expand the crop region.</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">        verbose : bool</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">            If True, print progress.</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        Returns</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        -------</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">        X, Y, V : DataArray3D</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">            Meshgrids of velocity space coordinates.</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        cropped_data : DataArray3D</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">            Cropped and filtered data array.</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering data (to crop)...&quot;</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="k">if</span> <span class="n">filter_beam</span><span class="p">:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying beam filter (to crop)...&quot;</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>        <span class="n">cropped_x</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crop_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="o">=</span><span class="n">crop_leeway</span><span class="p">,</span> <span class="n">special_v</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data cropped to shape </span><span class="si">{</span><span class="n">cropped_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="n">V</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_x</span><span class="p">,</span> <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">cropped_data</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>    
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__fast_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">x_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">y_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">z_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">        Interpolate the data onto a regular grid in (X, Y, Z) space.</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">        Parameters</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        ----------</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        points : tuple</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">            Tuple of (v, y, x) small coordinate arrays.</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">        x_bounds, y_bounds, z_bounds : tuple</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">            Bounds for the new grid in each dimension.</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">            Data array to interpolate, aligned with points.</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">            Velocity law function.</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">        num_points : int</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">            Number of points in each dimension for the new grid.</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        Returns</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">        -------</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">        X, Y, Z : DataArray1D</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">            Flattened meshgrids of new coordinates.</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">        interp_data : DataArray3D</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">            Interpolated data array.</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="c1"># points = (V, X, Y)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="c1"># new_shape = (data.shape[0] + 2, data.shape[1], data.shape[2])</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="c1"># new_data = np.full(new_shape, np.nan)</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="c1"># new_data[1:-1, :, :] = data.copy()  # padded on both sides with nan</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="c1"># # extend v array to have out-of-range values</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="c1"># v_array = points[0]</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>        <span class="c1"># delta_v = v_array[1] - v_array[0]</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="c1"># new_v_array = np.zeros(len(v_array) + 2)</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="c1"># new_v_array[1:-1] = v_array</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="c1"># new_v_array[0] = new_v_array[1] - delta_v</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="c1"># new_v_array[-1] = new_v_array[-2] + delta_v</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="c1"># new_points = (new_v_array, points[1], points[2])</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="c1"># get points to interpolate at</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="n">x_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="n">y_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="n">z_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_even</span><span class="p">,</span> <span class="n">y_even</span><span class="p">,</span> <span class="n">z_even</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="c1"># build velocities</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__to_velocity_space</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>        <span class="c1"># flatten arrays</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>  <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="n">V</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="n">interp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">V</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">interp_points</span><span class="p">)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">interp_data</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interp_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">interp_data</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>    <span class="c1"># ---- COORDINATE CHANGE ----</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__radius_from_vel_space_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">        Compute the physical radius corresponding to velocity-space coordinates (x, y, v)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">        using the provided velocity law.</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">        Parameters</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">        ----------</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">        x : ndarray</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">            Array of x-coordinates in AU.</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">        y : ndarray</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">            Array of y-coordinates in AU.</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">        v : ndarray</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">            Array of velocity coordinates in km/s.</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">        v_func : VelocityModel</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">            Callable velocity law, v_func(r), returning velocity in km/s for given radius in AU.</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">        Returns</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">        -------</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">        r : ndarray</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">            Array of radii in AU corresponding to the input (x, y, v) coordinates.</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">        Notes</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">        -----</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">        Solves for r in the equation:</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="sd">            r**2 * (1 - v**2 / v_func(r)**2) = x**2 + y**2</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">        for each (x, y, v) triplet.</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="c1">#</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Arrays x and y should have the same shape, instead </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Arrays x and v should have the same shape, instead </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">radius_eqn</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>            <span class="k">return</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">v_func</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="c1"># initial bracket guess</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">r_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># r must be greater than sqrt(x^2 + y^2)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="c1"># find bracket</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="n">bracket_result</span> <span class="o">=</span> <span class="n">bracket_root</span><span class="p">(</span><span class="n">radius_eqn</span><span class="p">,</span> <span class="n">r_lower</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">r_lower</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>        <span class="n">r_lower</span><span class="p">,</span> <span class="n">r_upper</span> <span class="o">=</span> <span class="n">bracket_result</span><span class="o">.</span><span class="n">bracket</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">find_root</span><span class="p">(</span><span class="n">radius_eqn</span><span class="p">,</span> <span class="p">(</span><span class="n">r_lower</span><span class="p">,</span> <span class="n">r_upper</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__to_velocity_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Z</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="sd">        Convert spatial coordinates to velocity space using the velocity law.</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">        Parameters</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">        ----------</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">        X, Y, Z : array_like</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">            Spatial coordinates.</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">            Velocity law function.</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">        Returns</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        -------</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">        V : array_like</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">            Velocity at each spatial coordinate.</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="c1"># build velocities</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="n">v_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="k">return</span> <span class="n">V</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>    <span class="c1"># ---- EXPANSION OVER TIME ----</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_new_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_radius</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">        Compute the new radius after a given time, using the velocity law.</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">        Parameters</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        ----------</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">        curr_radius : ndarray</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">            Initial radii in AU.</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">        years : float or int</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">            Time interval in years.</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">            Velocity law function, or None (uses constant velocity).</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        Returns</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">        -------</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">        new_rad : ndarray</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">            New radii after the specified time interval.</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">        Notes</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        -----</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">        Setting v_func = None speeds this up significantly, and is a close approximation.</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span>  <span class="c1"># t is the time in seconds</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="n">rad_km</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">,</span> <span class="n">curr_radius</span><span class="p">)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">rad_km</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">dr_dt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                <span class="c1"># need to convert r back to AU</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                <span class="n">vals</span> <span class="o">=</span> <span class="n">v_func</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                <span class="k">return</span> <span class="n">vals</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>            <span class="c1"># flatten</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">rad_km</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>            <span class="n">rad_km</span> <span class="o">=</span> <span class="n">rad_km</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="c1"># remove nans</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="n">nan_idxs</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rad_km</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dr_dt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rad_km</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rad_km</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="n">valid_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rad_km</span><span class="p">[</span><span class="o">~</span><span class="n">nan_idxs</span><span class="p">])</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>            <span class="n">rad_km</span><span class="p">[</span><span class="n">nan_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_rad</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>            <span class="c1"># solve</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>            <span class="n">solution</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">dr_dt</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="n">rad_km</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># r is evaluated at different time points</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="c1"># include nans and unflatten</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="n">new_rad</span><span class="p">[</span><span class="n">nan_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">new_rad</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="k">return</span> <span class="n">new_rad</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__time_expansion_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">        Transform coordinates and data to account for expansion over time.</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">        Parameters</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">        ----------</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">        x, y, v : DataArray1D</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">            Small coordinate arrays.</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">            Data array.</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">        years : float or int</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">            Time interval in years.</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">            Velocity law function.</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">        crop : bool, optional</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">            If True, crop to finite values (default is True).</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">        Returns</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">        -------</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">        new_X, new_Y, new_V : DataArray1D</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">            Transformed coordinate arrays (flattened meshgrid).</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">            Data array (possibly cropped). Remains unchanged if crop is False.</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">        points : tuple</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">            Tuple of original (v, y, x) arrays, cropped if crop is True.</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crop_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fill_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>        <span class="n">V</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">v_func_mod</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">v_func_mod</span> <span class="o">=</span> <span class="n">v_func</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        <span class="c1"># get R0 and R1 arrays</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="n">R0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__radius_from_vel_space_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">v_func_mod</span><span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_radius</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="n">R1</span><span class="p">[</span><span class="n">R1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># deal with neg radii</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="n">new_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">R1</span><span class="o">/</span><span class="n">R0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="n">new_Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="o">*</span><span class="n">R1</span><span class="o">/</span><span class="n">R0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">v_func</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span><span class="o">/</span><span class="n">v_func</span><span class="p">(</span><span class="n">R0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="n">finite_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_Y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_V</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="n">new_X</span> <span class="o">=</span> <span class="n">new_X</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="n">new_Y</span> <span class="o">=</span> <span class="n">new_Y</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="n">new_V</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="k">return</span> <span class="n">new_X</span><span class="p">,</span> <span class="n">new_Y</span><span class="p">,</span> <span class="n">new_V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_centre</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">        Compute the expanded data cube after a given time interval.</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">        - `years` (`float` or `int`): Time interval in years.</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`): Velocity law function or None (default is None, which uses constant expansion velocity).</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="sd">        - `remove_centre` (`float` or `int` or `None`, optional): If not None, remove all points within this many beam widths of the centre (default is 2).</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">        - `new_shape` (`tuple`, optional): Shape of the output grid (default is (50, 250, 250)).</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">        **Returns**</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">        - `info` (`CondensedData`): CondensedData object containing the expanded data and metadata.</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">        &quot;&quot;&quot;</span>     
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>        
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="n">use_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="k">if</span> <span class="n">remove_centre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing centre...&quot;</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="c1"># get centre coords</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>            <span class="c1"># proportion of the radius that the beam takes up</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>            <span class="n">beam_rad_au</span> <span class="o">=</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>            <span class="n">beam_prop</span> <span class="o">=</span> <span class="n">beam_rad_au</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>            <span class="n">v_axis_removal</span> <span class="o">=</span> <span class="n">remove_centre</span><span class="o">*</span><span class="n">beam_prop</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="n">v_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="n">relevant_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="n">proportions</span> <span class="o">=</span> <span class="n">remove_centre</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">relevant_vs</span><span class="o">/</span><span class="n">v_axis_removal</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>            
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="c1"># removing centre</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_idxs</span><span class="p">)):</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="n">v_idx</span> <span class="o">=</span> <span class="n">v_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>                <span class="n">prop</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_beam</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>                <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="n">beam</span><span class="p">:</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>                    <span class="n">use_data</span><span class="p">[</span><span class="n">v_idx</span><span class="p">][</span><span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming coordinates...&quot;</span><span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="n">v_num</span><span class="p">,</span> <span class="n">y_num</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">new_shape</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating grid for new object...&quot;</span><span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="n">gridv</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">v_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> 
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">y_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">x_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="p">]</span> 
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="c1"># get preimage of grid</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="n">small_gridx</span> <span class="o">=</span> <span class="n">gridx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="n">small_gridy</span> <span class="o">=</span> <span class="n">gridy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">small_gridv</span> <span class="o">=</span> <span class="n">gridv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="c1"># go backwards with negative years</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shrinking grid to original data bounds...&quot;</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">prev_X</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_V</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="n">small_gridx</span><span class="p">,</span> <span class="n">small_gridy</span><span class="p">,</span> <span class="n">small_gridv</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span>  <span class="o">-</span><span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>        
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>                <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>                <span class="p">(</span><span class="n">prev_X</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_X</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_V</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_Y</span><span class="p">)</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="n">prev_V</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>        <span class="n">prev_X</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="n">prev_Y</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="c1"># interpolate regular data at these points</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating...&quot;</span><span class="p">)</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="n">interp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">prev_V</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_X</span><span class="p">))</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">interp_points</span><span class="p">)</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="n">interp_data</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>        <span class="n">new_data</span> <span class="o">=</span> <span class="n">interp_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gridx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="n">non_nans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_data</span><span class="p">)])</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">non_nans</span><span class="si">}</span><span class="s2"> non-nan values remaining out of </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>            <span class="n">small_gridx</span><span class="p">,</span> 
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="n">small_gridy</span><span class="p">,</span> 
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="n">small_gridv</span><span class="p">,</span> 
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>            <span class="n">new_data</span><span class="p">,</span> 
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span> 
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span> 
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span> 
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> 
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> 
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> 
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="p">)</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time expansion process complete!&quot;</span><span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="k">return</span> <span class="n">info</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="c1"># ---- PLOTTING ----</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_velocity_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">        Plot velocity vs. intensity at the center of the xy plane.</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">        - `fit_parabola` (`bool`, optional): If True, fit and plot a parabola (default is True).</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="sd">        **Notes**</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">        The well-fittedness of the parabola can help you visually determine </span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">        the accuracy of the calculated systemic and expansion velocity.</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_star_and_exp_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="o">=</span><span class="n">fit_parabola</span><span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">        Plot radius vs. intensity at the center of the xy plane.</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_intensities</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_beta_law</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="sd">        Plot radius vs. velocity at the center of the xy plane.</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="sd">        - `fit_beta_law` (`bool`, optional): If True, fit and plot the beta law (default is True).</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">        **Notes**</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="sd">        The well-fittedness of the beta law curve can help you visually determine </span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a><span class="sd">        the accuracy of the calculated beta law parameters.</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_beta_law</span><span class="o">=</span><span class="n">fit_beta_law</span><span class="p">)</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_channel_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="n">dimensions</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="n">end</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="n">include_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>        <span class="n">text_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>        <span class="n">beam_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">        Plot the data cube as a set of 2D channel maps.</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">        - `dimensions` (`tuple` of `int` or `None`, optional): Grid dimensions (nrows, ncols) for subplots (default is None).</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">        - `start` (`int`, optional): Starting velocity channel index (default is 0).</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">        - `end` (`int` or `None`, optional): Ending velocity channel index (default is None).</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="sd">        - `include_beam` (`bool`, optional): If True, plot the beam ellipse (default is True).</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        - `text_pos` (`tuple` of `float` or `None`, optional): Position for velocity text annotation (default is None).</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">        - `beam_pos` (`tuple` of `float` or `None`, optional): Position for beam ellipse (default is None).</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the name of the star).</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">        - `cmap` (`str`, optional): Colormap for the plot (default is &quot;viridis&quot;). See https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="k">if</span> <span class="n">filter_beam</span><span class="p">:</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the start of the data</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">+</span> <span class="s2">&quot; channel maps&quot;</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">dimensions</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)))</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nrows</span><span class="p">))</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>        <span class="n">viridis</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">]</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Right Ascension (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Declination (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">start</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="n">extents</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">)</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]),</span> <span class="n">extent</span><span class="o">=</span><span class="n">extents</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">viridis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>                <span class="k">if</span> <span class="n">text_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>                <span class="k">if</span> <span class="n">include_beam</span><span class="p">:</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>                    <span class="n">bmaj</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">)</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>                    <span class="n">bmin</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>                    <span class="n">bpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>                    <span class="k">if</span> <span class="n">beam_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ellipse_artist</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">):</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux Density (Jy/Beam)&quot;</span><span class="p">)</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial_crop</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a><span class="sd">        Launch an interactive mask creator for the data cube.</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to initially filter by (default is None).</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="sd">        - `savefile` (`str` or `None`, optional): Filename to save the selected mask (default is None). Should end in .npy.</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a><span class="sd">        - `initial_crop` (`tuple` or `None`, optional): Initial crop region as (v_lo, v_hi, y_lo, y_hi, x_lo, x_hi), using channel indices (default is None).</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="k">if</span> <span class="n">initial_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">v_lo</span><span class="p">,</span> <span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">initial_crop</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="n">new_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>        
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>            <span class="c1"># mask is complete now</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>        
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>        <span class="c1"># save mask</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_3D</span><span class="p">(</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>        <span class="bp">self</span><span class="p">,</span> 
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="n">z_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>        <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>        <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>        <span class="n">num_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>        <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>        <span class="n">opacityscale</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>        <span class="n">colorscale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>        <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>        <span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>        <span class="n">camera_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="sd">        Plot a 3D volume rendering of the data cube using Plotly.</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">        **Parameters**</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a><span class="sd">        - `z_cutoff` (`float` or `None`, optional): Cutoff for z values as a proportion of the largest x, y values (default is 1).</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a><span class="sd">        - `crop_leeway` (`int` or `float`, optional): Fractional leeway to expand the crop region (default is 0).</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="sd">        - `num_points` (`int`, optional): Number of points in each dimension for the grid (default is 50).</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a><span class="sd">        - `num_surfaces` (`int`, optional): Number of surfaces to draw when rendering the plot (default is 50).</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="sd">        - `opacity` (`float` or `int`, optional): Opacity of the volume rendering (default is 0.5).</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="sd">        - `opacityscale` (`list` of `list` of `float`, optional): Opacity scale, see https://plotly.com/python-api-reference/generated/plotly.graph_objects.Volume.html (default is [[0, 0], [1, 1]]).</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">        - `colorscale` (`str`, optional): Colormap for the plot, see https://plotly.com/python/builtin-colorscales/ (default is &quot;Reds&quot;).</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`, optional): Velocity law function (default is None, which uses constant expansion velocity).</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the star name).</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">        - `folder` (`str` or `None`, optional): If provided, generates successive frames and saves as png files to this folder (default is None).</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">        - `num_angles` (`int`, optional): Number of angles for saving images (default is 24). Greater values give smoother animation.</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="sd">        - `camera_dist` (`float` or `int`, optional): Camera radius to use if generating frames (default is 2).</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial filter and crop...&quot;</span><span class="p">)</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_and_crop</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">,</span> <span class="n">filter_beam</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>        
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>        <span class="c1"># get small 1d arrays</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>        <span class="n">x_small</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="n">y_small</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="n">v_small</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>        <span class="c1"># interpolate to grid</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating to grid...&quot;</span><span class="p">)</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        <span class="n">z_bound</span> <span class="o">=</span> <span class="n">z_cutoff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_small</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_small</span><span class="p">)))</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>        
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>        <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="o">-</span><span class="n">z_bound</span><span class="p">,</span> <span class="n">z_bound</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="n">gridx</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridz</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fast_interpolation</span><span class="p">((</span><span class="n">v_small</span><span class="p">,</span> <span class="n">y_small</span><span class="p">,</span> <span class="n">x_small</span><span class="p">),</span> <span class="p">(</span><span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="c1"># filter by standard deviation</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">out</span> <span class="o">&lt;</span> <span class="n">filter_stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Plotly cant deal with nans</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> non-nan points.&quot;</span><span class="p">)</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting figure...&quot;</span><span class="p">)</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>        
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">gridx</span><span class="p">,</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">gridy</span><span class="p">,</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>                <span class="n">z</span><span class="o">=</span><span class="n">gridz</span><span class="p">,</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>                <span class="n">value</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>                <span class="n">isomin</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">,</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>                <span class="n">colorscale</span><span class="o">=</span> <span class="n">colorscale</span><span class="p">,</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>                <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Flux Density (Jy/beam)&quot;</span><span class="p">),</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>                <span class="n">opacityscale</span><span class="o">=</span><span class="n">opacityscale</span><span class="p">,</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span> <span class="c1"># needs to be small to see through all surfaces</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="n">surface_count</span><span class="o">=</span><span class="n">num_surfaces</span><span class="p">,</span> <span class="c1"># needs to be a large number for good volume rendering</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>            <span class="p">),</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>            <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>                    <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="n">title</span><span class="p">,</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>                    <span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>                    <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="mf">0.95</span><span class="p">,</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>                    <span class="s2">&quot;font&quot;</span><span class="p">:{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">}</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                <span class="p">},</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>                <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>                      <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;X (AU)&#39;</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>                          <span class="p">)</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>                      <span class="p">),</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>                      <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Y (AU)&#39;</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>                          <span class="p">)</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>                      <span class="p">),</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>                      <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Z (AU)&#39;</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>                          <span class="p">)</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>                      <span class="p">),</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>                      <span class="n">aspectmode</span> <span class="o">=</span> <span class="s2">&quot;cube&quot;</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>                    <span class="p">),</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>            <span class="p">)</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>        <span class="p">)</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating frames...&quot;</span><span class="p">)</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="n">num_angles</span><span class="p">)</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>                <span class="n">eye</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">z</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera_eye</span> <span class="o">=</span> <span class="n">eye</span><span class="p">)</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>                <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/angle</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating frames: </span><span class="si">{</span><span class="n">a</span><span class="o">/</span><span class="mi">360</span><span class="si">}</span><span class="s2">% complete.&quot;</span><span class="p">)</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>                
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a><span class="k">class</span><span class="w"> </span><span class="nc">_PointsSelector</span><span class="p">:</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a><span class="sd">    Interactive tool for selecting and masking points in a 3D data cube using matplotlib.</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">):</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a><span class="sd">        Initialize the _PointsSelector with a data cube.</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a><span class="sd">        Parameters</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a><span class="sd">        ----------</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a><span class="sd">            3D data array to select points from.</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ceiling of square root</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>        <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span><span class="p">:</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>  <span class="c1"># turn off unnecessary axes</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span><span class="p">]</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>        <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AxesImage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span>  <span class="c1"># type: ignore</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)])</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)])</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_plots</span><span class="p">):</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span> <span class="n">lower</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">upper</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">awaiting_keypress</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Double click on a subplot to start lassoing points.&quot;</span><span class="p">)</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onclick</span><span class="p">)</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">&quot;key_press_event&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_press</span><span class="p">)</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">onclick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">MouseEvent</span><span class="p">):</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a><span class="sd">        Handle double-click events on subplots to start lasso selection.</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a><span class="sd">        Parameters</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a><span class="sd">        ----------</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a><span class="sd">        event : MouseEvent</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a><span class="sd">            Matplotlib mouse event.</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">dblclick</span><span class="p">:</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>                <span class="k">return</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axs</span><span class="p">)):</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">create_lasso</span><span class="p">()</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>                        <span class="k">return</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">key_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a><span class="sd">        Handle key press events after lasso selection.</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a><span class="sd">        Parameters</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a><span class="sd">        ----------</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a><span class="sd">        event : KeyEvent</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a><span class="sd">            Matplotlib key event.</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">awaiting_keypress</span><span class="p">:</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">awaiting_keypress</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">unmask_selection</span><span class="p">()</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_selection</span><span class="p">()</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">onselect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verts</span><span class="p">):</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a><span class="sd">        Callback for when the lasso selection is completed.</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">        Parameters</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">        ----------</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a><span class="sd">        verts : list of tuple</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">            Vertices of the lasso path.</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>        
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xys</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xys</span><span class="p">)]</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>        <span class="k">for</span> <span class="n">idx_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind</span><span class="p">:</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">idx_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>        <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">0.2</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="n">alpha</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Press R to mask points, A to mask all other points, any other key to escape.&quot;</span><span class="p">)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">awaiting_keypress</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_lasso</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">        Start the lasso selector on the currently active subplot.</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Selecting points...&quot;</span><span class="p">)</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span> <span class="o">=</span> <span class="n">LassoSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">onselect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onselect</span><span class="p">)</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mask_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a><span class="sd">        Mask (set to NaN) the selected points in the current subplot.</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">unmask_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a><span class="sd">        Mask (set to NaN) all points except the selected points in the current subplot.</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_mask</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>        
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">        Disconnect the lasso selector and reset the subplot state.</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lasso</span><span class="o">.</span><span class="n">disconnect_events</span><span class="p">()</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Double click on a subplot to start lassoing points.&quot;</span><span class="p">)</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="DataArray1D">
                    <div class="attr variable">
            <span class="name">DataArray1D</span>        =
<span class="default_value">numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#DataArray1D"></a>
    
    

                </section>
                <section id="DataArray3D">
                    <div class="attr variable">
            <span class="name">DataArray3D</span>        =
<span class="default_value">numpy.ndarray[tuple[int, int, int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#DataArray3D"></a>
    
    

                </section>
                <section id="Matrix2x2">
                    <div class="attr variable">
            <span class="name">Matrix2x2</span>        =
<span class="default_value">numpy.ndarray[tuple[typing.Literal[2], typing.Literal[2]], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#Matrix2x2"></a>
    
    

                </section>
                <section id="VelocityModel">
                    <div class="attr variable">
            <span class="name">VelocityModel</span>        =
<span class="default_value">collections.abc.Callable[[numpy.ndarray], numpy.ndarray]</span>

        
    </div>
    <a class="headerlink" href="#VelocityModel"></a>
    
    

                </section>
                <section id="FITSHeaderError">
                            <input id="FITSHeaderError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FITSHeaderError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="FITSHeaderError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FITSHeaderError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FITSHeaderError-40"><a href="#FITSHeaderError-40"><span class="linenos">40</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FITSHeaderError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="FITSHeaderError-41"><a href="#FITSHeaderError-41"><span class="linenos">41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FITSHeaderError-42"><a href="#FITSHeaderError-42"><span class="linenos">42</span></a><span class="sd">    Raised when the FITS file header is missing necessary information, or storing it as the wrong type.</span>
</span><span id="FITSHeaderError-43"><a href="#FITSHeaderError-43"><span class="linenos">43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FITSHeaderError-44"><a href="#FITSHeaderError-44"><span class="linenos">44</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Raised when the FITS file header is missing necessary information, or storing it as the wrong type.</p>
</div>


                </section>
                <section id="CondensedData">
                            <input id="CondensedData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">CondensedData</span>:

                <label class="view-source-button" for="CondensedData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CondensedData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CondensedData-46"><a href="#CondensedData-46"><span class="linenos">46</span></a><span class="nd">@dataclass</span>
</span><span id="CondensedData-47"><a href="#CondensedData-47"><span class="linenos">47</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CondensedData</span><span class="p">:</span>
</span><span id="CondensedData-48"><a href="#CondensedData-48"><span class="linenos">48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CondensedData-49"><a href="#CondensedData-49"><span class="linenos">49</span></a><span class="sd">    Container for storing a condensed version of the data cube and its associated metadata.</span>
</span><span id="CondensedData-50"><a href="#CondensedData-50"><span class="linenos">50</span></a>
</span><span id="CondensedData-51"><a href="#CondensedData-51"><span class="linenos">51</span></a><span class="sd">    **Attributes**</span>
</span><span id="CondensedData-52"><a href="#CondensedData-52"><span class="linenos">52</span></a>
</span><span id="CondensedData-53"><a href="#CondensedData-53"><span class="linenos">53</span></a><span class="sd">    - `x_offsets` (`DataArray1D`): 1D array of x-coordinates (offsets) in AU.</span>
</span><span id="CondensedData-54"><a href="#CondensedData-54"><span class="linenos">54</span></a><span class="sd">    - `y_offsets` (`DataArray1D`): 1D array of y-coordinates (offsets) in AU.</span>
</span><span id="CondensedData-55"><a href="#CondensedData-55"><span class="linenos">55</span></a><span class="sd">    - `v_offsets` (`DataArray1D`): 1D array of velocity offsets in km/s.</span>
</span><span id="CondensedData-56"><a href="#CondensedData-56"><span class="linenos">56</span></a><span class="sd">    - `data` (`DataArray3D`): 3D data array (velocity, y, x) containing the intensity values.</span>
</span><span id="CondensedData-57"><a href="#CondensedData-57"><span class="linenos">57</span></a><span class="sd">    - `star_name` (`str`): Name of the star or object.</span>
</span><span id="CondensedData-58"><a href="#CondensedData-58"><span class="linenos">58</span></a><span class="sd">    - `distance_to_star` (`float`): Distance to the star in AU.</span>
</span><span id="CondensedData-59"><a href="#CondensedData-59"><span class="linenos">59</span></a><span class="sd">    - `v_exp` (`float`): Expansion velocity in km/s.</span>
</span><span id="CondensedData-60"><a href="#CondensedData-60"><span class="linenos">60</span></a><span class="sd">    - `v_sys` (`float`): Systemic velocity in km/s.</span>
</span><span id="CondensedData-61"><a href="#CondensedData-61"><span class="linenos">61</span></a><span class="sd">    - `beta` (`float`): Beta parameter of the velocity law.</span>
</span><span id="CondensedData-62"><a href="#CondensedData-62"><span class="linenos">62</span></a><span class="sd">    - `r_dust` (`float`): Dust formation radius in AU.</span>
</span><span id="CondensedData-63"><a href="#CondensedData-63"><span class="linenos">63</span></a><span class="sd">    - `beam_maj` (`float`): Major axis of the beam in degrees.</span>
</span><span id="CondensedData-64"><a href="#CondensedData-64"><span class="linenos">64</span></a><span class="sd">    - `beam_min` (`float`): Minor axis of the beam in degrees.</span>
</span><span id="CondensedData-65"><a href="#CondensedData-65"><span class="linenos">65</span></a><span class="sd">    - `beam_angle` (`float`): Beam position angle in degrees.</span>
</span><span id="CondensedData-66"><a href="#CondensedData-66"><span class="linenos">66</span></a><span class="sd">    - `header` (`Header`): FITS header containing metadata.</span>
</span><span id="CondensedData-67"><a href="#CondensedData-67"><span class="linenos">67</span></a><span class="sd">    - `mean` (`float` or `None`, optional): Mean intensity of the data (default is None).</span>
</span><span id="CondensedData-68"><a href="#CondensedData-68"><span class="linenos">68</span></a><span class="sd">    - `std` (`float` or `None`, optional): Standard deviation of the data (default is None).</span>
</span><span id="CondensedData-69"><a href="#CondensedData-69"><span class="linenos">69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CondensedData-70"><a href="#CondensedData-70"><span class="linenos">70</span></a>    <span class="n">x_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="CondensedData-71"><a href="#CondensedData-71"><span class="linenos">71</span></a>    <span class="n">y_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="CondensedData-72"><a href="#CondensedData-72"><span class="linenos">72</span></a>    <span class="n">v_offsets</span><span class="p">:</span> <span class="n">DataArray1D</span>
</span><span id="CondensedData-73"><a href="#CondensedData-73"><span class="linenos">73</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span>
</span><span id="CondensedData-74"><a href="#CondensedData-74"><span class="linenos">74</span></a>    <span class="n">star_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="CondensedData-75"><a href="#CondensedData-75"><span class="linenos">75</span></a>    <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-76"><a href="#CondensedData-76"><span class="linenos">76</span></a>    <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-77"><a href="#CondensedData-77"><span class="linenos">77</span></a>    <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-78"><a href="#CondensedData-78"><span class="linenos">78</span></a>    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-79"><a href="#CondensedData-79"><span class="linenos">79</span></a>    <span class="n">r_dust</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-80"><a href="#CondensedData-80"><span class="linenos">80</span></a>    <span class="n">beam_maj</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-81"><a href="#CondensedData-81"><span class="linenos">81</span></a>    <span class="n">beam_min</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-82"><a href="#CondensedData-82"><span class="linenos">82</span></a>    <span class="n">beam_angle</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="CondensedData-83"><a href="#CondensedData-83"><span class="linenos">83</span></a>    <span class="n">header</span><span class="p">:</span> <span class="n">Header</span>
</span><span id="CondensedData-84"><a href="#CondensedData-84"><span class="linenos">84</span></a>    <span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CondensedData-85"><a href="#CondensedData-85"><span class="linenos">85</span></a>    <span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Container for storing a condensed version of the data cube and its associated metadata.</p>

<p><strong>Attributes</strong></p>

<ul>
<li><code><a href="#CondensedData.x_offsets">x_offsets</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of x-coordinates (offsets) in AU.</li>
<li><code><a href="#CondensedData.y_offsets">y_offsets</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of y-coordinates (offsets) in AU.</li>
<li><code><a href="#CondensedData.v_offsets">v_offsets</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of velocity offsets in km/s.</li>
<li><code><a href="#CondensedData.data">data</a></code> (<code><a href="#DataArray3D">DataArray3D</a></code>): 3D data array (velocity, y, x) containing the intensity values.</li>
<li><code><a href="#CondensedData.star_name">star_name</a></code> (<code>str</code>): Name of the star or object.</li>
<li><code><a href="#CondensedData.distance_to_star">distance_to_star</a></code> (<code>float</code>): Distance to the star in AU.</li>
<li><code><a href="#CondensedData.v_exp">v_exp</a></code> (<code>float</code>): Expansion velocity in km/s.</li>
<li><code><a href="#CondensedData.v_sys">v_sys</a></code> (<code>float</code>): Systemic velocity in km/s.</li>
<li><code><a href="#CondensedData.beta">beta</a></code> (<code>float</code>): Beta parameter of the velocity law.</li>
<li><code><a href="#CondensedData.r_dust">r_dust</a></code> (<code>float</code>): Dust formation radius in AU.</li>
<li><code><a href="#CondensedData.beam_maj">beam_maj</a></code> (<code>float</code>): Major axis of the beam in degrees.</li>
<li><code><a href="#CondensedData.beam_min">beam_min</a></code> (<code>float</code>): Minor axis of the beam in degrees.</li>
<li><code><a href="#CondensedData.beam_angle">beam_angle</a></code> (<code>float</code>): Beam position angle in degrees.</li>
<li><code><a href="#CondensedData.header">header</a></code> (<code>Header</code>): FITS header containing metadata.</li>
<li><code><a href="#CondensedData.mean">mean</a></code> (<code>float</code> or <code>None</code>, optional): Mean intensity of the data (default is None).</li>
<li><code><a href="#CondensedData.std">std</a></code> (<code>float</code> or <code>None</code>, optional): Standard deviation of the data (default is None).</li>
</ul>
</div>


                            <div id="CondensedData.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">CondensedData</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">x_offsets</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>,</span><span class="param">	<span class="n">y_offsets</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>,</span><span class="param">	<span class="n">v_offsets</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>,</span><span class="param">	<span class="n">star_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">beta</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">r_dust</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">beam_maj</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">beam_min</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">beam_angle</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">header</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span>,</span><span class="param">	<span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.__init__"></a>
    
    

                            </div>
                            <div id="CondensedData.x_offsets" class="classattr">
                                <div class="attr variable">
            <span class="name">x_offsets</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.x_offsets"></a>
    
    

                            </div>
                            <div id="CondensedData.y_offsets" class="classattr">
                                <div class="attr variable">
            <span class="name">y_offsets</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.y_offsets"></a>
    
    

                            </div>
                            <div id="CondensedData.v_offsets" class="classattr">
                                <div class="attr variable">
            <span class="name">v_offsets</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.v_offsets"></a>
    
    

                            </div>
                            <div id="CondensedData.data" class="classattr">
                                <div class="attr variable">
            <span class="name">data</span><span class="annotation">: numpy.ndarray[tuple[int, int, int], numpy.dtype[numpy.float64]]</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.data"></a>
    
    

                            </div>
                            <div id="CondensedData.star_name" class="classattr">
                                <div class="attr variable">
            <span class="name">star_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.star_name"></a>
    
    

                            </div>
                            <div id="CondensedData.distance_to_star" class="classattr">
                                <div class="attr variable">
            <span class="name">distance_to_star</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.distance_to_star"></a>
    
    

                            </div>
                            <div id="CondensedData.v_exp" class="classattr">
                                <div class="attr variable">
            <span class="name">v_exp</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.v_exp"></a>
    
    

                            </div>
                            <div id="CondensedData.v_sys" class="classattr">
                                <div class="attr variable">
            <span class="name">v_sys</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.v_sys"></a>
    
    

                            </div>
                            <div id="CondensedData.beta" class="classattr">
                                <div class="attr variable">
            <span class="name">beta</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.beta"></a>
    
    

                            </div>
                            <div id="CondensedData.r_dust" class="classattr">
                                <div class="attr variable">
            <span class="name">r_dust</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.r_dust"></a>
    
    

                            </div>
                            <div id="CondensedData.beam_maj" class="classattr">
                                <div class="attr variable">
            <span class="name">beam_maj</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.beam_maj"></a>
    
    

                            </div>
                            <div id="CondensedData.beam_min" class="classattr">
                                <div class="attr variable">
            <span class="name">beam_min</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.beam_min"></a>
    
    

                            </div>
                            <div id="CondensedData.beam_angle" class="classattr">
                                <div class="attr variable">
            <span class="name">beam_angle</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.beam_angle"></a>
    
    

                            </div>
                            <div id="CondensedData.header" class="classattr">
                                <div class="attr variable">
            <span class="name">header</span><span class="annotation">: astropy.io.fits.header.Header</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.header"></a>
    
    

                            </div>
                            <div id="CondensedData.mean" class="classattr">
                                <div class="attr variable">
            <span class="name">mean</span><span class="annotation">: float | None</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.mean"></a>
    
    

                            </div>
                            <div id="CondensedData.std" class="classattr">
                                <div class="attr variable">
            <span class="name">std</span><span class="annotation">: float | None</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#CondensedData.std"></a>
    
    

                            </div>
                </section>
                <section id="StarData">
                            <input id="StarData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StarData</span>:

                <label class="view-source-button" for="StarData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData-88"><a href="#StarData-88"><span class="linenos">  88</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StarData</span><span class="p">:</span>
</span><span id="StarData-89"><a href="#StarData-89"><span class="linenos">  89</span></a>
</span><span id="StarData-90"><a href="#StarData-90"><span class="linenos">  90</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-91"><a href="#StarData-91"><span class="linenos">  91</span></a><span class="sd">    Class for manipulating and analyzing astronomical data cubes of radially expanding circumstellar envelopes.</span>
</span><span id="StarData-92"><a href="#StarData-92"><span class="linenos">  92</span></a>
</span><span id="StarData-93"><a href="#StarData-93"><span class="linenos">  93</span></a><span class="sd">    The StarData class provides a comprehensive interface for loading, processing, analyzing, and visualizing</span>
</span><span id="StarData-94"><a href="#StarData-94"><span class="linenos">  94</span></a><span class="sd">    3D data cubes (typically from FITS files) representing the emission from expanding circumstellar shells.</span>
</span><span id="StarData-95"><a href="#StarData-95"><span class="linenos">  95</span></a><span class="sd">    It supports both direct loading from FITS files and from preprocessed CondensedData objects, and manages</span>
</span><span id="StarData-96"><a href="#StarData-96"><span class="linenos">  96</span></a><span class="sd">    all relevant metadata and derived quantities.</span>
</span><span id="StarData-97"><a href="#StarData-97"><span class="linenos">  97</span></a>
</span><span id="StarData-98"><a href="#StarData-98"><span class="linenos">  98</span></a><span class="sd">    Key Features</span>
</span><span id="StarData-99"><a href="#StarData-99"><span class="linenos">  99</span></a><span class="sd">    ------------</span>
</span><span id="StarData-100"><a href="#StarData-100"><span class="linenos"> 100</span></a><span class="sd">    - **Data Loading:** Supports initialization from FITS files or CondensedData objects.</span>
</span><span id="StarData-101"><a href="#StarData-101"><span class="linenos"> 101</span></a><span class="sd">    - **Metadata Management:** Stores and exposes all relevant observational and physical parameters, including</span>
</span><span id="StarData-102"><a href="#StarData-102"><span class="linenos"> 102</span></a><span class="sd">      beam properties, systemic and expansion velocities, beta velocity law parameters, and FITS header information.</span>
</span><span id="StarData-103"><a href="#StarData-103"><span class="linenos"> 103</span></a><span class="sd">    - **Noise Estimation:** Automatically computes mean and standard deviation of background noise for filtering.</span>
</span><span id="StarData-104"><a href="#StarData-104"><span class="linenos"> 104</span></a><span class="sd">    - **Filtering:** Provides methods to filter data by significance (standard deviations) and to remove small clumps</span>
</span><span id="StarData-105"><a href="#StarData-105"><span class="linenos"> 105</span></a><span class="sd">      of points that fit within the beam (beam filtering).</span>
</span><span id="StarData-106"><a href="#StarData-106"><span class="linenos"> 106</span></a><span class="sd">    - **Coordinate Transformations:** Handles conversion between velocity space and spatial (cartesian) coordinates,</span>
</span><span id="StarData-107"><a href="#StarData-107"><span class="linenos"> 107</span></a><span class="sd">      supporting both constant velocity models and general velocity laws.</span>
</span><span id="StarData-108"><a href="#StarData-108"><span class="linenos"> 108</span></a><span class="sd">    - **Time Evolution:** Can compute the expansion of the envelope over time, transforming the data cube accordingly.</span>
</span><span id="StarData-109"><a href="#StarData-109"><span class="linenos"> 109</span></a><span class="sd">    - **Visualization:** Includes a variety of plotting methods:</span>
</span><span id="StarData-110"><a href="#StarData-110"><span class="linenos"> 110</span></a><span class="sd">        - Channel maps (2D slices through velocity channels)</span>
</span><span id="StarData-111"><a href="#StarData-111"><span class="linenos"> 111</span></a><span class="sd">        - 3D volume rendering (with Plotly)</span>
</span><span id="StarData-112"><a href="#StarData-112"><span class="linenos"> 112</span></a><span class="sd">        - Diagnostic plots for velocity/intensity and radius/velocity relationships</span>
</span><span id="StarData-113"><a href="#StarData-113"><span class="linenos"> 113</span></a><span class="sd">    - **Interactive Masking:** Supports interactive creation of masks for manual data cleaning.</span>
</span><span id="StarData-114"><a href="#StarData-114"><span class="linenos"> 114</span></a>
</span><span id="StarData-115"><a href="#StarData-115"><span class="linenos"> 115</span></a><span class="sd">    Attributes</span>
</span><span id="StarData-116"><a href="#StarData-116"><span class="linenos"> 116</span></a><span class="sd">    ------------</span>
</span><span id="StarData-117"><a href="#StarData-117"><span class="linenos"> 117</span></a>
</span><span id="StarData-118"><a href="#StarData-118"><span class="linenos"> 118</span></a><span class="sd">    - `data` (`DataArray3D`): The main data cube (v, y, x) containing intensity values.</span>
</span><span id="StarData-119"><a href="#StarData-119"><span class="linenos"> 119</span></a><span class="sd">    - `X` (`DataArray1D`): 1D array of x-coordinates (offsets) in AU.</span>
</span><span id="StarData-120"><a href="#StarData-120"><span class="linenos"> 120</span></a><span class="sd">    - `Y` (`DataArray1D`): 1D array of y-coordinates (offsets) in AU.</span>
</span><span id="StarData-121"><a href="#StarData-121"><span class="linenos"> 121</span></a><span class="sd">    - `V` (`DataArray1D`): 1D array of velocity offsets in km/s.</span>
</span><span id="StarData-122"><a href="#StarData-122"><span class="linenos"> 122</span></a><span class="sd">    - `distance_to_star` (`float`): Distance to the star in AU.</span>
</span><span id="StarData-123"><a href="#StarData-123"><span class="linenos"> 123</span></a><span class="sd">    - `beam_maj` (`float`): Major axis of the beam in degrees.</span>
</span><span id="StarData-124"><a href="#StarData-124"><span class="linenos"> 124</span></a><span class="sd">    - `beam_min` (`float`): Minor axis of the beam in degrees.</span>
</span><span id="StarData-125"><a href="#StarData-125"><span class="linenos"> 125</span></a><span class="sd">    - `beam_angle` (`float`): Beam position angle in degrees.</span>
</span><span id="StarData-126"><a href="#StarData-126"><span class="linenos"> 126</span></a><span class="sd">    - `mean` (`float`): Mean intensity of the background noise.</span>
</span><span id="StarData-127"><a href="#StarData-127"><span class="linenos"> 127</span></a><span class="sd">    - `std` (`float`): Standard deviation of the background noise.</span>
</span><span id="StarData-128"><a href="#StarData-128"><span class="linenos"> 128</span></a><span class="sd">    - `v_sys` (`float`): Systemic velocity in km/s.</span>
</span><span id="StarData-129"><a href="#StarData-129"><span class="linenos"> 129</span></a><span class="sd">    - `v_exp` (`float`): Expansion velocity in km/s.</span>
</span><span id="StarData-130"><a href="#StarData-130"><span class="linenos"> 130</span></a><span class="sd">    - `beta` (`float`): Beta parameter of the velocity law.</span>
</span><span id="StarData-131"><a href="#StarData-131"><span class="linenos"> 131</span></a><span class="sd">    - `r_dust` (`float`): Dust formation radius in AU.</span>
</span><span id="StarData-132"><a href="#StarData-132"><span class="linenos"> 132</span></a><span class="sd">    - `radius` (`float`): Characteristic radius (e.g., maximum intensity change) in AU.</span>
</span><span id="StarData-133"><a href="#StarData-133"><span class="linenos"> 133</span></a><span class="sd">    - `beta_velocity_law` (`VelocityModel`): Callable implementing the beta velocity law with the current object&#39;s parameters.</span>
</span><span id="StarData-134"><a href="#StarData-134"><span class="linenos"> 134</span></a><span class="sd">    - `star_name` (`str`): Name of the star or object.</span>
</span><span id="StarData-135"><a href="#StarData-135"><span class="linenos"> 135</span></a>
</span><span id="StarData-136"><a href="#StarData-136"><span class="linenos"> 136</span></a><span class="sd">    Methods</span>
</span><span id="StarData-137"><a href="#StarData-137"><span class="linenos"> 137</span></a><span class="sd">    -------</span>
</span><span id="StarData-138"><a href="#StarData-138"><span class="linenos"> 138</span></a><span class="sd">    - `export() -&gt; CondensedData`: Export all defining attributes to a CondensedData object.</span>
</span><span id="StarData-139"><a href="#StarData-139"><span class="linenos"> 139</span></a><span class="sd">    - `get_filtered_data(stds=5)`: Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</span>
</span><span id="StarData-140"><a href="#StarData-140"><span class="linenos"> 140</span></a><span class="sd">    - `beam_filter(filtered_data)`: Remove clumps of points that fit inside the beam, setting these values to np.nan.</span>
</span><span id="StarData-141"><a href="#StarData-141"><span class="linenos"> 141</span></a><span class="sd">    - `get_expansion(years, v_func, ...)`: Compute the expanded data cube after a given time interval.</span>
</span><span id="StarData-142"><a href="#StarData-142"><span class="linenos"> 142</span></a><span class="sd">    - `plot_channel_maps(...)`: Plot the data cube as a set of 2D channel maps.</span>
</span><span id="StarData-143"><a href="#StarData-143"><span class="linenos"> 143</span></a><span class="sd">    - `plot_3D(...)`: Plot a 3D volume rendering of the data cube using Plotly.</span>
</span><span id="StarData-144"><a href="#StarData-144"><span class="linenos"> 144</span></a><span class="sd">    - `plot_velocity_vs_intensity(...)`: Plot velocity vs. intensity at the center of the xy plane.</span>
</span><span id="StarData-145"><a href="#StarData-145"><span class="linenos"> 145</span></a><span class="sd">    - `plot_radius_vs_intensity()`: Plot radius vs. intensity at the center of the xy plane.</span>
</span><span id="StarData-146"><a href="#StarData-146"><span class="linenos"> 146</span></a><span class="sd">    - `plot_radius_vs_velocity(...)`: Plot radius vs. velocity at the center of the xy plane.</span>
</span><span id="StarData-147"><a href="#StarData-147"><span class="linenos"> 147</span></a><span class="sd">    - `create_mask(...)`: Launch an interactive mask creator for the data cube.</span>
</span><span id="StarData-148"><a href="#StarData-148"><span class="linenos"> 148</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StarData-149"><a href="#StarData-149"><span class="linenos"> 149</span></a>
</span><span id="StarData-150"><a href="#StarData-150"><span class="linenos"> 150</span></a>    <span class="n">_c</span> <span class="o">=</span> <span class="mf">299792.458</span>  <span class="c1"># speed of light, km/s</span>
</span><span id="StarData-151"><a href="#StarData-151"><span class="linenos"> 151</span></a>    <span class="n">v0</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># km/s, speed of sound</span>
</span><span id="StarData-152"><a href="#StarData-152"><span class="linenos"> 152</span></a>
</span><span id="StarData-153"><a href="#StarData-153"><span class="linenos"> 153</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StarData-154"><a href="#StarData-154"><span class="linenos"> 154</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StarData-155"><a href="#StarData-155"><span class="linenos"> 155</span></a>        <span class="n">info_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">CondensedData</span><span class="p">,</span>
</span><span id="StarData-156"><a href="#StarData-156"><span class="linenos"> 156</span></a>        <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-157"><a href="#StarData-157"><span class="linenos"> 157</span></a>        <span class="n">rest_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-158"><a href="#StarData-158"><span class="linenos"> 158</span></a>        <span class="n">maskfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-159"><a href="#StarData-159"><span class="linenos"> 159</span></a>        <span class="n">beta_law_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-160"><a href="#StarData-160"><span class="linenos"> 160</span></a>        <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-161"><a href="#StarData-161"><span class="linenos"> 161</span></a>        <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-162"><a href="#StarData-162"><span class="linenos"> 162</span></a>        <span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StarData-163"><a href="#StarData-163"><span class="linenos"> 163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-164"><a href="#StarData-164"><span class="linenos"> 164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-165"><a href="#StarData-165"><span class="linenos"> 165</span></a><span class="sd">        Initialize a StarData object by reading data from a FITS file or a CondensedData object.</span>
</span><span id="StarData-166"><a href="#StarData-166"><span class="linenos"> 166</span></a>
</span><span id="StarData-167"><a href="#StarData-167"><span class="linenos"> 167</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-168"><a href="#StarData-168"><span class="linenos"> 168</span></a>
</span><span id="StarData-169"><a href="#StarData-169"><span class="linenos"> 169</span></a><span class="sd">        - `info_source` (`str` or `CondensedData`): Path to a FITS file or a CondensedData object containing preprocessed data.</span>
</span><span id="StarData-170"><a href="#StarData-170"><span class="linenos"> 170</span></a><span class="sd">        - `distance_to_star` (`float` or `None`, optional): Distance to the star in AU (required if info_source is a FITS file).</span>
</span><span id="StarData-171"><a href="#StarData-171"><span class="linenos"> 171</span></a><span class="sd">        - `rest_frequency` (`float` or `None`, optional): Rest frequency in Hz (required if info_source is a FITS file).</span>
</span><span id="StarData-172"><a href="#StarData-172"><span class="linenos"> 172</span></a><span class="sd">        - `maskfile` (`str` or `None`, optional): Path to a .npy file containing a mask to apply to the data.</span>
</span><span id="StarData-173"><a href="#StarData-173"><span class="linenos"> 173</span></a><span class="sd">        - `beta_law_params` (`tuple` of `float` or `None`, optional): (r_dust (AU), beta) parameters for the beta velocity law. If None, will be fit from data.</span>
</span><span id="StarData-174"><a href="#StarData-174"><span class="linenos"> 174</span></a><span class="sd">        - `v_exp` (`float` or `None`, optional): Expansion velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData-175"><a href="#StarData-175"><span class="linenos"> 175</span></a><span class="sd">        - `v_sys` (`float` or `None`, optional): Systemic velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData-176"><a href="#StarData-176"><span class="linenos"> 176</span></a><span class="sd">        - `absolute_star_pos` (`tuple` of `float` or `None`, optional): Absolute (RA, Dec) position of the star in degrees. If None, taken to be the centre of the image.</span>
</span><span id="StarData-177"><a href="#StarData-177"><span class="linenos"> 177</span></a>
</span><span id="StarData-178"><a href="#StarData-178"><span class="linenos"> 178</span></a><span class="sd">        **Raises**</span>
</span><span id="StarData-179"><a href="#StarData-179"><span class="linenos"> 179</span></a>
</span><span id="StarData-180"><a href="#StarData-180"><span class="linenos"> 180</span></a><span class="sd">        - `ValueError`: If required parameters are missing when reading from a FITS file.</span>
</span><span id="StarData-181"><a href="#StarData-181"><span class="linenos"> 181</span></a><span class="sd">        - `FITSHeaderError`: If any attribute in the FITS file header is an incorrect type.</span>
</span><span id="StarData-182"><a href="#StarData-182"><span class="linenos"> 182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-183"><a href="#StarData-183"><span class="linenos"> 183</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="StarData-184"><a href="#StarData-184"><span class="linenos"> 184</span></a>            <span class="k">if</span> <span class="n">distance_to_star</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rest_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-185"><a href="#StarData-185"><span class="linenos"> 185</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distance to star and rest frequency required when reading from FITS file.&quot;</span><span class="p">)</span>
</span><span id="StarData-186"><a href="#StarData-186"><span class="linenos"> 186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__load_from_fits_file</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="n">distance_to_star</span><span class="p">,</span> <span class="n">rest_frequency</span><span class="p">,</span> <span class="n">absolute_star_pos</span><span class="p">,</span> <span class="n">v_sys</span> <span class="o">=</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData-187"><a href="#StarData-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-188"><a href="#StarData-188"><span class="linenos"> 188</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">()</span>
</span><span id="StarData-189"><a href="#StarData-189"><span class="linenos"> 189</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-190"><a href="#StarData-190"><span class="linenos"> 190</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">beta_law_params</span>
</span><span id="StarData-191"><a href="#StarData-191"><span class="linenos"> 191</span></a>
</span><span id="StarData-192"><a href="#StarData-192"><span class="linenos"> 192</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-193"><a href="#StarData-193"><span class="linenos"> 193</span></a>            <span class="c1"># load from CondensedData</span>
</span><span id="StarData-194"><a href="#StarData-194"><span class="linenos"> 194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">x_offsets</span>
</span><span id="StarData-195"><a href="#StarData-195"><span class="linenos"> 195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">y_offsets</span>
</span><span id="StarData-196"><a href="#StarData-196"><span class="linenos"> 196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_V</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_offsets</span>
</span><span id="StarData-197"><a href="#StarData-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData-198"><a href="#StarData-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="StarData-199"><a href="#StarData-199"><span class="linenos"> 199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="StarData-200"><a href="#StarData-200"><span class="linenos"> 200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_exp</span> <span class="k">if</span> <span class="n">v_exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_exp</span>
</span><span id="StarData-201"><a href="#StarData-201"><span class="linenos"> 201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_sys</span> <span class="k">if</span> <span class="n">v_sys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_sys</span>
</span><span id="StarData-202"><a href="#StarData-202"><span class="linenos"> 202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">r_dust</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-203"><a href="#StarData-203"><span class="linenos"> 203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beta</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="StarData-204"><a href="#StarData-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_maj</span>
</span><span id="StarData-205"><a href="#StarData-205"><span class="linenos"> 205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_min</span>
</span><span id="StarData-206"><a href="#StarData-206"><span class="linenos"> 206</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="StarData-207"><a href="#StarData-207"><span class="linenos"> 207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">header</span>
</span><span id="StarData-208"><a href="#StarData-208"><span class="linenos"> 208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__process_beam</span><span class="p">()</span>
</span><span id="StarData-209"><a href="#StarData-209"><span class="linenos"> 209</span></a>
</span><span id="StarData-210"><a href="#StarData-210"><span class="linenos"> 210</span></a>            <span class="c1"># compute mean and standard deviation</span>
</span><span id="StarData-211"><a href="#StarData-211"><span class="linenos"> 211</span></a>            <span class="k">if</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-212"><a href="#StarData-212"><span class="linenos"> 212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mean_and_std</span><span class="p">()</span>
</span><span id="StarData-213"><a href="#StarData-213"><span class="linenos"> 213</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-214"><a href="#StarData-214"><span class="linenos"> 214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span>
</span><span id="StarData-215"><a href="#StarData-215"><span class="linenos"> 215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span>
</span><span id="StarData-216"><a href="#StarData-216"><span class="linenos"> 216</span></a>
</span><span id="StarData-217"><a href="#StarData-217"><span class="linenos"> 217</span></a>
</span><span id="StarData-218"><a href="#StarData-218"><span class="linenos"> 218</span></a>        <span class="k">if</span> <span class="n">maskfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-219"><a href="#StarData-219"><span class="linenos"> 219</span></a>            <span class="c1"># mask data (permanent)</span>
</span><span id="StarData-220"><a href="#StarData-220"><span class="linenos"> 220</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">maskfile</span><span class="p">)</span>
</span><span id="StarData-221"><a href="#StarData-221"><span class="linenos"> 221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">*</span> <span class="n">mask</span>
</span><span id="StarData-222"><a href="#StarData-222"><span class="linenos"> 222</span></a>        
</span><span id="StarData-223"><a href="#StarData-223"><span class="linenos"> 223</span></a>    <span class="c1"># ---- READ ONLY ATTRIBUTES ----</span>
</span><span id="StarData-224"><a href="#StarData-224"><span class="linenos"> 224</span></a>
</span><span id="StarData-225"><a href="#StarData-225"><span class="linenos"> 225</span></a>    <span class="nd">@property</span>
</span><span id="StarData-226"><a href="#StarData-226"><span class="linenos"> 226</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData-227"><a href="#StarData-227"><span class="linenos"> 227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-228"><a href="#StarData-228"><span class="linenos"> 228</span></a><span class="sd">        DataArray3D </span>
</span><span id="StarData-229"><a href="#StarData-229"><span class="linenos"> 229</span></a><span class="sd">        </span>
</span><span id="StarData-230"><a href="#StarData-230"><span class="linenos"> 230</span></a><span class="sd">        Stores the intensity of light at each data point.</span>
</span><span id="StarData-231"><a href="#StarData-231"><span class="linenos"> 231</span></a><span class="sd">        </span>
</span><span id="StarData-232"><a href="#StarData-232"><span class="linenos"> 232</span></a><span class="sd">        Dimensions: k x m x n, where k is the number of frequency channels,</span>
</span><span id="StarData-233"><a href="#StarData-233"><span class="linenos"> 233</span></a><span class="sd">        m is the number of declination channels, and n is the number of right ascension channels.</span>
</span><span id="StarData-234"><a href="#StarData-234"><span class="linenos"> 234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-235"><a href="#StarData-235"><span class="linenos"> 235</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="StarData-236"><a href="#StarData-236"><span class="linenos"> 236</span></a>
</span><span id="StarData-237"><a href="#StarData-237"><span class="linenos"> 237</span></a>    <span class="nd">@property</span>
</span><span id="StarData-238"><a href="#StarData-238"><span class="linenos"> 238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData-239"><a href="#StarData-239"><span class="linenos"> 239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-240"><a href="#StarData-240"><span class="linenos"> 240</span></a><span class="sd">        DataArray1D </span>
</span><span id="StarData-241"><a href="#StarData-241"><span class="linenos"> 241</span></a><span class="sd">        </span>
</span><span id="StarData-242"><a href="#StarData-242"><span class="linenos"> 242</span></a><span class="sd">        Stores the x-coordinates relative to the centre in AU.</span>
</span><span id="StarData-243"><a href="#StarData-243"><span class="linenos"> 243</span></a><span class="sd">        Obtained from right ascension coordinates.</span>
</span><span id="StarData-244"><a href="#StarData-244"><span class="linenos"> 244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-245"><a href="#StarData-245"><span class="linenos"> 245</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>
</span><span id="StarData-246"><a href="#StarData-246"><span class="linenos"> 246</span></a>
</span><span id="StarData-247"><a href="#StarData-247"><span class="linenos"> 247</span></a>    <span class="nd">@property</span>
</span><span id="StarData-248"><a href="#StarData-248"><span class="linenos"> 248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData-249"><a href="#StarData-249"><span class="linenos"> 249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-250"><a href="#StarData-250"><span class="linenos"> 250</span></a><span class="sd">        DataArray1D</span>
</span><span id="StarData-251"><a href="#StarData-251"><span class="linenos"> 251</span></a><span class="sd">         </span>
</span><span id="StarData-252"><a href="#StarData-252"><span class="linenos"> 252</span></a><span class="sd">        Stores the y-coordinates relative to the centre in AU.</span>
</span><span id="StarData-253"><a href="#StarData-253"><span class="linenos"> 253</span></a><span class="sd">        Obtained from declination coordinates.</span>
</span><span id="StarData-254"><a href="#StarData-254"><span class="linenos"> 254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-255"><a href="#StarData-255"><span class="linenos"> 255</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>
</span><span id="StarData-256"><a href="#StarData-256"><span class="linenos"> 256</span></a>
</span><span id="StarData-257"><a href="#StarData-257"><span class="linenos"> 257</span></a>    <span class="nd">@property</span>
</span><span id="StarData-258"><a href="#StarData-258"><span class="linenos"> 258</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">V</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData-259"><a href="#StarData-259"><span class="linenos"> 259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-260"><a href="#StarData-260"><span class="linenos"> 260</span></a><span class="sd">        DataArray1D</span>
</span><span id="StarData-261"><a href="#StarData-261"><span class="linenos"> 261</span></a><span class="sd">        </span>
</span><span id="StarData-262"><a href="#StarData-262"><span class="linenos"> 262</span></a><span class="sd">        Stores the velocity offsets relative to the star velocity in km/s.</span>
</span><span id="StarData-263"><a href="#StarData-263"><span class="linenos"> 263</span></a><span class="sd">        Obtained from frequency channels.</span>
</span><span id="StarData-264"><a href="#StarData-264"><span class="linenos"> 264</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-265"><a href="#StarData-265"><span class="linenos"> 265</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_V</span>
</span><span id="StarData-266"><a href="#StarData-266"><span class="linenos"> 266</span></a>
</span><span id="StarData-267"><a href="#StarData-267"><span class="linenos"> 267</span></a>    <span class="nd">@property</span>
</span><span id="StarData-268"><a href="#StarData-268"><span class="linenos"> 268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">distance_to_star</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-269"><a href="#StarData-269"><span class="linenos"> 269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-270"><a href="#StarData-270"><span class="linenos"> 270</span></a><span class="sd">        Distance to star in AU.</span>
</span><span id="StarData-271"><a href="#StarData-271"><span class="linenos"> 271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-272"><a href="#StarData-272"><span class="linenos"> 272</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span>
</span><span id="StarData-273"><a href="#StarData-273"><span class="linenos"> 273</span></a>
</span><span id="StarData-274"><a href="#StarData-274"><span class="linenos"> 274</span></a>    <span class="nd">@property</span>
</span><span id="StarData-275"><a href="#StarData-275"><span class="linenos"> 275</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix2x2</span><span class="p">:</span>
</span><span id="StarData-276"><a href="#StarData-276"><span class="linenos"> 276</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-277"><a href="#StarData-277"><span class="linenos"> 277</span></a><span class="sd">        Matrix2x2</span>
</span><span id="StarData-278"><a href="#StarData-278"><span class="linenos"> 278</span></a>
</span><span id="StarData-279"><a href="#StarData-279"><span class="linenos"> 279</span></a><span class="sd">        Ellipse matrix of beam. For 1x2 vectors v, w with coordinates (ra, dec) in degrees,</span>
</span><span id="StarData-280"><a href="#StarData-280"><span class="linenos"> 280</span></a><span class="sd">        if (v-w)^T B (v-w) &lt; 1, then v is within the beam centred at w.</span>
</span><span id="StarData-281"><a href="#StarData-281"><span class="linenos"> 281</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-282"><a href="#StarData-282"><span class="linenos"> 282</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B</span>
</span><span id="StarData-283"><a href="#StarData-283"><span class="linenos"> 283</span></a>
</span><span id="StarData-284"><a href="#StarData-284"><span class="linenos"> 284</span></a>    <span class="nd">@property</span>
</span><span id="StarData-285"><a href="#StarData-285"><span class="linenos"> 285</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_maj</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-286"><a href="#StarData-286"><span class="linenos"> 286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-287"><a href="#StarData-287"><span class="linenos"> 287</span></a><span class="sd">        Major axis of the beam in degrees.</span>
</span><span id="StarData-288"><a href="#StarData-288"><span class="linenos"> 288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-289"><a href="#StarData-289"><span class="linenos"> 289</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span>
</span><span id="StarData-290"><a href="#StarData-290"><span class="linenos"> 290</span></a>
</span><span id="StarData-291"><a href="#StarData-291"><span class="linenos"> 291</span></a>    <span class="nd">@property</span>
</span><span id="StarData-292"><a href="#StarData-292"><span class="linenos"> 292</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-293"><a href="#StarData-293"><span class="linenos"> 293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-294"><a href="#StarData-294"><span class="linenos"> 294</span></a><span class="sd">        Minor axis of the beam in degrees.</span>
</span><span id="StarData-295"><a href="#StarData-295"><span class="linenos"> 295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-296"><a href="#StarData-296"><span class="linenos"> 296</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span>
</span><span id="StarData-297"><a href="#StarData-297"><span class="linenos"> 297</span></a>
</span><span id="StarData-298"><a href="#StarData-298"><span class="linenos"> 298</span></a>    <span class="nd">@property</span>
</span><span id="StarData-299"><a href="#StarData-299"><span class="linenos"> 299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-300"><a href="#StarData-300"><span class="linenos"> 300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-301"><a href="#StarData-301"><span class="linenos"> 301</span></a><span class="sd">        Beam position angle in degrees.</span>
</span><span id="StarData-302"><a href="#StarData-302"><span class="linenos"> 302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-303"><a href="#StarData-303"><span class="linenos"> 303</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span>
</span><span id="StarData-304"><a href="#StarData-304"><span class="linenos"> 304</span></a>
</span><span id="StarData-305"><a href="#StarData-305"><span class="linenos"> 305</span></a>    <span class="nd">@property</span>
</span><span id="StarData-306"><a href="#StarData-306"><span class="linenos"> 306</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-307"><a href="#StarData-307"><span class="linenos"> 307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-308"><a href="#StarData-308"><span class="linenos"> 308</span></a><span class="sd">        The mean intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="StarData-309"><a href="#StarData-309"><span class="linenos"> 309</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-310"><a href="#StarData-310"><span class="linenos"> 310</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span>
</span><span id="StarData-311"><a href="#StarData-311"><span class="linenos"> 311</span></a>
</span><span id="StarData-312"><a href="#StarData-312"><span class="linenos"> 312</span></a>    <span class="nd">@property</span>
</span><span id="StarData-313"><a href="#StarData-313"><span class="linenos"> 313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-314"><a href="#StarData-314"><span class="linenos"> 314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-315"><a href="#StarData-315"><span class="linenos"> 315</span></a><span class="sd">        The standard deviation of the intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="StarData-316"><a href="#StarData-316"><span class="linenos"> 316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-317"><a href="#StarData-317"><span class="linenos"> 317</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span>
</span><span id="StarData-318"><a href="#StarData-318"><span class="linenos"> 318</span></a>
</span><span id="StarData-319"><a href="#StarData-319"><span class="linenos"> 319</span></a>    <span class="nd">@property</span>
</span><span id="StarData-320"><a href="#StarData-320"><span class="linenos"> 320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-321"><a href="#StarData-321"><span class="linenos"> 321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-322"><a href="#StarData-322"><span class="linenos"> 322</span></a><span class="sd">        The systemic velocity of the star in km/s.</span>
</span><span id="StarData-323"><a href="#StarData-323"><span class="linenos"> 323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-324"><a href="#StarData-324"><span class="linenos"> 324</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span>
</span><span id="StarData-325"><a href="#StarData-325"><span class="linenos"> 325</span></a>
</span><span id="StarData-326"><a href="#StarData-326"><span class="linenos"> 326</span></a>    <span class="nd">@property</span>
</span><span id="StarData-327"><a href="#StarData-327"><span class="linenos"> 327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-328"><a href="#StarData-328"><span class="linenos"> 328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-329"><a href="#StarData-329"><span class="linenos"> 329</span></a><span class="sd">        The maximum radial expansion speed in km/s.</span>
</span><span id="StarData-330"><a href="#StarData-330"><span class="linenos"> 330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-331"><a href="#StarData-331"><span class="linenos"> 331</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span>
</span><span id="StarData-332"><a href="#StarData-332"><span class="linenos"> 332</span></a>
</span><span id="StarData-333"><a href="#StarData-333"><span class="linenos"> 333</span></a>    <span class="nd">@property</span>
</span><span id="StarData-334"><a href="#StarData-334"><span class="linenos"> 334</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-335"><a href="#StarData-335"><span class="linenos"> 335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-336"><a href="#StarData-336"><span class="linenos"> 336</span></a><span class="sd">        Beta parameter of the velocity law.</span>
</span><span id="StarData-337"><a href="#StarData-337"><span class="linenos"> 337</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-338"><a href="#StarData-338"><span class="linenos"> 338</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span><span id="StarData-339"><a href="#StarData-339"><span class="linenos"> 339</span></a>
</span><span id="StarData-340"><a href="#StarData-340"><span class="linenos"> 340</span></a>    <span class="nd">@property</span>
</span><span id="StarData-341"><a href="#StarData-341"><span class="linenos"> 341</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">r_dust</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-342"><a href="#StarData-342"><span class="linenos"> 342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-343"><a href="#StarData-343"><span class="linenos"> 343</span></a><span class="sd">        Dust formation radius in AU.</span>
</span><span id="StarData-344"><a href="#StarData-344"><span class="linenos"> 344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-345"><a href="#StarData-345"><span class="linenos"> 345</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span>
</span><span id="StarData-346"><a href="#StarData-346"><span class="linenos"> 346</span></a>
</span><span id="StarData-347"><a href="#StarData-347"><span class="linenos"> 347</span></a>    <span class="nd">@property</span>
</span><span id="StarData-348"><a href="#StarData-348"><span class="linenos"> 348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData-349"><a href="#StarData-349"><span class="linenos"> 349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-350"><a href="#StarData-350"><span class="linenos"> 350</span></a><span class="sd">        Characteristic radius (e.g., maximum intensity change).</span>
</span><span id="StarData-351"><a href="#StarData-351"><span class="linenos"> 351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-352"><a href="#StarData-352"><span class="linenos"> 352</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span>
</span><span id="StarData-353"><a href="#StarData-353"><span class="linenos"> 353</span></a>
</span><span id="StarData-354"><a href="#StarData-354"><span class="linenos"> 354</span></a>    <span class="nd">@property</span>
</span><span id="StarData-355"><a href="#StarData-355"><span class="linenos"> 355</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta_velocity_law</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VelocityModel</span><span class="p">:</span>
</span><span id="StarData-356"><a href="#StarData-356"><span class="linenos"> 356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-357"><a href="#StarData-357"><span class="linenos"> 357</span></a><span class="sd">        VelocityModel</span>
</span><span id="StarData-358"><a href="#StarData-358"><span class="linenos"> 358</span></a>
</span><span id="StarData-359"><a href="#StarData-359"><span class="linenos"> 359</span></a><span class="sd">        Returns a callable implementing the beta velocity law with the current object&#39;s parameters.</span>
</span><span id="StarData-360"><a href="#StarData-360"><span class="linenos"> 360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-361"><a href="#StarData-361"><span class="linenos"> 361</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">law</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span><span id="StarData-362"><a href="#StarData-362"><span class="linenos"> 362</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
</span><span id="StarData-363"><a href="#StarData-363"><span class="linenos"> 363</span></a>        <span class="k">return</span> <span class="n">law</span>
</span><span id="StarData-364"><a href="#StarData-364"><span class="linenos"> 364</span></a>
</span><span id="StarData-365"><a href="#StarData-365"><span class="linenos"> 365</span></a>    <span class="c1"># ---- EXPORT ----</span>
</span><span id="StarData-366"><a href="#StarData-366"><span class="linenos"> 366</span></a>
</span><span id="StarData-367"><a href="#StarData-367"><span class="linenos"> 367</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="StarData-368"><a href="#StarData-368"><span class="linenos"> 368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-369"><a href="#StarData-369"><span class="linenos"> 369</span></a><span class="sd">        Export all defining attributes to a CondensedData object.</span>
</span><span id="StarData-370"><a href="#StarData-370"><span class="linenos"> 370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-371"><a href="#StarData-371"><span class="linenos"> 371</span></a>        <span class="k">return</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="StarData-372"><a href="#StarData-372"><span class="linenos"> 372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
</span><span id="StarData-373"><a href="#StarData-373"><span class="linenos"> 373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
</span><span id="StarData-374"><a href="#StarData-374"><span class="linenos"> 374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
</span><span id="StarData-375"><a href="#StarData-375"><span class="linenos"> 375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
</span><span id="StarData-376"><a href="#StarData-376"><span class="linenos"> 376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span>
</span><span id="StarData-377"><a href="#StarData-377"><span class="linenos"> 377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span>
</span><span id="StarData-378"><a href="#StarData-378"><span class="linenos"> 378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span>
</span><span id="StarData-379"><a href="#StarData-379"><span class="linenos"> 379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="StarData-380"><a href="#StarData-380"><span class="linenos"> 380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="StarData-381"><a href="#StarData-381"><span class="linenos"> 381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="StarData-382"><a href="#StarData-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span>
</span><span id="StarData-383"><a href="#StarData-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span>
</span><span id="StarData-384"><a href="#StarData-384"><span class="linenos"> 384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="StarData-385"><a href="#StarData-385"><span class="linenos"> 385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="StarData-386"><a href="#StarData-386"><span class="linenos"> 386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="StarData-387"><a href="#StarData-387"><span class="linenos"> 387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span> 
</span><span id="StarData-388"><a href="#StarData-388"><span class="linenos"> 388</span></a>        <span class="p">)</span>
</span><span id="StarData-389"><a href="#StarData-389"><span class="linenos"> 389</span></a>
</span><span id="StarData-390"><a href="#StarData-390"><span class="linenos"> 390</span></a>    <span class="c1"># ---- HELPER METHODS FOR INITIALISATION ----</span>
</span><span id="StarData-391"><a href="#StarData-391"><span class="linenos"> 391</span></a>
</span><span id="StarData-392"><a href="#StarData-392"><span class="linenos"> 392</span></a>    <span class="nd">@staticmethod</span>
</span><span id="StarData-393"><a href="#StarData-393"><span class="linenos"> 393</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__header_check</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="n">Header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="StarData-394"><a href="#StarData-394"><span class="linenos"> 394</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-395"><a href="#StarData-395"><span class="linenos"> 395</span></a><span class="sd">        Check that the FITS header contains all required values with appropriate types.</span>
</span><span id="StarData-396"><a href="#StarData-396"><span class="linenos"> 396</span></a>
</span><span id="StarData-397"><a href="#StarData-397"><span class="linenos"> 397</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-398"><a href="#StarData-398"><span class="linenos"> 398</span></a><span class="sd">        ----------</span>
</span><span id="StarData-399"><a href="#StarData-399"><span class="linenos"> 399</span></a><span class="sd">        header : Header</span>
</span><span id="StarData-400"><a href="#StarData-400"><span class="linenos"> 400</span></a><span class="sd">            FITS header object to check.</span>
</span><span id="StarData-401"><a href="#StarData-401"><span class="linenos"> 401</span></a>
</span><span id="StarData-402"><a href="#StarData-402"><span class="linenos"> 402</span></a><span class="sd">        Returns</span>
</span><span id="StarData-403"><a href="#StarData-403"><span class="linenos"> 403</span></a><span class="sd">        -------</span>
</span><span id="StarData-404"><a href="#StarData-404"><span class="linenos"> 404</span></a><span class="sd">        missing_beam : bool</span>
</span><span id="StarData-405"><a href="#StarData-405"><span class="linenos"> 405</span></a><span class="sd">            True if beam parameters are missing from the header, False otherwise.</span>
</span><span id="StarData-406"><a href="#StarData-406"><span class="linenos"> 406</span></a>
</span><span id="StarData-407"><a href="#StarData-407"><span class="linenos"> 407</span></a><span class="sd">        Raises</span>
</span><span id="StarData-408"><a href="#StarData-408"><span class="linenos"> 408</span></a><span class="sd">        ------</span>
</span><span id="StarData-409"><a href="#StarData-409"><span class="linenos"> 409</span></a><span class="sd">        FITSHeaderError</span>
</span><span id="StarData-410"><a href="#StarData-410"><span class="linenos"> 410</span></a><span class="sd">            If any required attribute is present but has an incorrect type.</span>
</span><span id="StarData-411"><a href="#StarData-411"><span class="linenos"> 411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-412"><a href="#StarData-412"><span class="linenos"> 412</span></a>        <span class="n">missing_beam</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StarData-413"><a href="#StarData-413"><span class="linenos"> 413</span></a>        <span class="n">types_to_check</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StarData-414"><a href="#StarData-414"><span class="linenos"> 414</span></a>            <span class="s2">&quot;BSCALE&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-415"><a href="#StarData-415"><span class="linenos"> 415</span></a>            <span class="s2">&quot;BZERO&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-416"><a href="#StarData-416"><span class="linenos"> 416</span></a>            <span class="s2">&quot;OBJECT&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="StarData-417"><a href="#StarData-417"><span class="linenos"> 417</span></a>            <span class="s2">&quot;BMAJ&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-418"><a href="#StarData-418"><span class="linenos"> 418</span></a>            <span class="s2">&quot;BMIN&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-419"><a href="#StarData-419"><span class="linenos"> 419</span></a>            <span class="s2">&quot;BPA&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-420"><a href="#StarData-420"><span class="linenos"> 420</span></a>            <span class="s2">&quot;BTYPE&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="StarData-421"><a href="#StarData-421"><span class="linenos"> 421</span></a>            <span class="s2">&quot;BUNIT&quot;</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="StarData-422"><a href="#StarData-422"><span class="linenos"> 422</span></a>        <span class="p">}</span>
</span><span id="StarData-423"><a href="#StarData-423"><span class="linenos"> 423</span></a>        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
</span><span id="StarData-424"><a href="#StarData-424"><span class="linenos"> 424</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CTYPE&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span>
</span><span id="StarData-425"><a href="#StarData-425"><span class="linenos"> 425</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span>
</span><span id="StarData-426"><a href="#StarData-426"><span class="linenos"> 426</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="StarData-427"><a href="#StarData-427"><span class="linenos"> 427</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="StarData-428"><a href="#StarData-428"><span class="linenos"> 428</span></a>            <span class="n">types_to_check</span><span class="p">[</span><span class="s2">&quot;CDELT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="StarData-429"><a href="#StarData-429"><span class="linenos"> 429</span></a>
</span><span id="StarData-430"><a href="#StarData-430"><span class="linenos"> 430</span></a>        <span class="c1"># check if beam is present in data</span>
</span><span id="StarData-431"><a href="#StarData-431"><span class="linenos"> 431</span></a>        <span class="k">if</span> <span class="s2">&quot;BMAJ&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="s2">&quot;BMIN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="s2">&quot;BPA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
</span><span id="StarData-432"><a href="#StarData-432"><span class="linenos"> 432</span></a>            <span class="n">missing_beam</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData-433"><a href="#StarData-433"><span class="linenos"> 433</span></a>
</span><span id="StarData-434"><a href="#StarData-434"><span class="linenos"> 434</span></a>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">types_to_check</span><span class="p">:</span>
</span><span id="StarData-435"><a href="#StarData-435"><span class="linenos"> 435</span></a>            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">,</span> <span class="s2">&quot;BMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">missing_beam</span><span class="p">:</span>
</span><span id="StarData-436"><a href="#StarData-436"><span class="linenos"> 436</span></a>                <span class="k">continue</span>
</span><span id="StarData-437"><a href="#StarData-437"><span class="linenos"> 437</span></a>            <span class="n">attr_type</span> <span class="o">=</span> <span class="n">types_to_check</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
</span><span id="StarData-438"><a href="#StarData-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="ow">is</span> <span class="n">attr_type</span><span class="p">:</span>
</span><span id="StarData-439"><a href="#StarData-439"><span class="linenos"> 439</span></a>                <span class="k">raise</span> <span class="n">FITSHeaderError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Header attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> should have type </span><span class="si">{</span><span class="n">attr_type</span><span class="si">}</span><span class="s2">, instead is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StarData-440"><a href="#StarData-440"><span class="linenos"> 440</span></a>        <span class="k">return</span> <span class="n">missing_beam</span>
</span><span id="StarData-441"><a href="#StarData-441"><span class="linenos"> 441</span></a>
</span><span id="StarData-442"><a href="#StarData-442"><span class="linenos"> 442</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__load_from_fits_file</span><span class="p">(</span>
</span><span id="StarData-443"><a href="#StarData-443"><span class="linenos"> 443</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StarData-444"><a href="#StarData-444"><span class="linenos"> 444</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="StarData-445"><a href="#StarData-445"><span class="linenos"> 445</span></a>        <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-446"><a href="#StarData-446"><span class="linenos"> 446</span></a>        <span class="n">rest_freq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-447"><a href="#StarData-447"><span class="linenos"> 447</span></a>        <span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-448"><a href="#StarData-448"><span class="linenos"> 448</span></a>        <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-449"><a href="#StarData-449"><span class="linenos"> 449</span></a>        <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StarData-450"><a href="#StarData-450"><span class="linenos"> 450</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-451"><a href="#StarData-451"><span class="linenos"> 451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-452"><a href="#StarData-452"><span class="linenos"> 452</span></a><span class="sd">        Load data and metadata from a FITS file and initialize StarData attributes.</span>
</span><span id="StarData-453"><a href="#StarData-453"><span class="linenos"> 453</span></a>
</span><span id="StarData-454"><a href="#StarData-454"><span class="linenos"> 454</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-455"><a href="#StarData-455"><span class="linenos"> 455</span></a><span class="sd">        ----------</span>
</span><span id="StarData-456"><a href="#StarData-456"><span class="linenos"> 456</span></a><span class="sd">        filename : str</span>
</span><span id="StarData-457"><a href="#StarData-457"><span class="linenos"> 457</span></a><span class="sd">            Path to the FITS file.</span>
</span><span id="StarData-458"><a href="#StarData-458"><span class="linenos"> 458</span></a><span class="sd">        distance_to_star : float</span>
</span><span id="StarData-459"><a href="#StarData-459"><span class="linenos"> 459</span></a><span class="sd">            Distance to the star in AU.</span>
</span><span id="StarData-460"><a href="#StarData-460"><span class="linenos"> 460</span></a><span class="sd">        rest_freq : float</span>
</span><span id="StarData-461"><a href="#StarData-461"><span class="linenos"> 461</span></a><span class="sd">            Rest frequency in Hz.</span>
</span><span id="StarData-462"><a href="#StarData-462"><span class="linenos"> 462</span></a><span class="sd">        absolute_star_pos : tuple of float or None, optional</span>
</span><span id="StarData-463"><a href="#StarData-463"><span class="linenos"> 463</span></a><span class="sd">            Absolute (RA, Dec) position of the star in degrees. If None, use image center.</span>
</span><span id="StarData-464"><a href="#StarData-464"><span class="linenos"> 464</span></a><span class="sd">        v_sys : float or None, optional</span>
</span><span id="StarData-465"><a href="#StarData-465"><span class="linenos"> 465</span></a><span class="sd">            Systemic velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData-466"><a href="#StarData-466"><span class="linenos"> 466</span></a><span class="sd">        v_exp : float or None, optional</span>
</span><span id="StarData-467"><a href="#StarData-467"><span class="linenos"> 467</span></a><span class="sd">            Expansion velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData-468"><a href="#StarData-468"><span class="linenos"> 468</span></a>
</span><span id="StarData-469"><a href="#StarData-469"><span class="linenos"> 469</span></a><span class="sd">        Returns</span>
</span><span id="StarData-470"><a href="#StarData-470"><span class="linenos"> 470</span></a><span class="sd">        -------</span>
</span><span id="StarData-471"><a href="#StarData-471"><span class="linenos"> 471</span></a><span class="sd">        None</span>
</span><span id="StarData-472"><a href="#StarData-472"><span class="linenos"> 472</span></a>
</span><span id="StarData-473"><a href="#StarData-473"><span class="linenos"> 473</span></a><span class="sd">        Raises</span>
</span><span id="StarData-474"><a href="#StarData-474"><span class="linenos"> 474</span></a><span class="sd">        ------</span>
</span><span id="StarData-475"><a href="#StarData-475"><span class="linenos"> 475</span></a><span class="sd">        FITSHeaderError</span>
</span><span id="StarData-476"><a href="#StarData-476"><span class="linenos"> 476</span></a><span class="sd">            If the FITS header is missing required attributes or has incorrect types.</span>
</span><span id="StarData-477"><a href="#StarData-477"><span class="linenos"> 477</span></a><span class="sd">        AssertionError</span>
</span><span id="StarData-478"><a href="#StarData-478"><span class="linenos"> 478</span></a><span class="sd">            If the FITS file does not contain data.</span>
</span><span id="StarData-479"><a href="#StarData-479"><span class="linenos"> 479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-480"><a href="#StarData-480"><span class="linenos"> 480</span></a>        <span class="c1"># read data from file</span>
</span><span id="StarData-481"><a href="#StarData-481"><span class="linenos"> 481</span></a>        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
</span><span id="StarData-482"><a href="#StarData-482"><span class="linenos"> 482</span></a>            <span class="n">hdu</span><span class="p">:</span> <span class="n">PrimaryHDU</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># type: ignore</span>
</span><span id="StarData-483"><a href="#StarData-483"><span class="linenos"> 483</span></a>
</span><span id="StarData-484"><a href="#StarData-484"><span class="linenos"> 484</span></a>            <span class="n">missing_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__header_check</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>  <span class="c1"># check that all the information is available before proceeding</span>
</span><span id="StarData-485"><a href="#StarData-485"><span class="linenos"> 485</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">:</span> <span class="n">Header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
</span><span id="StarData-486"><a href="#StarData-486"><span class="linenos"> 486</span></a>            <span class="k">if</span> <span class="n">missing_beam</span><span class="p">:</span>  <span class="c1"># data is in hdul[1].data instead</span>
</span><span id="StarData-487"><a href="#StarData-487"><span class="linenos"> 487</span></a>                <span class="n">beam_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData-488"><a href="#StarData-488"><span class="linenos"> 488</span></a>
</span><span id="StarData-489"><a href="#StarData-489"><span class="linenos"> 489</span></a>                <span class="n">str_to_conversion</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StarData-490"><a href="#StarData-490"><span class="linenos"> 490</span></a>                    <span class="s2">&quot;arcsec&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
</span><span id="StarData-491"><a href="#StarData-491"><span class="linenos"> 491</span></a>                    <span class="s2">&quot;deg&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="StarData-492"><a href="#StarData-492"><span class="linenos"> 492</span></a>                    <span class="s2">&quot;degrees&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="StarData-493"><a href="#StarData-493"><span class="linenos"> 493</span></a>                    <span class="s2">&quot;degree&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="StarData-494"><a href="#StarData-494"><span class="linenos"> 494</span></a>                <span class="p">}</span>
</span><span id="StarData-495"><a href="#StarData-495"><span class="linenos"> 495</span></a>                <span class="n">unit_maj</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TUNIT1&quot;</span><span class="p">]</span>
</span><span id="StarData-496"><a href="#StarData-496"><span class="linenos"> 496</span></a>                <span class="n">unit_min</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span>
</span><span id="StarData-497"><a href="#StarData-497"><span class="linenos"> 497</span></a>
</span><span id="StarData-498"><a href="#StarData-498"><span class="linenos"> 498</span></a>                <span class="c1"># 1 arcsec = 1/3600 degree</span>
</span><span id="StarData-499"><a href="#StarData-499"><span class="linenos"> 499</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span><span class="o">*</span><span class="n">str_to_conversion</span><span class="p">[</span><span class="n">unit_maj</span><span class="p">]</span>
</span><span id="StarData-500"><a href="#StarData-500"><span class="linenos"> 500</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span><span class="o">*</span><span class="n">str_to_conversion</span><span class="p">[</span><span class="n">unit_min</span><span class="p">]</span>
</span><span id="StarData-501"><a href="#StarData-501"><span class="linenos"> 501</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_data</span><span class="p">]))</span>
</span><span id="StarData-502"><a href="#StarData-502"><span class="linenos"> 502</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-503"><a href="#StarData-503"><span class="linenos"> 503</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span>
</span><span id="StarData-504"><a href="#StarData-504"><span class="linenos"> 504</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span>
</span><span id="StarData-505"><a href="#StarData-505"><span class="linenos"> 505</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span>
</span><span id="StarData-506"><a href="#StarData-506"><span class="linenos"> 506</span></a>                
</span><span id="StarData-507"><a href="#StarData-507"><span class="linenos"> 507</span></a>            
</span><span id="StarData-508"><a href="#StarData-508"><span class="linenos"> 508</span></a>
</span><span id="StarData-509"><a href="#StarData-509"><span class="linenos"> 509</span></a>            <span class="n">brightness_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BSCALE&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-510"><a href="#StarData-510"><span class="linenos"> 510</span></a>            <span class="n">brightness_zero</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;BZERO&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-511"><a href="#StarData-511"><span class="linenos"> 511</span></a>
</span><span id="StarData-512"><a href="#StarData-512"><span class="linenos"> 512</span></a>            <span class="c1"># scale data to be in specified brightness units</span>
</span><span id="StarData-513"><a href="#StarData-513"><span class="linenos"> 513</span></a>            <span class="k">assert</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="StarData-514"><a href="#StarData-514"><span class="linenos"> 514</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">float64</span><span class="p">)</span><span class="o">*</span><span class="n">brightness_scale</span><span class="o">+</span><span class="n">brightness_zero</span>  <span class="c1">#freq, dec, ra</span>
</span><span id="StarData-515"><a href="#StarData-515"><span class="linenos"> 515</span></a>
</span><span id="StarData-516"><a href="#StarData-516"><span class="linenos"> 516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-517"><a href="#StarData-517"><span class="linenos"> 517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span> <span class="o">=</span> <span class="n">distance_to_star</span>
</span><span id="StarData-518"><a href="#StarData-518"><span class="linenos"> 518</span></a>
</span><span id="StarData-519"><a href="#StarData-519"><span class="linenos"> 519</span></a>
</span><span id="StarData-520"><a href="#StarData-520"><span class="linenos"> 520</span></a>        <span class="c1"># get velocities from frequencies</span>
</span><span id="StarData-521"><a href="#StarData-521"><span class="linenos"> 521</span></a>        <span class="n">freq_range</span><span class="p">:</span> <span class="n">DataArray1D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="StarData-522"><a href="#StarData-522"><span class="linenos"> 522</span></a>        <span class="n">vel_range</span><span class="p">:</span> <span class="n">DataArray1D</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freq_range</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">rest_freq</span><span class="p">)</span><span class="o">*</span><span class="n">rest_freq</span><span class="o">*</span><span class="n">StarData</span><span class="o">.</span><span class="n">_c</span>  <span class="c1"># velocity in km/s</span>
</span><span id="StarData-523"><a href="#StarData-523"><span class="linenos"> 523</span></a>        <span class="k">if</span> <span class="n">vel_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># array is backwards</span>
</span><span id="StarData-524"><a href="#StarData-524"><span class="linenos"> 524</span></a>            <span class="n">vel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">vel_range</span><span class="p">)</span>
</span><span id="StarData-525"><a href="#StarData-525"><span class="linenos"> 525</span></a>
</span><span id="StarData-526"><a href="#StarData-526"><span class="linenos"> 526</span></a>
</span><span id="StarData-527"><a href="#StarData-527"><span class="linenos"> 527</span></a>        <span class="c1"># get X and Y coordinates</span>
</span><span id="StarData-528"><a href="#StarData-528"><span class="linenos"> 528</span></a>        <span class="n">ra_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="StarData-529"><a href="#StarData-529"><span class="linenos"> 529</span></a>        <span class="n">dec_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_header_array</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># reverse !!</span>
</span><span id="StarData-530"><a href="#StarData-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="n">absolute_star_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-531"><a href="#StarData-531"><span class="linenos"> 531</span></a>            <span class="n">ra_offsets</span> <span class="o">=</span> <span class="n">ra_vals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ra_vals</span><span class="p">)</span>
</span><span id="StarData-532"><a href="#StarData-532"><span class="linenos"> 532</span></a>            <span class="n">dec_offsets</span> <span class="o">=</span> <span class="n">dec_vals</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_vals</span><span class="p">)</span>
</span><span id="StarData-533"><a href="#StarData-533"><span class="linenos"> 533</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-534"><a href="#StarData-534"><span class="linenos"> 534</span></a>            <span class="n">ra_offsets</span> <span class="o">=</span> <span class="n">ra_vals</span> <span class="o">-</span> <span class="n">absolute_star_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-535"><a href="#StarData-535"><span class="linenos"> 535</span></a>            <span class="n">dec_offsets</span> <span class="o">=</span> <span class="n">dec_vals</span> <span class="o">-</span> <span class="n">absolute_star_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="StarData-536"><a href="#StarData-536"><span class="linenos"> 536</span></a>
</span><span id="StarData-537"><a href="#StarData-537"><span class="linenos"> 537</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">ra_offsets</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>  <span class="c1"># measured in AU</span>
</span><span id="StarData-538"><a href="#StarData-538"><span class="linenos"> 538</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">dec_offsets</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
</span><span id="StarData-539"><a href="#StarData-539"><span class="linenos"> 539</span></a>
</span><span id="StarData-540"><a href="#StarData-540"><span class="linenos"> 540</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__process_beam</span><span class="p">()</span>
</span><span id="StarData-541"><a href="#StarData-541"><span class="linenos"> 541</span></a>
</span><span id="StarData-542"><a href="#StarData-542"><span class="linenos"> 542</span></a>        <span class="c1"># get mean and standard deviation of intensity values of noise</span>
</span><span id="StarData-543"><a href="#StarData-543"><span class="linenos"> 543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mean_and_std</span><span class="p">()</span>
</span><span id="StarData-544"><a href="#StarData-544"><span class="linenos"> 544</span></a>
</span><span id="StarData-545"><a href="#StarData-545"><span class="linenos"> 545</span></a>        <span class="c1"># get velocity offsets</span>
</span><span id="StarData-546"><a href="#StarData-546"><span class="linenos"> 546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_star_and_exp_velocity</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">v_sys</span> <span class="o">=</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData-547"><a href="#StarData-547"><span class="linenos"> 547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_V</span> <span class="o">=</span> <span class="n">vel_range</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span>
</span><span id="StarData-548"><a href="#StarData-548"><span class="linenos"> 548</span></a>
</span><span id="StarData-549"><a href="#StarData-549"><span class="linenos"> 549</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__process_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-550"><a href="#StarData-550"><span class="linenos"> 550</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-551"><a href="#StarData-551"><span class="linenos"> 551</span></a><span class="sd">        Compute the beam ellipse matrix and pixel offsets for the beam and its boundary.</span>
</span><span id="StarData-552"><a href="#StarData-552"><span class="linenos"> 552</span></a>
</span><span id="StarData-553"><a href="#StarData-553"><span class="linenos"> 553</span></a><span class="sd">        Returns</span>
</span><span id="StarData-554"><a href="#StarData-554"><span class="linenos"> 554</span></a><span class="sd">        -------</span>
</span><span id="StarData-555"><a href="#StarData-555"><span class="linenos"> 555</span></a><span class="sd">        None</span>
</span><span id="StarData-556"><a href="#StarData-556"><span class="linenos"> 556</span></a>
</span><span id="StarData-557"><a href="#StarData-557"><span class="linenos"> 557</span></a><span class="sd">        Notes</span>
</span><span id="StarData-558"><a href="#StarData-558"><span class="linenos"> 558</span></a><span class="sd">        -----</span>
</span><span id="StarData-559"><a href="#StarData-559"><span class="linenos"> 559</span></a><span class="sd">        Sets the attributes `_B`, `_offset_in_beam`, and `_boundary_offset` for use in beam-related calculations.</span>
</span><span id="StarData-560"><a href="#StarData-560"><span class="linenos"> 560</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-561"><a href="#StarData-561"><span class="linenos"> 561</span></a>        <span class="c1"># get matrix for elliptical distance corresponding to beam</span>
</span><span id="StarData-562"><a href="#StarData-562"><span class="linenos"> 562</span></a>        <span class="n">major</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-563"><a href="#StarData-563"><span class="linenos"> 563</span></a>        <span class="n">minor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="o">/</span><span class="mi">2</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-564"><a href="#StarData-564"><span class="linenos"> 564</span></a>
</span><span id="StarData-565"><a href="#StarData-565"><span class="linenos"> 565</span></a>        <span class="c1"># degress -&gt; radians</span>
</span><span id="StarData-566"><a href="#StarData-566"><span class="linenos"> 566</span></a>        <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-567"><a href="#StarData-567"><span class="linenos"> 567</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="StarData-568"><a href="#StarData-568"><span class="linenos"> 568</span></a>                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
</span><span id="StarData-569"><a href="#StarData-569"><span class="linenos"> 569</span></a>                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
</span><span id="StarData-570"><a href="#StarData-570"><span class="linenos"> 570</span></a>        <span class="p">])</span>
</span><span id="StarData-571"><a href="#StarData-571"><span class="linenos"> 571</span></a>        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">minor</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">major</span><span class="p">])</span>
</span><span id="StarData-572"><a href="#StarData-572"><span class="linenos"> 572</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_B</span> <span class="o">=</span> <span class="n">R</span><span class="nd">@D@D@R</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># beam matrix: (v-w)^T B (v-w) &lt; 1 means v is within beam centred at w</span>
</span><span id="StarData-573"><a href="#StarData-573"><span class="linenos"> 573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pixels_in_beam</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
</span><span id="StarData-574"><a href="#StarData-574"><span class="linenos"> 574</span></a>
</span><span id="StarData-575"><a href="#StarData-575"><span class="linenos"> 575</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__pixels_in_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">major</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
</span><span id="StarData-576"><a href="#StarData-576"><span class="linenos"> 576</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-577"><a href="#StarData-577"><span class="linenos"> 577</span></a><span class="sd">        Determine which pixel offsets are inside or on the boundary of the beam ellipse.</span>
</span><span id="StarData-578"><a href="#StarData-578"><span class="linenos"> 578</span></a>
</span><span id="StarData-579"><a href="#StarData-579"><span class="linenos"> 579</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-580"><a href="#StarData-580"><span class="linenos"> 580</span></a><span class="sd">        ----------</span>
</span><span id="StarData-581"><a href="#StarData-581"><span class="linenos"> 581</span></a><span class="sd">        major : float</span>
</span><span id="StarData-582"><a href="#StarData-582"><span class="linenos"> 582</span></a><span class="sd">            Length of the major axis of the ellipse, in degrees.</span>
</span><span id="StarData-583"><a href="#StarData-583"><span class="linenos"> 583</span></a>
</span><span id="StarData-584"><a href="#StarData-584"><span class="linenos"> 584</span></a><span class="sd">        Returns</span>
</span><span id="StarData-585"><a href="#StarData-585"><span class="linenos"> 585</span></a><span class="sd">        -------</span>
</span><span id="StarData-586"><a href="#StarData-586"><span class="linenos"> 586</span></a><span class="sd">        pixels_in_beam : list of tuple of int</span>
</span><span id="StarData-587"><a href="#StarData-587"><span class="linenos"> 587</span></a><span class="sd">            List of (x, y) offsets inside the beam ellipse, relative to the center.</span>
</span><span id="StarData-588"><a href="#StarData-588"><span class="linenos"> 588</span></a><span class="sd">        pixels_on_bdry : list of tuple of int</span>
</span><span id="StarData-589"><a href="#StarData-589"><span class="linenos"> 589</span></a><span class="sd">            List of (x, y) offsets on the boundary of the beam ellipse, relative to the center.</span>
</span><span id="StarData-590"><a href="#StarData-590"><span class="linenos"> 590</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-591"><a href="#StarData-591"><span class="linenos"> 591</span></a>        <span class="n">delta_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-592"><a href="#StarData-592"><span class="linenos"> 592</span></a>        <span class="n">delta_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-593"><a href="#StarData-593"><span class="linenos"> 593</span></a>
</span><span id="StarData-594"><a href="#StarData-594"><span class="linenos"> 594</span></a>        <span class="n">bound_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">major</span><span class="o">/</span><span class="n">delta_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># square to bound search in x direction</span>
</span><span id="StarData-595"><a href="#StarData-595"><span class="linenos"> 595</span></a>        <span class="n">bound_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">major</span><span class="o">/</span><span class="n">delta_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># y direction</span>
</span><span id="StarData-596"><a href="#StarData-596"><span class="linenos"> 596</span></a>
</span><span id="StarData-597"><a href="#StarData-597"><span class="linenos"> 597</span></a>        <span class="n">pixels_on_bdry</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StarData-598"><a href="#StarData-598"><span class="linenos"> 598</span></a>        <span class="n">pixels_in_beam</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StarData-599"><a href="#StarData-599"><span class="linenos"> 599</span></a>
</span><span id="StarData-600"><a href="#StarData-600"><span class="linenos"> 600</span></a>        <span class="k">for</span> <span class="n">x_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">bound_x</span><span class="p">,</span> <span class="n">bound_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="StarData-601"><a href="#StarData-601"><span class="linenos"> 601</span></a>            <span class="k">for</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">bound_y</span><span class="p">,</span> <span class="n">bound_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="StarData-602"><a href="#StarData-602"><span class="linenos"> 602</span></a>
</span><span id="StarData-603"><a href="#StarData-603"><span class="linenos"> 603</span></a>                <span class="c1"># get position and elliptic distance from origin</span>
</span><span id="StarData-604"><a href="#StarData-604"><span class="linenos"> 604</span></a>                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delta_x</span><span class="o">*</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">delta_y</span><span class="o">*</span><span class="n">y_offset</span><span class="p">])</span>
</span><span id="StarData-605"><a href="#StarData-605"><span class="linenos"> 605</span></a>                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="n">pos</span><span class="p">)</span>
</span><span id="StarData-606"><a href="#StarData-606"><span class="linenos"> 606</span></a>
</span><span id="StarData-607"><a href="#StarData-607"><span class="linenos"> 607</span></a>                <span class="c1"># determine if on boundary or inside ellipse</span>
</span><span id="StarData-608"><a href="#StarData-608"><span class="linenos"> 608</span></a>                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="mf">1.2</span><span class="p">:</span>
</span><span id="StarData-609"><a href="#StarData-609"><span class="linenos"> 609</span></a>                    <span class="n">pixels_on_bdry</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">))</span>
</span><span id="StarData-610"><a href="#StarData-610"><span class="linenos"> 610</span></a>                <span class="k">elif</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="StarData-611"><a href="#StarData-611"><span class="linenos"> 611</span></a>                    <span class="n">pixels_in_beam</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">))</span>
</span><span id="StarData-612"><a href="#StarData-612"><span class="linenos"> 612</span></a>
</span><span id="StarData-613"><a href="#StarData-613"><span class="linenos"> 613</span></a>        <span class="k">return</span> <span class="n">pixels_in_beam</span><span class="p">,</span> <span class="n">pixels_on_bdry</span>
</span><span id="StarData-614"><a href="#StarData-614"><span class="linenos"> 614</span></a>    
</span><span id="StarData-615"><a href="#StarData-615"><span class="linenos"> 615</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_header_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData-616"><a href="#StarData-616"><span class="linenos"> 616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-617"><a href="#StarData-617"><span class="linenos"> 617</span></a><span class="sd">        Get coordinate values from the FITS header for RA, DEC, or FREQ axes.</span>
</span><span id="StarData-618"><a href="#StarData-618"><span class="linenos"> 618</span></a>
</span><span id="StarData-619"><a href="#StarData-619"><span class="linenos"> 619</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-620"><a href="#StarData-620"><span class="linenos"> 620</span></a><span class="sd">        ----------</span>
</span><span id="StarData-621"><a href="#StarData-621"><span class="linenos"> 621</span></a><span class="sd">        num : {1, 2, 3}</span>
</span><span id="StarData-622"><a href="#StarData-622"><span class="linenos"> 622</span></a><span class="sd">            Axis number: 1 for RA, 2 for DEC, 3 for FREQ.</span>
</span><span id="StarData-623"><a href="#StarData-623"><span class="linenos"> 623</span></a>
</span><span id="StarData-624"><a href="#StarData-624"><span class="linenos"> 624</span></a><span class="sd">        Returns</span>
</span><span id="StarData-625"><a href="#StarData-625"><span class="linenos"> 625</span></a><span class="sd">        -------</span>
</span><span id="StarData-626"><a href="#StarData-626"><span class="linenos"> 626</span></a><span class="sd">        vals : DataArray1D</span>
</span><span id="StarData-627"><a href="#StarData-627"><span class="linenos"> 627</span></a><span class="sd">            1-D array of coordinate values for the specified axis, computed from the header.</span>
</span><span id="StarData-628"><a href="#StarData-628"><span class="linenos"> 628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-629"><a href="#StarData-629"><span class="linenos"> 629</span></a>        <span class="n">vals_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-630"><a href="#StarData-630"><span class="linenos"> 630</span></a>        <span class="n">vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vals_length</span><span class="p">)</span>
</span><span id="StarData-631"><a href="#StarData-631"><span class="linenos"> 631</span></a>        <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-632"><a href="#StarData-632"><span class="linenos"> 632</span></a>        <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-633"><a href="#StarData-633"><span class="linenos"> 633</span></a>        <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;CDELT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
</span><span id="StarData-634"><a href="#StarData-634"><span class="linenos"> 634</span></a>
</span><span id="StarData-635"><a href="#StarData-635"><span class="linenos"> 635</span></a>        <span class="c1"># vals[i] should be delta*(i - x0) + y0, for 1-indexing. but we are 0-indexed</span>
</span><span id="StarData-636"><a href="#StarData-636"><span class="linenos"> 636</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span>
</span><span id="StarData-637"><a href="#StarData-637"><span class="linenos"> 637</span></a>            <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y0</span>
</span><span id="StarData-638"><a href="#StarData-638"><span class="linenos"> 638</span></a>
</span><span id="StarData-639"><a href="#StarData-639"><span class="linenos"> 639</span></a>        <span class="k">return</span> <span class="n">vals</span>
</span><span id="StarData-640"><a href="#StarData-640"><span class="linenos"> 640</span></a>
</span><span id="StarData-641"><a href="#StarData-641"><span class="linenos"> 641</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__mean_and_std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="StarData-642"><a href="#StarData-642"><span class="linenos"> 642</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-643"><a href="#StarData-643"><span class="linenos"> 643</span></a><span class="sd">        Calculate the mean and standard deviation of the background noise, by looking at points away from the center.</span>
</span><span id="StarData-644"><a href="#StarData-644"><span class="linenos"> 644</span></a>
</span><span id="StarData-645"><a href="#StarData-645"><span class="linenos"> 645</span></a><span class="sd">        Returns</span>
</span><span id="StarData-646"><a href="#StarData-646"><span class="linenos"> 646</span></a><span class="sd">        -------</span>
</span><span id="StarData-647"><a href="#StarData-647"><span class="linenos"> 647</span></a><span class="sd">        mean : float</span>
</span><span id="StarData-648"><a href="#StarData-648"><span class="linenos"> 648</span></a><span class="sd">            Mean intensity of the background noise.</span>
</span><span id="StarData-649"><a href="#StarData-649"><span class="linenos"> 649</span></a><span class="sd">        std : float</span>
</span><span id="StarData-650"><a href="#StarData-650"><span class="linenos"> 650</span></a><span class="sd">            Standard deviation of the background noise.</span>
</span><span id="StarData-651"><a href="#StarData-651"><span class="linenos"> 651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-652"><a href="#StarData-652"><span class="linenos"> 652</span></a>        <span class="c1"># trim, as edges can be unreliable</span>
</span><span id="StarData-653"><a href="#StarData-653"><span class="linenos"> 653</span></a>        <span class="n">outer_trim</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># remove outer 1/20th</span>
</span><span id="StarData-654"><a href="#StarData-654"><span class="linenos"> 654</span></a>
</span><span id="StarData-655"><a href="#StarData-655"><span class="linenos"> 655</span></a>        <span class="n">frames</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">x_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="StarData-656"><a href="#StarData-656"><span class="linenos"> 656</span></a>        <span class="n">trimmed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">:</span><span class="n">x_obs</span> <span class="o">-</span> <span class="n">x_obs</span><span class="o">//</span><span class="n">outer_trim</span><span class="p">]</span>
</span><span id="StarData-657"><a href="#StarData-657"><span class="linenos"> 657</span></a>        <span class="n">frames</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">x_obs</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="StarData-658"><a href="#StarData-658"><span class="linenos"> 658</span></a>        
</span><span id="StarData-659"><a href="#StarData-659"><span class="linenos"> 659</span></a>
</span><span id="StarData-660"><a href="#StarData-660"><span class="linenos"> 660</span></a>        <span class="c1"># take edges of trimmed data</span>
</span><span id="StarData-661"><a href="#StarData-661"><span class="linenos"> 661</span></a>        <span class="n">inner_trim</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># take outer 1/5 th</span>
</span><span id="StarData-662"><a href="#StarData-662"><span class="linenos"> 662</span></a>        <span class="n">left_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-663"><a href="#StarData-663"><span class="linenos"> 663</span></a>        <span class="n">right_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-664"><a href="#StarData-664"><span class="linenos"> 664</span></a>        <span class="n">top_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-665"><a href="#StarData-665"><span class="linenos"> 665</span></a>        <span class="n">bottom_close</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[:</span><span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">-</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-666"><a href="#StarData-666"><span class="linenos"> 666</span></a>        
</span><span id="StarData-667"><a href="#StarData-667"><span class="linenos"> 667</span></a>        <span class="n">left_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:</span><span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-668"><a href="#StarData-668"><span class="linenos"> 668</span></a>        <span class="n">right_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-669"><a href="#StarData-669"><span class="linenos"> 669</span></a>        <span class="n">top_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="p">:</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-670"><a href="#StarData-670"><span class="linenos"> 670</span></a>        <span class="n">bottom_far</span> <span class="o">=</span> <span class="n">trimmed_data</span><span class="p">[</span><span class="n">frames</span> <span class="o">-</span> <span class="n">frames</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:,</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:</span><span class="n">y_obs</span> <span class="o">-</span> <span class="n">y_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">,</span> <span class="n">x_obs</span><span class="o">-</span><span class="n">x_obs</span><span class="o">//</span><span class="n">inner_trim</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="StarData-671"><a href="#StarData-671"><span class="linenos"> 671</span></a>
</span><span id="StarData-672"><a href="#StarData-672"><span class="linenos"> 672</span></a>
</span><span id="StarData-673"><a href="#StarData-673"><span class="linenos"> 673</span></a>        <span class="n">ring</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">left_close</span><span class="p">,</span> <span class="n">right_close</span><span class="p">,</span> <span class="n">top_close</span><span class="p">,</span> <span class="n">bottom_close</span><span class="p">,</span> <span class="n">left_far</span><span class="p">,</span> <span class="n">right_far</span><span class="p">,</span> <span class="n">top_far</span><span class="p">,</span> <span class="n">bottom_far</span><span class="p">))</span>
</span><span id="StarData-674"><a href="#StarData-674"><span class="linenos"> 674</span></a>        <span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ring</span><span class="p">)]</span>
</span><span id="StarData-675"><a href="#StarData-675"><span class="linenos"> 675</span></a>
</span><span id="StarData-676"><a href="#StarData-676"><span class="linenos"> 676</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
</span><span id="StarData-677"><a href="#StarData-677"><span class="linenos"> 677</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Only {len(ring)} data points selected for finding mean and standard deviation of noise.&quot;</span><span class="p">)</span>
</span><span id="StarData-678"><a href="#StarData-678"><span class="linenos"> 678</span></a>
</span><span id="StarData-679"><a href="#StarData-679"><span class="linenos"> 679</span></a>        <span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
</span><span id="StarData-680"><a href="#StarData-680"><span class="linenos"> 680</span></a>        <span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
</span><span id="StarData-681"><a href="#StarData-681"><span class="linenos"> 681</span></a>
</span><span id="StarData-682"><a href="#StarData-682"><span class="linenos"> 682</span></a>        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span>
</span><span id="StarData-683"><a href="#StarData-683"><span class="linenos"> 683</span></a>
</span><span id="StarData-684"><a href="#StarData-684"><span class="linenos"> 684</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__multiply_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="StarData-685"><a href="#StarData-685"><span class="linenos"> 685</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-686"><a href="#StarData-686"><span class="linenos"> 686</span></a><span class="sd">        Generate a list of pixel offsets that represent the beam, scaled by a factor.</span>
</span><span id="StarData-687"><a href="#StarData-687"><span class="linenos"> 687</span></a>
</span><span id="StarData-688"><a href="#StarData-688"><span class="linenos"> 688</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-689"><a href="#StarData-689"><span class="linenos"> 689</span></a><span class="sd">        ----------</span>
</span><span id="StarData-690"><a href="#StarData-690"><span class="linenos"> 690</span></a><span class="sd">        times : float or int</span>
</span><span id="StarData-691"><a href="#StarData-691"><span class="linenos"> 691</span></a><span class="sd">            Scaling factor for the beam size.</span>
</span><span id="StarData-692"><a href="#StarData-692"><span class="linenos"> 692</span></a>
</span><span id="StarData-693"><a href="#StarData-693"><span class="linenos"> 693</span></a><span class="sd">        Returns</span>
</span><span id="StarData-694"><a href="#StarData-694"><span class="linenos"> 694</span></a><span class="sd">        -------</span>
</span><span id="StarData-695"><a href="#StarData-695"><span class="linenos"> 695</span></a><span class="sd">        insides : list of tuple of int</span>
</span><span id="StarData-696"><a href="#StarData-696"><span class="linenos"> 696</span></a><span class="sd">            List of (x, y) offsets inside the scaled beam.</span>
</span><span id="StarData-697"><a href="#StarData-697"><span class="linenos"> 697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-698"><a href="#StarData-698"><span class="linenos"> 698</span></a>        <span class="k">if</span> <span class="n">times</span> <span class="o">&lt;=</span> <span class="mf">0.0001</span><span class="p">:</span>
</span><span id="StarData-699"><a href="#StarData-699"><span class="linenos"> 699</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="StarData-700"><a href="#StarData-700"><span class="linenos"> 700</span></a>        <span class="n">insides</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StarData-701"><a href="#StarData-701"><span class="linenos"> 701</span></a>        <span class="n">beam_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">]))</span>
</span><span id="StarData-702"><a href="#StarData-702"><span class="linenos"> 702</span></a>        
</span><span id="StarData-703"><a href="#StarData-703"><span class="linenos"> 703</span></a>        <span class="c1"># search a square around the origin</span>
</span><span id="StarData-704"><a href="#StarData-704"><span class="linenos"> 704</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="StarData-705"><a href="#StarData-705"><span class="linenos"> 705</span></a>            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">beam_bound</span><span class="o">*</span><span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="StarData-706"><a href="#StarData-706"><span class="linenos"> 706</span></a>
</span><span id="StarData-707"><a href="#StarData-707"><span class="linenos"> 707</span></a>                <span class="c1"># check if point would shrink into beam</span>
</span><span id="StarData-708"><a href="#StarData-708"><span class="linenos"> 708</span></a>                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">times</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">times</span><span class="p">))</span>
</span><span id="StarData-709"><a href="#StarData-709"><span class="linenos"> 709</span></a>                <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">:</span>
</span><span id="StarData-710"><a href="#StarData-710"><span class="linenos"> 710</span></a>                    <span class="n">insides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span id="StarData-711"><a href="#StarData-711"><span class="linenos"> 711</span></a>
</span><span id="StarData-712"><a href="#StarData-712"><span class="linenos"> 712</span></a>        <span class="k">return</span> <span class="n">insides</span>
</span><span id="StarData-713"><a href="#StarData-713"><span class="linenos"> 713</span></a>
</span><span id="StarData-714"><a href="#StarData-714"><span class="linenos"> 714</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_centre_intensities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_widths</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData-715"><a href="#StarData-715"><span class="linenos"> 715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-716"><a href="#StarData-716"><span class="linenos"> 716</span></a><span class="sd">        Calculate the mean intensity at the center of each velocity channel, averaged over a region the size of the beam.</span>
</span><span id="StarData-717"><a href="#StarData-717"><span class="linenos"> 717</span></a>
</span><span id="StarData-718"><a href="#StarData-718"><span class="linenos"> 718</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-719"><a href="#StarData-719"><span class="linenos"> 719</span></a><span class="sd">        ----------</span>
</span><span id="StarData-720"><a href="#StarData-720"><span class="linenos"> 720</span></a><span class="sd">        beam_widths : float or int, optional</span>
</span><span id="StarData-721"><a href="#StarData-721"><span class="linenos"> 721</span></a><span class="sd">            Scale factor of beam (default is 1).</span>
</span><span id="StarData-722"><a href="#StarData-722"><span class="linenos"> 722</span></a>
</span><span id="StarData-723"><a href="#StarData-723"><span class="linenos"> 723</span></a><span class="sd">        Returns</span>
</span><span id="StarData-724"><a href="#StarData-724"><span class="linenos"> 724</span></a><span class="sd">        -------</span>
</span><span id="StarData-725"><a href="#StarData-725"><span class="linenos"> 725</span></a><span class="sd">        all_densities : DataArray1D</span>
</span><span id="StarData-726"><a href="#StarData-726"><span class="linenos"> 726</span></a><span class="sd">            Array of mean intensities for each velocity channel.</span>
</span><span id="StarData-727"><a href="#StarData-727"><span class="linenos"> 727</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-728"><a href="#StarData-728"><span class="linenos"> 728</span></a>        <span class="c1"># centre index</span>
</span><span id="StarData-729"><a href="#StarData-729"><span class="linenos"> 729</span></a>        <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-730"><a href="#StarData-730"><span class="linenos"> 730</span></a>        <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-731"><a href="#StarData-731"><span class="linenos"> 731</span></a>        <span class="n">beam_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_beam</span><span class="p">(</span><span class="n">beam_widths</span><span class="p">)</span>
</span><span id="StarData-732"><a href="#StarData-732"><span class="linenos"> 732</span></a>        <span class="n">density_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StarData-733"><a href="#StarData-733"><span class="linenos"> 733</span></a>
</span><span id="StarData-734"><a href="#StarData-734"><span class="linenos"> 734</span></a>        <span class="c1"># compute average density</span>
</span><span id="StarData-735"><a href="#StarData-735"><span class="linenos"> 735</span></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
</span><span id="StarData-736"><a href="#StarData-736"><span class="linenos"> 736</span></a>            <span class="n">total</span> <span class="o">=</span>  <span class="mi">0</span>
</span><span id="StarData-737"><a href="#StarData-737"><span class="linenos"> 737</span></a>            <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="n">beam_pixels</span><span class="p">:</span>
</span><span id="StarData-738"><a href="#StarData-738"><span class="linenos"> 738</span></a>                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</span><span id="StarData-739"><a href="#StarData-739"><span class="linenos"> 739</span></a>                    <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span>
</span><span id="StarData-740"><a href="#StarData-740"><span class="linenos"> 740</span></a>                <span class="k">if</span> <span class="n">intensity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intensity</span><span class="p">):</span>
</span><span id="StarData-741"><a href="#StarData-741"><span class="linenos"> 741</span></a>                    <span class="n">total</span> <span class="o">+=</span> <span class="n">intensity</span>
</span><span id="StarData-742"><a href="#StarData-742"><span class="linenos"> 742</span></a>            <span class="n">density_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">beam_pixels</span><span class="p">))</span>
</span><span id="StarData-743"><a href="#StarData-743"><span class="linenos"> 743</span></a>
</span><span id="StarData-744"><a href="#StarData-744"><span class="linenos"> 744</span></a>        <span class="n">all_densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
</span><span id="StarData-745"><a href="#StarData-745"><span class="linenos"> 745</span></a>        <span class="k">return</span> <span class="n">all_densities</span>
</span><span id="StarData-746"><a href="#StarData-746"><span class="linenos"> 746</span></a>
</span><span id="StarData-747"><a href="#StarData-747"><span class="linenos"> 747</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_star_and_exp_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="StarData-748"><a href="#StarData-748"><span class="linenos"> 748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-749"><a href="#StarData-749"><span class="linenos"> 749</span></a><span class="sd">        Computes the systemic and expansion velocities, in km/s, by fitting a parabola to the centre intensities.</span>
</span><span id="StarData-750"><a href="#StarData-750"><span class="linenos"> 750</span></a>
</span><span id="StarData-751"><a href="#StarData-751"><span class="linenos"> 751</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-752"><a href="#StarData-752"><span class="linenos"> 752</span></a><span class="sd">        ----------</span>
</span><span id="StarData-753"><a href="#StarData-753"><span class="linenos"> 753</span></a><span class="sd">        vel_range : DataArray1D</span>
</span><span id="StarData-754"><a href="#StarData-754"><span class="linenos"> 754</span></a><span class="sd">            1-D array of channel velocities in km/s.</span>
</span><span id="StarData-755"><a href="#StarData-755"><span class="linenos"> 755</span></a><span class="sd">        plot : bool, optional</span>
</span><span id="StarData-756"><a href="#StarData-756"><span class="linenos"> 756</span></a><span class="sd">            If True, plot the iterative process (default is False).</span>
</span><span id="StarData-757"><a href="#StarData-757"><span class="linenos"> 757</span></a><span class="sd">        fit_parabola : bool, optional</span>
</span><span id="StarData-758"><a href="#StarData-758"><span class="linenos"> 758</span></a><span class="sd">            If True, plot a fitted parabola (default is False).</span>
</span><span id="StarData-759"><a href="#StarData-759"><span class="linenos"> 759</span></a><span class="sd">        v_sys : float or None, optional</span>
</span><span id="StarData-760"><a href="#StarData-760"><span class="linenos"> 760</span></a><span class="sd">            If provided, use this as the systemic velocity (default is None).</span>
</span><span id="StarData-761"><a href="#StarData-761"><span class="linenos"> 761</span></a><span class="sd">        v_exp : float or None, optional</span>
</span><span id="StarData-762"><a href="#StarData-762"><span class="linenos"> 762</span></a><span class="sd">            If provided, use this as the expansion velocity (default is None).</span>
</span><span id="StarData-763"><a href="#StarData-763"><span class="linenos"> 763</span></a>
</span><span id="StarData-764"><a href="#StarData-764"><span class="linenos"> 764</span></a><span class="sd">        Returns</span>
</span><span id="StarData-765"><a href="#StarData-765"><span class="linenos"> 765</span></a><span class="sd">        -------</span>
</span><span id="StarData-766"><a href="#StarData-766"><span class="linenos"> 766</span></a><span class="sd">        v_sys : float</span>
</span><span id="StarData-767"><a href="#StarData-767"><span class="linenos"> 767</span></a><span class="sd">            Systemic velocity in km/s.</span>
</span><span id="StarData-768"><a href="#StarData-768"><span class="linenos"> 768</span></a><span class="sd">        v_exp : float</span>
</span><span id="StarData-769"><a href="#StarData-769"><span class="linenos"> 769</span></a><span class="sd">            Expansion velocity in km/s.</span>
</span><span id="StarData-770"><a href="#StarData-770"><span class="linenos"> 770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-771"><a href="#StarData-771"><span class="linenos"> 771</span></a>        <span class="n">given_v_sys</span> <span class="o">=</span> <span class="n">v_sys</span>
</span><span id="StarData-772"><a href="#StarData-772"><span class="linenos"> 772</span></a>        <span class="n">given_v_exp</span> <span class="o">=</span> <span class="n">v_exp</span>
</span><span id="StarData-773"><a href="#StarData-773"><span class="linenos"> 773</span></a>        <span class="k">if</span> <span class="n">given_v_exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">given_v_sys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-774"><a href="#StarData-774"><span class="linenos"> 774</span></a>            <span class="k">return</span> <span class="n">given_v_sys</span><span class="p">,</span> <span class="n">given_v_exp</span>
</span><span id="StarData-775"><a href="#StarData-775"><span class="linenos"> 775</span></a>
</span><span id="StarData-776"><a href="#StarData-776"><span class="linenos"> 776</span></a>        <span class="n">all_densities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_centre_intensities</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-777"><a href="#StarData-777"><span class="linenos"> 777</span></a>        
</span><span id="StarData-778"><a href="#StarData-778"><span class="linenos"> 778</span></a>        
</span><span id="StarData-779"><a href="#StarData-779"><span class="linenos"> 779</span></a>        <span class="n">v_exp_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="StarData-780"><a href="#StarData-780"><span class="linenos"> 780</span></a>        <span class="n">v_sys_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="StarData-781"><a href="#StarData-781"><span class="linenos"> 781</span></a>
</span><span id="StarData-782"><a href="#StarData-782"><span class="linenos"> 782</span></a>        <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StarData-783"><a href="#StarData-783"><span class="linenos"> 783</span></a>        <span class="n">densities</span> <span class="o">=</span> <span class="n">all_densities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData-784"><a href="#StarData-784"><span class="linenos"> 784</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="StarData-785"><a href="#StarData-785"><span class="linenos"> 785</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>  <span class="c1"># loop until computation converges</span>
</span><span id="StarData-786"><a href="#StarData-786"><span class="linenos"> 786</span></a>            <span class="n">densities</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">densities</span><span class="p">)</span> <span class="c1"># normalise</span>
</span><span id="StarData-787"><a href="#StarData-787"><span class="linenos"> 787</span></a>            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="StarData-788"><a href="#StarData-788"><span class="linenos"> 788</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StarData-789"><a href="#StarData-789"><span class="linenos"> 789</span></a>            <span class="n">v_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">given_v_sys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">given_v_sys</span>
</span><span id="StarData-790"><a href="#StarData-790"><span class="linenos"> 790</span></a>
</span><span id="StarData-791"><a href="#StarData-791"><span class="linenos"> 791</span></a>            <span class="n">v_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">vel_range</span> <span class="o">-</span> <span class="n">v_sys</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">densities</span><span class="p">))</span> <span class="k">if</span> <span class="n">given_v_exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">given_v_exp</span>
</span><span id="StarData-792"><a href="#StarData-792"><span class="linenos"> 792</span></a>            
</span><span id="StarData-793"><a href="#StarData-793"><span class="linenos"> 793</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v_exp_seen</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v_sys_seen</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">)):</span>
</span><span id="StarData-794"><a href="#StarData-794"><span class="linenos"> 794</span></a>                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData-795"><a href="#StarData-795"><span class="linenos"> 795</span></a>            <span class="n">v_exp_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_exp_seen</span><span class="p">,</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData-796"><a href="#StarData-796"><span class="linenos"> 796</span></a>            <span class="n">v_sys_seen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_sys_seen</span><span class="p">,</span> <span class="n">v_sys</span><span class="p">)</span>
</span><span id="StarData-797"><a href="#StarData-797"><span class="linenos"> 797</span></a>
</span><span id="StarData-798"><a href="#StarData-798"><span class="linenos"> 798</span></a>            <span class="n">densities</span> <span class="o">=</span> <span class="n">all_densities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData-799"><a href="#StarData-799"><span class="linenos"> 799</span></a>            <span class="n">densities</span><span class="p">[</span><span class="n">vel_range</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">v_sys</span> <span class="o">-</span> <span class="n">v_exp</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-800"><a href="#StarData-800"><span class="linenos"> 800</span></a>            <span class="n">densities</span><span class="p">[</span><span class="n">vel_range</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">v_sys</span> <span class="o">+</span> <span class="n">v_exp</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-801"><a href="#StarData-801"><span class="linenos"> 801</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="StarData-802"><a href="#StarData-802"><span class="linenos"> 802</span></a>
</span><span id="StarData-803"><a href="#StarData-803"><span class="linenos"> 803</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="StarData-804"><a href="#StarData-804"><span class="linenos"> 804</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Systemic and expansion velocity computation did not converge after 100 iterations.&quot;</span><span class="p">)</span>
</span><span id="StarData-805"><a href="#StarData-805"><span class="linenos"> 805</span></a>                <span class="k">break</span>
</span><span id="StarData-806"><a href="#StarData-806"><span class="linenos"> 806</span></a>
</span><span id="StarData-807"><a href="#StarData-807"><span class="linenos"> 807</span></a>        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">fit_parabola</span><span class="p">:</span>
</span><span id="StarData-808"><a href="#StarData-808"><span class="linenos"> 808</span></a>            <span class="n">parabola</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span><span class="p">((</span><span class="n">vel_range</span> <span class="o">-</span> <span class="n">v_sys</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">v_exp</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="StarData-809"><a href="#StarData-809"><span class="linenos"> 809</span></a>            <span class="n">parabola</span><span class="p">[</span><span class="n">parabola</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-810"><a href="#StarData-810"><span class="linenos"> 810</span></a>            <span class="n">parabola</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">parabola</span><span class="p">)</span>
</span><span id="StarData-811"><a href="#StarData-811"><span class="linenos"> 811</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel_range</span><span class="p">,</span> <span class="n">parabola</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;parabola&quot;</span><span class="p">)</span>
</span><span id="StarData-812"><a href="#StarData-812"><span class="linenos"> 812</span></a>
</span><span id="StarData-813"><a href="#StarData-813"><span class="linenos"> 813</span></a>        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="StarData-814"><a href="#StarData-814"><span class="linenos"> 814</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Determining v_sys, v_exp&quot;</span><span class="p">)</span>
</span><span id="StarData-815"><a href="#StarData-815"><span class="linenos"> 815</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Relative velocity (km/s)&quot;</span><span class="p">)</span>
</span><span id="StarData-816"><a href="#StarData-816"><span class="linenos"> 816</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at centre point (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="StarData-817"><a href="#StarData-817"><span class="linenos"> 817</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="StarData-818"><a href="#StarData-818"><span class="linenos"> 818</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-819"><a href="#StarData-819"><span class="linenos"> 819</span></a>        
</span><span id="StarData-820"><a href="#StarData-820"><span class="linenos"> 820</span></a>        <span class="k">return</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span>
</span><span id="StarData-821"><a href="#StarData-821"><span class="linenos"> 821</span></a>
</span><span id="StarData-822"><a href="#StarData-822"><span class="linenos"> 822</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_beta_law</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_intensities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_velocities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_beta_law</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="StarData-823"><a href="#StarData-823"><span class="linenos"> 823</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-824"><a href="#StarData-824"><span class="linenos"> 824</span></a><span class="sd">        Fit the beta velocity law to the data and return the dust formation radius, beta parameter, and the radius of maximum intensity change.</span>
</span><span id="StarData-825"><a href="#StarData-825"><span class="linenos"> 825</span></a>
</span><span id="StarData-826"><a href="#StarData-826"><span class="linenos"> 826</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-827"><a href="#StarData-827"><span class="linenos"> 827</span></a><span class="sd">        ----------</span>
</span><span id="StarData-828"><a href="#StarData-828"><span class="linenos"> 828</span></a><span class="sd">        plot_intensities : bool, optional</span>
</span><span id="StarData-829"><a href="#StarData-829"><span class="linenos"> 829</span></a><span class="sd">            If True, plot intensity vs. radius (default is False).</span>
</span><span id="StarData-830"><a href="#StarData-830"><span class="linenos"> 830</span></a><span class="sd">        plot_velocities : bool, optional</span>
</span><span id="StarData-831"><a href="#StarData-831"><span class="linenos"> 831</span></a><span class="sd">            If True, plot velocity vs. radius (default is False).</span>
</span><span id="StarData-832"><a href="#StarData-832"><span class="linenos"> 832</span></a><span class="sd">        plot_beta_law : bool, optional</span>
</span><span id="StarData-833"><a href="#StarData-833"><span class="linenos"> 833</span></a><span class="sd">            If True, plot the fitted beta law (default is False).</span>
</span><span id="StarData-834"><a href="#StarData-834"><span class="linenos"> 834</span></a>
</span><span id="StarData-835"><a href="#StarData-835"><span class="linenos"> 835</span></a><span class="sd">        Returns</span>
</span><span id="StarData-836"><a href="#StarData-836"><span class="linenos"> 836</span></a><span class="sd">        -------</span>
</span><span id="StarData-837"><a href="#StarData-837"><span class="linenos"> 837</span></a><span class="sd">        r_dust : float</span>
</span><span id="StarData-838"><a href="#StarData-838"><span class="linenos"> 838</span></a><span class="sd">            Dust formation radius.</span>
</span><span id="StarData-839"><a href="#StarData-839"><span class="linenos"> 839</span></a><span class="sd">        beta : float</span>
</span><span id="StarData-840"><a href="#StarData-840"><span class="linenos"> 840</span></a><span class="sd">            Beta parameter of the velocity law.</span>
</span><span id="StarData-841"><a href="#StarData-841"><span class="linenos"> 841</span></a><span class="sd">        radius : float</span>
</span><span id="StarData-842"><a href="#StarData-842"><span class="linenos"> 842</span></a><span class="sd">            Radius of maximum intensity change.</span>
</span><span id="StarData-843"><a href="#StarData-843"><span class="linenos"> 843</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-844"><a href="#StarData-844"><span class="linenos"> 844</span></a>        <span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_centre_intensities</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="StarData-845"><a href="#StarData-845"><span class="linenos"> 845</span></a>
</span><span id="StarData-846"><a href="#StarData-846"><span class="linenos"> 846</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">v_from_i</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="StarData-847"><a href="#StarData-847"><span class="linenos"> 847</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensities</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="StarData-848"><a href="#StarData-848"><span class="linenos"> 848</span></a>    
</span><span id="StarData-849"><a href="#StarData-849"><span class="linenos"> 849</span></a>        <span class="n">centre_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-850"><a href="#StarData-850"><span class="linenos"> 850</span></a>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">centre_idx</span><span class="p">]</span>
</span><span id="StarData-851"><a href="#StarData-851"><span class="linenos"> 851</span></a>        
</span><span id="StarData-852"><a href="#StarData-852"><span class="linenos"> 852</span></a>        <span class="n">max_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">))</span>
</span><span id="StarData-853"><a href="#StarData-853"><span class="linenos"> 853</span></a>        <span class="n">precision</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">))</span><span class="o">//</span><span class="mi">2</span>
</span><span id="StarData-854"><a href="#StarData-854"><span class="linenos"> 854</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
</span><span id="StarData-855"><a href="#StarData-855"><span class="linenos"> 855</span></a>        
</span><span id="StarData-856"><a href="#StarData-856"><span class="linenos"> 856</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="StarData-857"><a href="#StarData-857"><span class="linenos"> 857</span></a>
</span><span id="StarData-858"><a href="#StarData-858"><span class="linenos"> 858</span></a>        <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="StarData-859"><a href="#StarData-859"><span class="linenos"> 859</span></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>  <span class="c1"># average intensity in each ring</span>
</span><span id="StarData-860"><a href="#StarData-860"><span class="linenos"> 860</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="StarData-861"><a href="#StarData-861"><span class="linenos"> 861</span></a>            <span class="n">ring</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="o">&amp;</span>  <span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
</span><span id="StarData-862"><a href="#StarData-862"><span class="linenos"> 862</span></a>            <span class="n">avg_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ring</span><span class="p">)])</span> 
</span><span id="StarData-863"><a href="#StarData-863"><span class="linenos"> 863</span></a>            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">avg_intensity</span><span class="p">)</span>
</span><span id="StarData-864"><a href="#StarData-864"><span class="linenos"> 864</span></a>
</span><span id="StarData-865"><a href="#StarData-865"><span class="linenos"> 865</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
</span><span id="StarData-866"><a href="#StarData-866"><span class="linenos"> 866</span></a>            <span class="n">outer</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
</span><span id="StarData-867"><a href="#StarData-867"><span class="linenos"> 867</span></a>            <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deltas</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">inner</span><span class="p">[(</span><span class="n">inner</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outer</span><span class="p">[</span><span class="n">outer</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]))</span>
</span><span id="StarData-868"><a href="#StarData-868"><span class="linenos"> 868</span></a>
</span><span id="StarData-869"><a href="#StarData-869"><span class="linenos"> 869</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">v_from_i</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
</span><span id="StarData-870"><a href="#StarData-870"><span class="linenos"> 870</span></a>        <span class="n">V</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">V</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-871"><a href="#StarData-871"><span class="linenos"> 871</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="StarData-872"><a href="#StarData-872"><span class="linenos"> 872</span></a>        <span class="n">radius_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
</span><span id="StarData-873"><a href="#StarData-873"><span class="linenos"> 873</span></a>        <span class="n">radius</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">radius_index</span><span class="p">]</span>
</span><span id="StarData-874"><a href="#StarData-874"><span class="linenos"> 874</span></a>
</span><span id="StarData-875"><a href="#StarData-875"><span class="linenos"> 875</span></a>        <span class="k">if</span> <span class="n">plot_intensities</span><span class="p">:</span>
</span><span id="StarData-876"><a href="#StarData-876"><span class="linenos"> 876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;intensities&quot;</span><span class="p">)</span>
</span><span id="StarData-877"><a href="#StarData-877"><span class="linenos"> 877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
</span><span id="StarData-878"><a href="#StarData-878"><span class="linenos"> 878</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="StarData-879"><a href="#StarData-879"><span class="linenos"> 879</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Radius (AU)&quot;</span><span class="p">)</span>
</span><span id="StarData-880"><a href="#StarData-880"><span class="linenos"> 880</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BTYPE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="StarData-881"><a href="#StarData-881"><span class="linenos"> 881</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average intensity at each radius&quot;</span><span class="p">)</span>
</span><span id="StarData-882"><a href="#StarData-882"><span class="linenos"> 882</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-883"><a href="#StarData-883"><span class="linenos"> 883</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
</span><span id="StarData-884"><a href="#StarData-884"><span class="linenos"> 884</span></a>
</span><span id="StarData-885"><a href="#StarData-885"><span class="linenos"> 885</span></a>        <span class="n">v_fit</span> <span class="o">=</span> <span class="n">V</span><span class="p">[(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="StarData-886"><a href="#StarData-886"><span class="linenos"> 886</span></a>        <span class="n">r_fit</span> <span class="o">=</span> <span class="n">R</span><span class="p">[(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="StarData-887"><a href="#StarData-887"><span class="linenos"> 887</span></a>
</span><span id="StarData-888"><a href="#StarData-888"><span class="linenos"> 888</span></a>        <span class="k">if</span> <span class="n">plot_velocities</span><span class="p">:</span>
</span><span id="StarData-889"><a href="#StarData-889"><span class="linenos"> 889</span></a>            <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
</span><span id="StarData-890"><a href="#StarData-890"><span class="linenos"> 890</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-891"><a href="#StarData-891"><span class="linenos"> 891</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">,</span> <span class="n">r_fit</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-892"><a href="#StarData-892"><span class="linenos"> 892</span></a>            <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span>  <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="StarData-893"><a href="#StarData-893"><span class="linenos"> 893</span></a>
</span><span id="StarData-894"><a href="#StarData-894"><span class="linenos"> 894</span></a>        <span class="k">if</span> <span class="n">plot_velocities</span><span class="p">:</span>
</span><span id="StarData-895"><a href="#StarData-895"><span class="linenos"> 895</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;velocities&quot;</span><span class="p">)</span>
</span><span id="StarData-896"><a href="#StarData-896"><span class="linenos"> 896</span></a>            <span class="k">if</span> <span class="n">plot_beta_law</span><span class="p">:</span>
</span><span id="StarData-897"><a href="#StarData-897"><span class="linenos"> 897</span></a>                <span class="n">LAW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
</span><span id="StarData-898"><a href="#StarData-898"><span class="linenos"> 898</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">LAW</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;beta law&quot;</span><span class="p">)</span>
</span><span id="StarData-899"><a href="#StarData-899"><span class="linenos"> 899</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
</span><span id="StarData-900"><a href="#StarData-900"><span class="linenos"> 900</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="StarData-901"><a href="#StarData-901"><span class="linenos"> 901</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Radius (AU)&quot;</span><span class="p">)</span>
</span><span id="StarData-902"><a href="#StarData-902"><span class="linenos"> 902</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Velocity (km/s)&quot;</span><span class="p">)</span>
</span><span id="StarData-903"><a href="#StarData-903"><span class="linenos"> 903</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Velocity at each radius&quot;</span><span class="p">)</span>
</span><span id="StarData-904"><a href="#StarData-904"><span class="linenos"> 904</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-905"><a href="#StarData-905"><span class="linenos"> 905</span></a>        
</span><span id="StarData-906"><a href="#StarData-906"><span class="linenos"> 906</span></a>        <span class="k">return</span> <span class="n">r_dust</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">radius</span>
</span><span id="StarData-907"><a href="#StarData-907"><span class="linenos"> 907</span></a>
</span><span id="StarData-908"><a href="#StarData-908"><span class="linenos"> 908</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__general_beta_velocity_law</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">r_dust</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="StarData-909"><a href="#StarData-909"><span class="linenos"> 909</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-910"><a href="#StarData-910"><span class="linenos"> 910</span></a><span class="sd">        General beta velocity law.</span>
</span><span id="StarData-911"><a href="#StarData-911"><span class="linenos"> 911</span></a>
</span><span id="StarData-912"><a href="#StarData-912"><span class="linenos"> 912</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-913"><a href="#StarData-913"><span class="linenos"> 913</span></a><span class="sd">        ----------</span>
</span><span id="StarData-914"><a href="#StarData-914"><span class="linenos"> 914</span></a><span class="sd">        r : array_like</span>
</span><span id="StarData-915"><a href="#StarData-915"><span class="linenos"> 915</span></a><span class="sd">            Radius values.</span>
</span><span id="StarData-916"><a href="#StarData-916"><span class="linenos"> 916</span></a><span class="sd">        r_dust : float</span>
</span><span id="StarData-917"><a href="#StarData-917"><span class="linenos"> 917</span></a><span class="sd">            Dust formation radius.</span>
</span><span id="StarData-918"><a href="#StarData-918"><span class="linenos"> 918</span></a><span class="sd">        beta : float</span>
</span><span id="StarData-919"><a href="#StarData-919"><span class="linenos"> 919</span></a><span class="sd">            Beta parameter.</span>
</span><span id="StarData-920"><a href="#StarData-920"><span class="linenos"> 920</span></a>
</span><span id="StarData-921"><a href="#StarData-921"><span class="linenos"> 921</span></a><span class="sd">        Returns</span>
</span><span id="StarData-922"><a href="#StarData-922"><span class="linenos"> 922</span></a><span class="sd">        -------</span>
</span><span id="StarData-923"><a href="#StarData-923"><span class="linenos"> 923</span></a><span class="sd">        v : array_like</span>
</span><span id="StarData-924"><a href="#StarData-924"><span class="linenos"> 924</span></a><span class="sd">            Velocity at each radius.</span>
</span><span id="StarData-925"><a href="#StarData-925"><span class="linenos"> 925</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-926"><a href="#StarData-926"><span class="linenos"> 926</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">r_dust</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="n">beta</span><span class="p">)</span>
</span><span id="StarData-927"><a href="#StarData-927"><span class="linenos"> 927</span></a>    
</span><span id="StarData-928"><a href="#StarData-928"><span class="linenos"> 928</span></a>    <span class="c1"># ---- FILTERING DATA ----</span>
</span><span id="StarData-929"><a href="#StarData-929"><span class="linenos"> 929</span></a>
</span><span id="StarData-930"><a href="#StarData-930"><span class="linenos"> 930</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_filtered_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData-931"><a href="#StarData-931"><span class="linenos"> 931</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-932"><a href="#StarData-932"><span class="linenos"> 932</span></a><span class="sd">        Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</span>
</span><span id="StarData-933"><a href="#StarData-933"><span class="linenos"> 933</span></a>
</span><span id="StarData-934"><a href="#StarData-934"><span class="linenos"> 934</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-935"><a href="#StarData-935"><span class="linenos"> 935</span></a>
</span><span id="StarData-936"><a href="#StarData-936"><span class="linenos"> 936</span></a><span class="sd">        - `stds` (`float` or `int`, optional): Number of standard deviations to filter by (default is 5).</span>
</span><span id="StarData-937"><a href="#StarData-937"><span class="linenos"> 937</span></a>
</span><span id="StarData-938"><a href="#StarData-938"><span class="linenos"> 938</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData-939"><a href="#StarData-939"><span class="linenos"> 939</span></a>
</span><span id="StarData-940"><a href="#StarData-940"><span class="linenos"> 940</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): Filtered data array.</span>
</span><span id="StarData-941"><a href="#StarData-941"><span class="linenos"> 941</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-942"><a href="#StarData-942"><span class="linenos"> 942</span></a>        <span class="n">filtered_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># creates a deep copy</span>
</span><span id="StarData-943"><a href="#StarData-943"><span class="linenos"> 943</span></a>        <span class="n">filtered_data</span><span class="p">[</span><span class="n">filtered_data</span> <span class="o">&lt;</span> <span class="n">stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-944"><a href="#StarData-944"><span class="linenos"> 944</span></a>        <span class="k">return</span> <span class="n">filtered_data</span>
</span><span id="StarData-945"><a href="#StarData-945"><span class="linenos"> 945</span></a>    
</span><span id="StarData-946"><a href="#StarData-946"><span class="linenos"> 946</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtered_data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData-947"><a href="#StarData-947"><span class="linenos"> 947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-948"><a href="#StarData-948"><span class="linenos"> 948</span></a><span class="sd">        Remove clumps of points that fit inside the beam, setting these values to np.nan.</span>
</span><span id="StarData-949"><a href="#StarData-949"><span class="linenos"> 949</span></a>
</span><span id="StarData-950"><a href="#StarData-950"><span class="linenos"> 950</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-951"><a href="#StarData-951"><span class="linenos"> 951</span></a>
</span><span id="StarData-952"><a href="#StarData-952"><span class="linenos"> 952</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): 3-D array with the same dimensions as the data array.</span>
</span><span id="StarData-953"><a href="#StarData-953"><span class="linenos"> 953</span></a>
</span><span id="StarData-954"><a href="#StarData-954"><span class="linenos"> 954</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData-955"><a href="#StarData-955"><span class="linenos"> 955</span></a>
</span><span id="StarData-956"><a href="#StarData-956"><span class="linenos"> 956</span></a><span class="sd">        - `beam_filtered_data` (`DataArray3D`): 3-D array with small clumps of points removed.</span>
</span><span id="StarData-957"><a href="#StarData-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-958"><a href="#StarData-958"><span class="linenos"> 958</span></a>        <span class="n">beam_filtered_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData-959"><a href="#StarData-959"><span class="linenos"> 959</span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)):</span>
</span><span id="StarData-960"><a href="#StarData-960"><span class="linenos"> 960</span></a>            <span class="k">for</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">])):</span>
</span><span id="StarData-961"><a href="#StarData-961"><span class="linenos"> 961</span></a>                <span class="k">for</span> <span class="n">x_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">])):</span>
</span><span id="StarData-962"><a href="#StarData-962"><span class="linenos"> 962</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">][</span><span class="n">x_idx</span><span class="p">]):</span>  <span class="c1"># ignore empty points</span>
</span><span id="StarData-963"><a href="#StarData-963"><span class="linenos"> 963</span></a>                        <span class="k">continue</span>
</span><span id="StarData-964"><a href="#StarData-964"><span class="linenos"> 964</span></a>                    
</span><span id="StarData-965"><a href="#StarData-965"><span class="linenos"> 965</span></a>                    <span class="c1"># filled point that we are searching around</span>
</span><span id="StarData-966"><a href="#StarData-966"><span class="linenos"> 966</span></a>                
</span><span id="StarData-967"><a href="#StarData-967"><span class="linenos"> 967</span></a>                    <span class="n">erase</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData-968"><a href="#StarData-968"><span class="linenos"> 968</span></a>
</span><span id="StarData-969"><a href="#StarData-969"><span class="linenos"> 969</span></a>                    <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_offset</span><span class="p">:</span>
</span><span id="StarData-970"><a href="#StarData-970"><span class="linenos"> 970</span></a>                        <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="StarData-971"><a href="#StarData-971"><span class="linenos"> 971</span></a>                        <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="StarData-972"><a href="#StarData-972"><span class="linenos"> 972</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="StarData-973"><a href="#StarData-973"><span class="linenos"> 973</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]):</span>
</span><span id="StarData-974"><a href="#StarData-974"><span class="linenos"> 974</span></a>                                <span class="n">erase</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># there is something present on the border - saved!</span>
</span><span id="StarData-975"><a href="#StarData-975"><span class="linenos"> 975</span></a>                                <span class="k">break</span>
</span><span id="StarData-976"><a href="#StarData-976"><span class="linenos"> 976</span></a>                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># in case x_check, y_check are out of range</span>
</span><span id="StarData-977"><a href="#StarData-977"><span class="linenos"> 977</span></a>                            <span class="k">pass</span>
</span><span id="StarData-978"><a href="#StarData-978"><span class="linenos"> 978</span></a>
</span><span id="StarData-979"><a href="#StarData-979"><span class="linenos"> 979</span></a>                    <span class="k">if</span> <span class="n">erase</span><span class="p">:</span>  <span class="c1"># consider ellipse to be an anomaly</span>
</span><span id="StarData-980"><a href="#StarData-980"><span class="linenos"> 980</span></a>                        <span class="c1"># erase entire inside of ellipse centred at w</span>
</span><span id="StarData-981"><a href="#StarData-981"><span class="linenos"> 981</span></a>                        <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">:</span>
</span><span id="StarData-982"><a href="#StarData-982"><span class="linenos"> 982</span></a>                            <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="StarData-983"><a href="#StarData-983"><span class="linenos"> 983</span></a>                            <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="StarData-984"><a href="#StarData-984"><span class="linenos"> 984</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="StarData-985"><a href="#StarData-985"><span class="linenos"> 985</span></a>                                <span class="n">beam_filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># erase</span>
</span><span id="StarData-986"><a href="#StarData-986"><span class="linenos"> 986</span></a>                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="StarData-987"><a href="#StarData-987"><span class="linenos"> 987</span></a>                                <span class="k">pass</span>
</span><span id="StarData-988"><a href="#StarData-988"><span class="linenos"> 988</span></a>            
</span><span id="StarData-989"><a href="#StarData-989"><span class="linenos"> 989</span></a>        <span class="k">return</span> <span class="n">beam_filtered_data</span>
</span><span id="StarData-990"><a href="#StarData-990"><span class="linenos"> 990</span></a>
</span><span id="StarData-991"><a href="#StarData-991"><span class="linenos"> 991</span></a>    <span class="c1"># ---- HELPER METHODS FOR PLOTTING ----</span>
</span><span id="StarData-992"><a href="#StarData-992"><span class="linenos"> 992</span></a>
</span><span id="StarData-993"><a href="#StarData-993"><span class="linenos"> 993</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__crop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fill_data</span><span class="p">:</span> <span class="n">DataArray3D</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">special_v</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="StarData-994"><a href="#StarData-994"><span class="linenos"> 994</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-995"><a href="#StarData-995"><span class="linenos"> 995</span></a><span class="sd">        Crop the data arrays to the smallest region containing all valid (non-NaN) data.</span>
</span><span id="StarData-996"><a href="#StarData-996"><span class="linenos"> 996</span></a>
</span><span id="StarData-997"><a href="#StarData-997"><span class="linenos"> 997</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-998"><a href="#StarData-998"><span class="linenos"> 998</span></a><span class="sd">        ----------</span>
</span><span id="StarData-999"><a href="#StarData-999"><span class="linenos"> 999</span></a><span class="sd">        x, y, v : DataArray1D</span>
</span><span id="StarData-1000"><a href="#StarData-1000"><span class="linenos">1000</span></a><span class="sd">            Small coordinate arrays.</span>
</span><span id="StarData-1001"><a href="#StarData-1001"><span class="linenos">1001</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="StarData-1002"><a href="#StarData-1002"><span class="linenos">1002</span></a><span class="sd">            Data array to use for crop.</span>
</span><span id="StarData-1003"><a href="#StarData-1003"><span class="linenos">1003</span></a><span class="sd">        crop_leeway : int or float, optional</span>
</span><span id="StarData-1004"><a href="#StarData-1004"><span class="linenos">1004</span></a><span class="sd">            Fractional leeway to expand the crop region (default is 0).</span>
</span><span id="StarData-1005"><a href="#StarData-1005"><span class="linenos">1005</span></a><span class="sd">        fill_data : DataArray3D or None, optional</span>
</span><span id="StarData-1006"><a href="#StarData-1006"><span class="linenos">1006</span></a><span class="sd">            Data array to use for filling values (default is None).</span>
</span><span id="StarData-1007"><a href="#StarData-1007"><span class="linenos">1007</span></a>
</span><span id="StarData-1008"><a href="#StarData-1008"><span class="linenos">1008</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1009"><a href="#StarData-1009"><span class="linenos">1009</span></a><span class="sd">        -------</span>
</span><span id="StarData-1010"><a href="#StarData-1010"><span class="linenos">1010</span></a><span class="sd">        cropped_x, cropped_y, cropped_v : DataArray1D</span>
</span><span id="StarData-1011"><a href="#StarData-1011"><span class="linenos">1011</span></a><span class="sd">            Cropped coordinate arrays.</span>
</span><span id="StarData-1012"><a href="#StarData-1012"><span class="linenos">1012</span></a><span class="sd">        cropped_data : DataArray3D</span>
</span><span id="StarData-1013"><a href="#StarData-1013"><span class="linenos">1013</span></a><span class="sd">            Cropped data array.</span>
</span><span id="StarData-1014"><a href="#StarData-1014"><span class="linenos">1014</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1015"><a href="#StarData-1015"><span class="linenos">1015</span></a>        <span class="k">if</span> <span class="n">fill_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1016"><a href="#StarData-1016"><span class="linenos">1016</span></a>            <span class="n">fill_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData-1017"><a href="#StarData-1017"><span class="linenos">1017</span></a>        
</span><span id="StarData-1018"><a href="#StarData-1018"><span class="linenos">1018</span></a>        <span class="n">v_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="StarData-1019"><a href="#StarData-1019"><span class="linenos">1019</span></a>
</span><span id="StarData-1020"><a href="#StarData-1020"><span class="linenos">1020</span></a>        <span class="c1"># gets indices</span>
</span><span id="StarData-1021"><a href="#StarData-1021"><span class="linenos">1021</span></a>        <span class="n">v_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">v_max</span><span class="p">)</span>
</span><span id="StarData-1022"><a href="#StarData-1022"><span class="linenos">1022</span></a>        <span class="n">y_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_max</span><span class="p">)</span>
</span><span id="StarData-1023"><a href="#StarData-1023"><span class="linenos">1023</span></a>        <span class="n">x_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_max</span><span class="p">)</span>
</span><span id="StarData-1024"><a href="#StarData-1024"><span class="linenos">1024</span></a>
</span><span id="StarData-1025"><a href="#StarData-1025"><span class="linenos">1025</span></a>        <span class="c1"># turn into flat arrays</span>
</span><span id="StarData-1026"><a href="#StarData-1026"><span class="linenos">1026</span></a>        <span class="n">V_IDX</span><span class="p">,</span> <span class="n">Y_IDX</span><span class="p">,</span> <span class="n">X_IDX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">v_indices</span><span class="p">,</span> <span class="n">y_indices</span><span class="p">,</span> <span class="n">x_indices</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="StarData-1027"><a href="#StarData-1027"><span class="linenos">1027</span></a>
</span><span id="StarData-1028"><a href="#StarData-1028"><span class="linenos">1028</span></a>        <span class="c1"># filter out nan data</span>
</span><span id="StarData-1029"><a href="#StarData-1029"><span class="linenos">1029</span></a>        <span class="n">valid_V</span> <span class="o">=</span> <span class="n">V_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="StarData-1030"><a href="#StarData-1030"><span class="linenos">1030</span></a>        <span class="n">valid_X</span> <span class="o">=</span> <span class="n">X_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="StarData-1031"><a href="#StarData-1031"><span class="linenos">1031</span></a>        <span class="n">valid_Y</span> <span class="o">=</span> <span class="n">Y_IDX</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
</span><span id="StarData-1032"><a href="#StarData-1032"><span class="linenos">1032</span></a>
</span><span id="StarData-1033"><a href="#StarData-1033"><span class="linenos">1033</span></a>        <span class="c1"># indices to crop at</span>
</span><span id="StarData-1034"><a href="#StarData-1034"><span class="linenos">1034</span></a>        <span class="n">v_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_V</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_V</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="StarData-1035"><a href="#StarData-1035"><span class="linenos">1035</span></a>        <span class="n">v_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_V</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="StarData-1036"><a href="#StarData-1036"><span class="linenos">1036</span></a>        <span class="n">v_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_V</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="StarData-1037"><a href="#StarData-1037"><span class="linenos">1037</span></a>
</span><span id="StarData-1038"><a href="#StarData-1038"><span class="linenos">1038</span></a>        <span class="k">if</span> <span class="n">special_v</span><span class="p">:</span>
</span><span id="StarData-1039"><a href="#StarData-1039"><span class="linenos">1039</span></a>            <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v_hi</span><span class="p">],</span> <span class="s2">&quot;v should be increasing&quot;</span>
</span><span id="StarData-1040"><a href="#StarData-1040"><span class="linenos">1040</span></a>            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">:</span>
</span><span id="StarData-1041"><a href="#StarData-1041"><span class="linenos">1041</span></a>                <span class="c1"># get last time v &lt; -self.v_exp:</span>
</span><span id="StarData-1042"><a href="#StarData-1042"><span class="linenos">1042</span></a>                <span class="n">offsets</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData-1043"><a href="#StarData-1043"><span class="linenos">1043</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">offsets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="StarData-1044"><a href="#StarData-1044"><span class="linenos">1044</span></a>                    <span class="n">offsets</span><span class="p">[</span><span class="n">offsets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="StarData-1045"><a href="#StarData-1045"><span class="linenos">1045</span></a>                    <span class="n">v_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="c1"># want greatest neg value</span>
</span><span id="StarData-1046"><a href="#StarData-1046"><span class="linenos">1046</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1047"><a href="#StarData-1047"><span class="linenos">1047</span></a>                    <span class="n">v_lo</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1048"><a href="#StarData-1048"><span class="linenos">1048</span></a>            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">v_hi</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">:</span>
</span><span id="StarData-1049"><a href="#StarData-1049"><span class="linenos">1049</span></a>                <span class="n">offsets</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData-1050"><a href="#StarData-1050"><span class="linenos">1050</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">offsets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="StarData-1051"><a href="#StarData-1051"><span class="linenos">1051</span></a>                    <span class="n">offsets</span><span class="p">[</span><span class="n">offsets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="StarData-1052"><a href="#StarData-1052"><span class="linenos">1052</span></a>                    <span class="n">v_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="c1"># want smallest pos value</span>
</span><span id="StarData-1053"><a href="#StarData-1053"><span class="linenos">1053</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1054"><a href="#StarData-1054"><span class="linenos">1054</span></a>                    <span class="n">v_hi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="StarData-1055"><a href="#StarData-1055"><span class="linenos">1055</span></a>
</span><span id="StarData-1056"><a href="#StarData-1056"><span class="linenos">1056</span></a>
</span><span id="StarData-1057"><a href="#StarData-1057"><span class="linenos">1057</span></a>
</span><span id="StarData-1058"><a href="#StarData-1058"><span class="linenos">1058</span></a>        <span class="n">x_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_X</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_X</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="StarData-1059"><a href="#StarData-1059"><span class="linenos">1059</span></a>        <span class="n">x_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_X</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="StarData-1060"><a href="#StarData-1060"><span class="linenos">1060</span></a>        <span class="n">x_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_X</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="StarData-1061"><a href="#StarData-1061"><span class="linenos">1061</span></a>
</span><span id="StarData-1062"><a href="#StarData-1062"><span class="linenos">1062</span></a>        <span class="n">y_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
</span><span id="StarData-1063"><a href="#StarData-1063"><span class="linenos">1063</span></a>        <span class="n">y_lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="StarData-1064"><a href="#StarData-1064"><span class="linenos">1064</span></a>        <span class="n">y_hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crop_leeway</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_Y</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_mid</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="StarData-1065"><a href="#StarData-1065"><span class="linenos">1065</span></a>
</span><span id="StarData-1066"><a href="#StarData-1066"><span class="linenos">1066</span></a>        <span class="c1"># crop x, y, v, data</span>
</span><span id="StarData-1067"><a href="#StarData-1067"><span class="linenos">1067</span></a>        <span class="n">cropped_data</span> <span class="o">=</span> <span class="n">fill_data</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span>
</span><span id="StarData-1068"><a href="#StarData-1068"><span class="linenos">1068</span></a>        <span class="n">cropped_v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span> <span class="n">v_hi</span><span class="p">]</span>
</span><span id="StarData-1069"><a href="#StarData-1069"><span class="linenos">1069</span></a>        <span class="n">cropped_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y_lo</span><span class="p">:</span> <span class="n">y_hi</span><span class="p">]</span>
</span><span id="StarData-1070"><a href="#StarData-1070"><span class="linenos">1070</span></a>        <span class="n">cropped_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x_lo</span><span class="p">:</span> <span class="n">x_hi</span><span class="p">]</span>
</span><span id="StarData-1071"><a href="#StarData-1071"><span class="linenos">1071</span></a>
</span><span id="StarData-1072"><a href="#StarData-1072"><span class="linenos">1072</span></a>        <span class="k">return</span> <span class="n">cropped_x</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_data</span>
</span><span id="StarData-1073"><a href="#StarData-1073"><span class="linenos">1073</span></a>
</span><span id="StarData-1074"><a href="#StarData-1074"><span class="linenos">1074</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__filter_and_crop</span><span class="p">(</span>
</span><span id="StarData-1075"><a href="#StarData-1075"><span class="linenos">1075</span></a>            <span class="bp">self</span><span class="p">,</span> 
</span><span id="StarData-1076"><a href="#StarData-1076"><span class="linenos">1076</span></a>            <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1077"><a href="#StarData-1077"><span class="linenos">1077</span></a>            <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
</span><span id="StarData-1078"><a href="#StarData-1078"><span class="linenos">1078</span></a>            <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="StarData-1079"><a href="#StarData-1079"><span class="linenos">1079</span></a>            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="StarData-1080"><a href="#StarData-1080"><span class="linenos">1080</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="StarData-1081"><a href="#StarData-1081"><span class="linenos">1081</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1082"><a href="#StarData-1082"><span class="linenos">1082</span></a><span class="sd">        Filter and crop data as specified.</span>
</span><span id="StarData-1083"><a href="#StarData-1083"><span class="linenos">1083</span></a>
</span><span id="StarData-1084"><a href="#StarData-1084"><span class="linenos">1084</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1085"><a href="#StarData-1085"><span class="linenos">1085</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1086"><a href="#StarData-1086"><span class="linenos">1086</span></a><span class="sd">        filter_stds : float, int, or None</span>
</span><span id="StarData-1087"><a href="#StarData-1087"><span class="linenos">1087</span></a><span class="sd">            Number of standard deviations to filter by, or None.</span>
</span><span id="StarData-1088"><a href="#StarData-1088"><span class="linenos">1088</span></a><span class="sd">        filter_beam : bool</span>
</span><span id="StarData-1089"><a href="#StarData-1089"><span class="linenos">1089</span></a><span class="sd">            If True, apply beam filtering.</span>
</span><span id="StarData-1090"><a href="#StarData-1090"><span class="linenos">1090</span></a><span class="sd">        crop_leeway : float</span>
</span><span id="StarData-1091"><a href="#StarData-1091"><span class="linenos">1091</span></a><span class="sd">            Fractional leeway to expand the crop region.</span>
</span><span id="StarData-1092"><a href="#StarData-1092"><span class="linenos">1092</span></a><span class="sd">        verbose : bool</span>
</span><span id="StarData-1093"><a href="#StarData-1093"><span class="linenos">1093</span></a><span class="sd">            If True, print progress.</span>
</span><span id="StarData-1094"><a href="#StarData-1094"><span class="linenos">1094</span></a>
</span><span id="StarData-1095"><a href="#StarData-1095"><span class="linenos">1095</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1096"><a href="#StarData-1096"><span class="linenos">1096</span></a><span class="sd">        -------</span>
</span><span id="StarData-1097"><a href="#StarData-1097"><span class="linenos">1097</span></a><span class="sd">        X, Y, V : DataArray3D</span>
</span><span id="StarData-1098"><a href="#StarData-1098"><span class="linenos">1098</span></a><span class="sd">            Meshgrids of velocity space coordinates.</span>
</span><span id="StarData-1099"><a href="#StarData-1099"><span class="linenos">1099</span></a><span class="sd">        cropped_data : DataArray3D</span>
</span><span id="StarData-1100"><a href="#StarData-1100"><span class="linenos">1100</span></a><span class="sd">            Cropped and filtered data array.</span>
</span><span id="StarData-1101"><a href="#StarData-1101"><span class="linenos">1101</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1102"><a href="#StarData-1102"><span class="linenos">1102</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1103"><a href="#StarData-1103"><span class="linenos">1103</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1104"><a href="#StarData-1104"><span class="linenos">1104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering data (to crop)...&quot;</span><span class="p">)</span>
</span><span id="StarData-1105"><a href="#StarData-1105"><span class="linenos">1105</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="StarData-1106"><a href="#StarData-1106"><span class="linenos">1106</span></a>            <span class="k">if</span> <span class="n">filter_beam</span><span class="p">:</span>
</span><span id="StarData-1107"><a href="#StarData-1107"><span class="linenos">1107</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1108"><a href="#StarData-1108"><span class="linenos">1108</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying beam filter (to crop)...&quot;</span><span class="p">)</span>
</span><span id="StarData-1109"><a href="#StarData-1109"><span class="linenos">1109</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData-1110"><a href="#StarData-1110"><span class="linenos">1110</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1111"><a href="#StarData-1111"><span class="linenos">1111</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData-1112"><a href="#StarData-1112"><span class="linenos">1112</span></a>
</span><span id="StarData-1113"><a href="#StarData-1113"><span class="linenos">1113</span></a>        <span class="n">cropped_x</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crop_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="o">=</span><span class="n">crop_leeway</span><span class="p">,</span> <span class="n">special_v</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="StarData-1114"><a href="#StarData-1114"><span class="linenos">1114</span></a>
</span><span id="StarData-1115"><a href="#StarData-1115"><span class="linenos">1115</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  
</span><span id="StarData-1116"><a href="#StarData-1116"><span class="linenos">1116</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data cropped to shape </span><span class="si">{</span><span class="n">cropped_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StarData-1117"><a href="#StarData-1117"><span class="linenos">1117</span></a>
</span><span id="StarData-1118"><a href="#StarData-1118"><span class="linenos">1118</span></a>
</span><span id="StarData-1119"><a href="#StarData-1119"><span class="linenos">1119</span></a>        <span class="n">V</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cropped_v</span><span class="p">,</span> <span class="n">cropped_y</span><span class="p">,</span> <span class="n">cropped_x</span><span class="p">,</span> <span class="n">indexing</span> <span class="o">=</span> <span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="StarData-1120"><a href="#StarData-1120"><span class="linenos">1120</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">cropped_data</span>
</span><span id="StarData-1121"><a href="#StarData-1121"><span class="linenos">1121</span></a>    
</span><span id="StarData-1122"><a href="#StarData-1122"><span class="linenos">1122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__fast_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">x_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">y_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">z_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">]:</span>
</span><span id="StarData-1123"><a href="#StarData-1123"><span class="linenos">1123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1124"><a href="#StarData-1124"><span class="linenos">1124</span></a><span class="sd">        Interpolate the data onto a regular grid in (X, Y, Z) space.</span>
</span><span id="StarData-1125"><a href="#StarData-1125"><span class="linenos">1125</span></a>
</span><span id="StarData-1126"><a href="#StarData-1126"><span class="linenos">1126</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1127"><a href="#StarData-1127"><span class="linenos">1127</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1128"><a href="#StarData-1128"><span class="linenos">1128</span></a><span class="sd">        points : tuple</span>
</span><span id="StarData-1129"><a href="#StarData-1129"><span class="linenos">1129</span></a><span class="sd">            Tuple of (v, y, x) small coordinate arrays.</span>
</span><span id="StarData-1130"><a href="#StarData-1130"><span class="linenos">1130</span></a><span class="sd">        x_bounds, y_bounds, z_bounds : tuple</span>
</span><span id="StarData-1131"><a href="#StarData-1131"><span class="linenos">1131</span></a><span class="sd">            Bounds for the new grid in each dimension.</span>
</span><span id="StarData-1132"><a href="#StarData-1132"><span class="linenos">1132</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="StarData-1133"><a href="#StarData-1133"><span class="linenos">1133</span></a><span class="sd">            Data array to interpolate, aligned with points.</span>
</span><span id="StarData-1134"><a href="#StarData-1134"><span class="linenos">1134</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="StarData-1135"><a href="#StarData-1135"><span class="linenos">1135</span></a><span class="sd">            Velocity law function.</span>
</span><span id="StarData-1136"><a href="#StarData-1136"><span class="linenos">1136</span></a><span class="sd">        num_points : int</span>
</span><span id="StarData-1137"><a href="#StarData-1137"><span class="linenos">1137</span></a><span class="sd">            Number of points in each dimension for the new grid.</span>
</span><span id="StarData-1138"><a href="#StarData-1138"><span class="linenos">1138</span></a>
</span><span id="StarData-1139"><a href="#StarData-1139"><span class="linenos">1139</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1140"><a href="#StarData-1140"><span class="linenos">1140</span></a><span class="sd">        -------</span>
</span><span id="StarData-1141"><a href="#StarData-1141"><span class="linenos">1141</span></a><span class="sd">        X, Y, Z : DataArray1D</span>
</span><span id="StarData-1142"><a href="#StarData-1142"><span class="linenos">1142</span></a><span class="sd">            Flattened meshgrids of new coordinates.</span>
</span><span id="StarData-1143"><a href="#StarData-1143"><span class="linenos">1143</span></a><span class="sd">        interp_data : DataArray3D</span>
</span><span id="StarData-1144"><a href="#StarData-1144"><span class="linenos">1144</span></a><span class="sd">            Interpolated data array.</span>
</span><span id="StarData-1145"><a href="#StarData-1145"><span class="linenos">1145</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1146"><a href="#StarData-1146"><span class="linenos">1146</span></a>        <span class="c1"># points = (V, X, Y)</span>
</span><span id="StarData-1147"><a href="#StarData-1147"><span class="linenos">1147</span></a>        <span class="c1"># new_shape = (data.shape[0] + 2, data.shape[1], data.shape[2])</span>
</span><span id="StarData-1148"><a href="#StarData-1148"><span class="linenos">1148</span></a>        <span class="c1"># new_data = np.full(new_shape, np.nan)</span>
</span><span id="StarData-1149"><a href="#StarData-1149"><span class="linenos">1149</span></a>        <span class="c1"># new_data[1:-1, :, :] = data.copy()  # padded on both sides with nan</span>
</span><span id="StarData-1150"><a href="#StarData-1150"><span class="linenos">1150</span></a>
</span><span id="StarData-1151"><a href="#StarData-1151"><span class="linenos">1151</span></a>        <span class="c1"># # extend v array to have out-of-range values</span>
</span><span id="StarData-1152"><a href="#StarData-1152"><span class="linenos">1152</span></a>        <span class="c1"># v_array = points[0]</span>
</span><span id="StarData-1153"><a href="#StarData-1153"><span class="linenos">1153</span></a>        <span class="c1"># delta_v = v_array[1] - v_array[0]</span>
</span><span id="StarData-1154"><a href="#StarData-1154"><span class="linenos">1154</span></a>        <span class="c1"># new_v_array = np.zeros(len(v_array) + 2)</span>
</span><span id="StarData-1155"><a href="#StarData-1155"><span class="linenos">1155</span></a>        <span class="c1"># new_v_array[1:-1] = v_array</span>
</span><span id="StarData-1156"><a href="#StarData-1156"><span class="linenos">1156</span></a>        <span class="c1"># new_v_array[0] = new_v_array[1] - delta_v</span>
</span><span id="StarData-1157"><a href="#StarData-1157"><span class="linenos">1157</span></a>        <span class="c1"># new_v_array[-1] = new_v_array[-2] + delta_v</span>
</span><span id="StarData-1158"><a href="#StarData-1158"><span class="linenos">1158</span></a>        <span class="c1"># new_points = (new_v_array, points[1], points[2])</span>
</span><span id="StarData-1159"><a href="#StarData-1159"><span class="linenos">1159</span></a>
</span><span id="StarData-1160"><a href="#StarData-1160"><span class="linenos">1160</span></a>        <span class="c1"># get points to interpolate at</span>
</span><span id="StarData-1161"><a href="#StarData-1161"><span class="linenos">1161</span></a>        <span class="n">x_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="StarData-1162"><a href="#StarData-1162"><span class="linenos">1162</span></a>        <span class="n">y_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="StarData-1163"><a href="#StarData-1163"><span class="linenos">1163</span></a>        <span class="n">z_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>
</span><span id="StarData-1164"><a href="#StarData-1164"><span class="linenos">1164</span></a>
</span><span id="StarData-1165"><a href="#StarData-1165"><span class="linenos">1165</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_even</span><span class="p">,</span> <span class="n">y_even</span><span class="p">,</span> <span class="n">z_even</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="StarData-1166"><a href="#StarData-1166"><span class="linenos">1166</span></a>
</span><span id="StarData-1167"><a href="#StarData-1167"><span class="linenos">1167</span></a>        <span class="c1"># build velocities</span>
</span><span id="StarData-1168"><a href="#StarData-1168"><span class="linenos">1168</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__to_velocity_space</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="StarData-1169"><a href="#StarData-1169"><span class="linenos">1169</span></a>
</span><span id="StarData-1170"><a href="#StarData-1170"><span class="linenos">1170</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span>
</span><span id="StarData-1171"><a href="#StarData-1171"><span class="linenos">1171</span></a>        <span class="c1"># flatten arrays</span>
</span><span id="StarData-1172"><a href="#StarData-1172"><span class="linenos">1172</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1173"><a href="#StarData-1173"><span class="linenos">1173</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1174"><a href="#StarData-1174"><span class="linenos">1174</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1175"><a href="#StarData-1175"><span class="linenos">1175</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1176"><a href="#StarData-1176"><span class="linenos">1176</span></a>
</span><span id="StarData-1177"><a href="#StarData-1177"><span class="linenos">1177</span></a>        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">V</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>  <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="StarData-1178"><a href="#StarData-1178"><span class="linenos">1178</span></a>        <span class="n">V</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1179"><a href="#StarData-1179"><span class="linenos">1179</span></a>
</span><span id="StarData-1180"><a href="#StarData-1180"><span class="linenos">1180</span></a>
</span><span id="StarData-1181"><a href="#StarData-1181"><span class="linenos">1181</span></a>        <span class="n">interp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">V</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>
</span><span id="StarData-1182"><a href="#StarData-1182"><span class="linenos">1182</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">interp_points</span><span class="p">)</span>
</span><span id="StarData-1183"><a href="#StarData-1183"><span class="linenos">1183</span></a>
</span><span id="StarData-1184"><a href="#StarData-1184"><span class="linenos">1184</span></a>        <span class="n">interp_data</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-1185"><a href="#StarData-1185"><span class="linenos">1185</span></a>
</span><span id="StarData-1186"><a href="#StarData-1186"><span class="linenos">1186</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interp_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="StarData-1187"><a href="#StarData-1187"><span class="linenos">1187</span></a>
</span><span id="StarData-1188"><a href="#StarData-1188"><span class="linenos">1188</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">interp_data</span>
</span><span id="StarData-1189"><a href="#StarData-1189"><span class="linenos">1189</span></a>
</span><span id="StarData-1190"><a href="#StarData-1190"><span class="linenos">1190</span></a>    <span class="c1"># ---- COORDINATE CHANGE ----</span>
</span><span id="StarData-1191"><a href="#StarData-1191"><span class="linenos">1191</span></a>
</span><span id="StarData-1192"><a href="#StarData-1192"><span class="linenos">1192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__radius_from_vel_space_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="StarData-1193"><a href="#StarData-1193"><span class="linenos">1193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1194"><a href="#StarData-1194"><span class="linenos">1194</span></a><span class="sd">        Compute the physical radius corresponding to velocity-space coordinates (x, y, v)</span>
</span><span id="StarData-1195"><a href="#StarData-1195"><span class="linenos">1195</span></a><span class="sd">        using the provided velocity law.</span>
</span><span id="StarData-1196"><a href="#StarData-1196"><span class="linenos">1196</span></a>
</span><span id="StarData-1197"><a href="#StarData-1197"><span class="linenos">1197</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1198"><a href="#StarData-1198"><span class="linenos">1198</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1199"><a href="#StarData-1199"><span class="linenos">1199</span></a><span class="sd">        x : ndarray</span>
</span><span id="StarData-1200"><a href="#StarData-1200"><span class="linenos">1200</span></a><span class="sd">            Array of x-coordinates in AU.</span>
</span><span id="StarData-1201"><a href="#StarData-1201"><span class="linenos">1201</span></a><span class="sd">        y : ndarray</span>
</span><span id="StarData-1202"><a href="#StarData-1202"><span class="linenos">1202</span></a><span class="sd">            Array of y-coordinates in AU.</span>
</span><span id="StarData-1203"><a href="#StarData-1203"><span class="linenos">1203</span></a><span class="sd">        v : ndarray</span>
</span><span id="StarData-1204"><a href="#StarData-1204"><span class="linenos">1204</span></a><span class="sd">            Array of velocity coordinates in km/s.</span>
</span><span id="StarData-1205"><a href="#StarData-1205"><span class="linenos">1205</span></a><span class="sd">        v_func : VelocityModel</span>
</span><span id="StarData-1206"><a href="#StarData-1206"><span class="linenos">1206</span></a><span class="sd">            Callable velocity law, v_func(r), returning velocity in km/s for given radius in AU.</span>
</span><span id="StarData-1207"><a href="#StarData-1207"><span class="linenos">1207</span></a>
</span><span id="StarData-1208"><a href="#StarData-1208"><span class="linenos">1208</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1209"><a href="#StarData-1209"><span class="linenos">1209</span></a><span class="sd">        -------</span>
</span><span id="StarData-1210"><a href="#StarData-1210"><span class="linenos">1210</span></a><span class="sd">        r : ndarray</span>
</span><span id="StarData-1211"><a href="#StarData-1211"><span class="linenos">1211</span></a><span class="sd">            Array of radii in AU corresponding to the input (x, y, v) coordinates.</span>
</span><span id="StarData-1212"><a href="#StarData-1212"><span class="linenos">1212</span></a>
</span><span id="StarData-1213"><a href="#StarData-1213"><span class="linenos">1213</span></a><span class="sd">        Notes</span>
</span><span id="StarData-1214"><a href="#StarData-1214"><span class="linenos">1214</span></a><span class="sd">        -----</span>
</span><span id="StarData-1215"><a href="#StarData-1215"><span class="linenos">1215</span></a><span class="sd">        Solves for r in the equation:</span>
</span><span id="StarData-1216"><a href="#StarData-1216"><span class="linenos">1216</span></a><span class="sd">            r**2 * (1 - v**2 / v_func(r)**2) = x**2 + y**2</span>
</span><span id="StarData-1217"><a href="#StarData-1217"><span class="linenos">1217</span></a><span class="sd">        for each (x, y, v) triplet.</span>
</span><span id="StarData-1218"><a href="#StarData-1218"><span class="linenos">1218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1219"><a href="#StarData-1219"><span class="linenos">1219</span></a>        <span class="c1">#</span>
</span><span id="StarData-1220"><a href="#StarData-1220"><span class="linenos">1220</span></a>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Arrays x and y should have the same shape, instead </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span>
</span><span id="StarData-1221"><a href="#StarData-1221"><span class="linenos">1221</span></a>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Arrays x and v should have the same shape, instead </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span>
</span><span id="StarData-1222"><a href="#StarData-1222"><span class="linenos">1222</span></a>
</span><span id="StarData-1223"><a href="#StarData-1223"><span class="linenos">1223</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</span><span id="StarData-1224"><a href="#StarData-1224"><span class="linenos">1224</span></a>
</span><span id="StarData-1225"><a href="#StarData-1225"><span class="linenos">1225</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1226"><a href="#StarData-1226"><span class="linenos">1226</span></a>
</span><span id="StarData-1227"><a href="#StarData-1227"><span class="linenos">1227</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">radius_eqn</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">):</span>
</span><span id="StarData-1228"><a href="#StarData-1228"><span class="linenos">1228</span></a>            <span class="k">return</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">v_func</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>
</span><span id="StarData-1229"><a href="#StarData-1229"><span class="linenos">1229</span></a>        
</span><span id="StarData-1230"><a href="#StarData-1230"><span class="linenos">1230</span></a>        <span class="c1"># initial bracket guess</span>
</span><span id="StarData-1231"><a href="#StarData-1231"><span class="linenos">1231</span></a>        <span class="n">r_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># r must be greater than sqrt(x^2 + y^2)</span>
</span><span id="StarData-1232"><a href="#StarData-1232"><span class="linenos">1232</span></a>
</span><span id="StarData-1233"><a href="#StarData-1233"><span class="linenos">1233</span></a>        <span class="c1"># find bracket</span>
</span><span id="StarData-1234"><a href="#StarData-1234"><span class="linenos">1234</span></a>        <span class="n">bracket_result</span> <span class="o">=</span> <span class="n">bracket_root</span><span class="p">(</span><span class="n">radius_eqn</span><span class="p">,</span> <span class="n">r_lower</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">r_lower</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="StarData-1235"><a href="#StarData-1235"><span class="linenos">1235</span></a>        <span class="n">r_lower</span><span class="p">,</span> <span class="n">r_upper</span> <span class="o">=</span> <span class="n">bracket_result</span><span class="o">.</span><span class="n">bracket</span>
</span><span id="StarData-1236"><a href="#StarData-1236"><span class="linenos">1236</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">find_root</span><span class="p">(</span><span class="n">radius_eqn</span><span class="p">,</span> <span class="p">(</span><span class="n">r_lower</span><span class="p">,</span> <span class="n">r_upper</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="StarData-1237"><a href="#StarData-1237"><span class="linenos">1237</span></a>
</span><span id="StarData-1238"><a href="#StarData-1238"><span class="linenos">1238</span></a>        <span class="n">r</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
</span><span id="StarData-1239"><a href="#StarData-1239"><span class="linenos">1239</span></a>        
</span><span id="StarData-1240"><a href="#StarData-1240"><span class="linenos">1240</span></a>        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="StarData-1241"><a href="#StarData-1241"><span class="linenos">1241</span></a>
</span><span id="StarData-1242"><a href="#StarData-1242"><span class="linenos">1242</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__to_velocity_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Z</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="StarData-1243"><a href="#StarData-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1244"><a href="#StarData-1244"><span class="linenos">1244</span></a><span class="sd">        Convert spatial coordinates to velocity space using the velocity law.</span>
</span><span id="StarData-1245"><a href="#StarData-1245"><span class="linenos">1245</span></a>
</span><span id="StarData-1246"><a href="#StarData-1246"><span class="linenos">1246</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1247"><a href="#StarData-1247"><span class="linenos">1247</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1248"><a href="#StarData-1248"><span class="linenos">1248</span></a><span class="sd">        X, Y, Z : array_like</span>
</span><span id="StarData-1249"><a href="#StarData-1249"><span class="linenos">1249</span></a><span class="sd">            Spatial coordinates.</span>
</span><span id="StarData-1250"><a href="#StarData-1250"><span class="linenos">1250</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="StarData-1251"><a href="#StarData-1251"><span class="linenos">1251</span></a><span class="sd">            Velocity law function.</span>
</span><span id="StarData-1252"><a href="#StarData-1252"><span class="linenos">1252</span></a>
</span><span id="StarData-1253"><a href="#StarData-1253"><span class="linenos">1253</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1254"><a href="#StarData-1254"><span class="linenos">1254</span></a><span class="sd">        -------</span>
</span><span id="StarData-1255"><a href="#StarData-1255"><span class="linenos">1255</span></a><span class="sd">        V : array_like</span>
</span><span id="StarData-1256"><a href="#StarData-1256"><span class="linenos">1256</span></a><span class="sd">            Velocity at each spatial coordinate.</span>
</span><span id="StarData-1257"><a href="#StarData-1257"><span class="linenos">1257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1258"><a href="#StarData-1258"><span class="linenos">1258</span></a>        <span class="c1"># build velocities</span>
</span><span id="StarData-1259"><a href="#StarData-1259"><span class="linenos">1259</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1260"><a href="#StarData-1260"><span class="linenos">1260</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-1261"><a href="#StarData-1261"><span class="linenos">1261</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1262"><a href="#StarData-1262"><span class="linenos">1262</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="n">v_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-1263"><a href="#StarData-1263"><span class="linenos">1263</span></a>
</span><span id="StarData-1264"><a href="#StarData-1264"><span class="linenos">1264</span></a>        <span class="k">return</span> <span class="n">V</span>
</span><span id="StarData-1265"><a href="#StarData-1265"><span class="linenos">1265</span></a>
</span><span id="StarData-1266"><a href="#StarData-1266"><span class="linenos">1266</span></a>    <span class="c1"># ---- EXPANSION OVER TIME ----</span>
</span><span id="StarData-1267"><a href="#StarData-1267"><span class="linenos">1267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_new_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_radius</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="StarData-1268"><a href="#StarData-1268"><span class="linenos">1268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1269"><a href="#StarData-1269"><span class="linenos">1269</span></a><span class="sd">        Compute the new radius after a given time, using the velocity law.</span>
</span><span id="StarData-1270"><a href="#StarData-1270"><span class="linenos">1270</span></a>
</span><span id="StarData-1271"><a href="#StarData-1271"><span class="linenos">1271</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1272"><a href="#StarData-1272"><span class="linenos">1272</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1273"><a href="#StarData-1273"><span class="linenos">1273</span></a><span class="sd">        curr_radius : ndarray</span>
</span><span id="StarData-1274"><a href="#StarData-1274"><span class="linenos">1274</span></a><span class="sd">            Initial radii in AU.</span>
</span><span id="StarData-1275"><a href="#StarData-1275"><span class="linenos">1275</span></a><span class="sd">        years : float or int</span>
</span><span id="StarData-1276"><a href="#StarData-1276"><span class="linenos">1276</span></a><span class="sd">            Time interval in years.</span>
</span><span id="StarData-1277"><a href="#StarData-1277"><span class="linenos">1277</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="StarData-1278"><a href="#StarData-1278"><span class="linenos">1278</span></a><span class="sd">            Velocity law function, or None (uses constant velocity).</span>
</span><span id="StarData-1279"><a href="#StarData-1279"><span class="linenos">1279</span></a>
</span><span id="StarData-1280"><a href="#StarData-1280"><span class="linenos">1280</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1281"><a href="#StarData-1281"><span class="linenos">1281</span></a><span class="sd">        -------</span>
</span><span id="StarData-1282"><a href="#StarData-1282"><span class="linenos">1282</span></a><span class="sd">        new_rad : ndarray</span>
</span><span id="StarData-1283"><a href="#StarData-1283"><span class="linenos">1283</span></a><span class="sd">            New radii after the specified time interval.</span>
</span><span id="StarData-1284"><a href="#StarData-1284"><span class="linenos">1284</span></a>
</span><span id="StarData-1285"><a href="#StarData-1285"><span class="linenos">1285</span></a><span class="sd">        Notes</span>
</span><span id="StarData-1286"><a href="#StarData-1286"><span class="linenos">1286</span></a><span class="sd">        -----</span>
</span><span id="StarData-1287"><a href="#StarData-1287"><span class="linenos">1287</span></a><span class="sd">        Setting v_func = None speeds this up significantly, and is a close approximation.</span>
</span><span id="StarData-1288"><a href="#StarData-1288"><span class="linenos">1288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1289"><a href="#StarData-1289"><span class="linenos">1289</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span>  <span class="c1"># t is the time in seconds</span>
</span><span id="StarData-1290"><a href="#StarData-1290"><span class="linenos">1290</span></a>        <span class="n">rad_km</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">,</span> <span class="n">curr_radius</span><span class="p">)</span>
</span><span id="StarData-1291"><a href="#StarData-1291"><span class="linenos">1291</span></a>
</span><span id="StarData-1292"><a href="#StarData-1292"><span class="linenos">1292</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="StarData-1293"><a href="#StarData-1293"><span class="linenos">1293</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">rad_km</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="StarData-1294"><a href="#StarData-1294"><span class="linenos">1294</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1295"><a href="#StarData-1295"><span class="linenos">1295</span></a>
</span><span id="StarData-1296"><a href="#StarData-1296"><span class="linenos">1296</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">dr_dt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="StarData-1297"><a href="#StarData-1297"><span class="linenos">1297</span></a>                <span class="c1"># need to convert r back to AU</span>
</span><span id="StarData-1298"><a href="#StarData-1298"><span class="linenos">1298</span></a>                <span class="n">vals</span> <span class="o">=</span> <span class="n">v_func</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span><span id="StarData-1299"><a href="#StarData-1299"><span class="linenos">1299</span></a>                <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1300"><a href="#StarData-1300"><span class="linenos">1300</span></a>
</span><span id="StarData-1301"><a href="#StarData-1301"><span class="linenos">1301</span></a>                <span class="k">return</span> <span class="n">vals</span>
</span><span id="StarData-1302"><a href="#StarData-1302"><span class="linenos">1302</span></a>            
</span><span id="StarData-1303"><a href="#StarData-1303"><span class="linenos">1303</span></a>            <span class="c1"># flatten</span>
</span><span id="StarData-1304"><a href="#StarData-1304"><span class="linenos">1304</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">rad_km</span><span class="o">.</span><span class="n">shape</span>
</span><span id="StarData-1305"><a href="#StarData-1305"><span class="linenos">1305</span></a>            <span class="n">rad_km</span> <span class="o">=</span> <span class="n">rad_km</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1306"><a href="#StarData-1306"><span class="linenos">1306</span></a>
</span><span id="StarData-1307"><a href="#StarData-1307"><span class="linenos">1307</span></a>            <span class="c1"># remove nans</span>
</span><span id="StarData-1308"><a href="#StarData-1308"><span class="linenos">1308</span></a>            <span class="n">nan_idxs</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rad_km</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dr_dt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rad_km</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rad_km</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="StarData-1309"><a href="#StarData-1309"><span class="linenos">1309</span></a>            <span class="n">valid_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rad_km</span><span class="p">[</span><span class="o">~</span><span class="n">nan_idxs</span><span class="p">])</span>
</span><span id="StarData-1310"><a href="#StarData-1310"><span class="linenos">1310</span></a>            <span class="n">rad_km</span><span class="p">[</span><span class="n">nan_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_rad</span>
</span><span id="StarData-1311"><a href="#StarData-1311"><span class="linenos">1311</span></a>
</span><span id="StarData-1312"><a href="#StarData-1312"><span class="linenos">1312</span></a>            <span class="c1"># solve</span>
</span><span id="StarData-1313"><a href="#StarData-1313"><span class="linenos">1313</span></a>            <span class="n">solution</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">dr_dt</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="n">rad_km</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="StarData-1314"><a href="#StarData-1314"><span class="linenos">1314</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># r is evaluated at different time points</span>
</span><span id="StarData-1315"><a href="#StarData-1315"><span class="linenos">1315</span></a>
</span><span id="StarData-1316"><a href="#StarData-1316"><span class="linenos">1316</span></a>            <span class="c1"># include nans and unflatten</span>
</span><span id="StarData-1317"><a href="#StarData-1317"><span class="linenos">1317</span></a>            <span class="n">new_rad</span><span class="p">[</span><span class="n">nan_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-1318"><a href="#StarData-1318"><span class="linenos">1318</span></a>            <span class="n">new_rad</span> <span class="o">=</span> <span class="n">new_rad</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="StarData-1319"><a href="#StarData-1319"><span class="linenos">1319</span></a>
</span><span id="StarData-1320"><a href="#StarData-1320"><span class="linenos">1320</span></a>        <span class="k">return</span> <span class="n">new_rad</span>
</span><span id="StarData-1321"><a href="#StarData-1321"><span class="linenos">1321</span></a>
</span><span id="StarData-1322"><a href="#StarData-1322"><span class="linenos">1322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__time_expansion_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray1D</span><span class="p">,</span> <span class="n">DataArray3D</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="StarData-1323"><a href="#StarData-1323"><span class="linenos">1323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1324"><a href="#StarData-1324"><span class="linenos">1324</span></a><span class="sd">        Transform coordinates and data to account for expansion over time.</span>
</span><span id="StarData-1325"><a href="#StarData-1325"><span class="linenos">1325</span></a>
</span><span id="StarData-1326"><a href="#StarData-1326"><span class="linenos">1326</span></a><span class="sd">        Parameters</span>
</span><span id="StarData-1327"><a href="#StarData-1327"><span class="linenos">1327</span></a><span class="sd">        ----------</span>
</span><span id="StarData-1328"><a href="#StarData-1328"><span class="linenos">1328</span></a><span class="sd">        x, y, v : DataArray1D</span>
</span><span id="StarData-1329"><a href="#StarData-1329"><span class="linenos">1329</span></a><span class="sd">            Small coordinate arrays.</span>
</span><span id="StarData-1330"><a href="#StarData-1330"><span class="linenos">1330</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="StarData-1331"><a href="#StarData-1331"><span class="linenos">1331</span></a><span class="sd">            Data array.</span>
</span><span id="StarData-1332"><a href="#StarData-1332"><span class="linenos">1332</span></a><span class="sd">        years : float or int</span>
</span><span id="StarData-1333"><a href="#StarData-1333"><span class="linenos">1333</span></a><span class="sd">            Time interval in years.</span>
</span><span id="StarData-1334"><a href="#StarData-1334"><span class="linenos">1334</span></a><span class="sd">        v_func : VelocityModel or None</span>
</span><span id="StarData-1335"><a href="#StarData-1335"><span class="linenos">1335</span></a><span class="sd">            Velocity law function.</span>
</span><span id="StarData-1336"><a href="#StarData-1336"><span class="linenos">1336</span></a><span class="sd">        crop : bool, optional</span>
</span><span id="StarData-1337"><a href="#StarData-1337"><span class="linenos">1337</span></a><span class="sd">            If True, crop to finite values (default is True).</span>
</span><span id="StarData-1338"><a href="#StarData-1338"><span class="linenos">1338</span></a>
</span><span id="StarData-1339"><a href="#StarData-1339"><span class="linenos">1339</span></a><span class="sd">        Returns</span>
</span><span id="StarData-1340"><a href="#StarData-1340"><span class="linenos">1340</span></a><span class="sd">        -------</span>
</span><span id="StarData-1341"><a href="#StarData-1341"><span class="linenos">1341</span></a><span class="sd">        new_X, new_Y, new_V : DataArray1D</span>
</span><span id="StarData-1342"><a href="#StarData-1342"><span class="linenos">1342</span></a><span class="sd">            Transformed coordinate arrays (flattened meshgrid).</span>
</span><span id="StarData-1343"><a href="#StarData-1343"><span class="linenos">1343</span></a><span class="sd">        data : DataArray3D</span>
</span><span id="StarData-1344"><a href="#StarData-1344"><span class="linenos">1344</span></a><span class="sd">            Data array (possibly cropped). Remains unchanged if crop is False.</span>
</span><span id="StarData-1345"><a href="#StarData-1345"><span class="linenos">1345</span></a><span class="sd">        points : tuple</span>
</span><span id="StarData-1346"><a href="#StarData-1346"><span class="linenos">1346</span></a><span class="sd">            Tuple of original (v, y, x) arrays, cropped if crop is True.</span>
</span><span id="StarData-1347"><a href="#StarData-1347"><span class="linenos">1347</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1348"><a href="#StarData-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
</span><span id="StarData-1349"><a href="#StarData-1349"><span class="linenos">1349</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crop_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fill_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData-1350"><a href="#StarData-1350"><span class="linenos">1350</span></a>        
</span><span id="StarData-1351"><a href="#StarData-1351"><span class="linenos">1351</span></a>        <span class="n">V</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span id="StarData-1352"><a href="#StarData-1352"><span class="linenos">1352</span></a>
</span><span id="StarData-1353"><a href="#StarData-1353"><span class="linenos">1353</span></a>
</span><span id="StarData-1354"><a href="#StarData-1354"><span class="linenos">1354</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1355"><a href="#StarData-1355"><span class="linenos">1355</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">v_func_mod</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span><span id="StarData-1356"><a href="#StarData-1356"><span class="linenos">1356</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="StarData-1357"><a href="#StarData-1357"><span class="linenos">1357</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1358"><a href="#StarData-1358"><span class="linenos">1358</span></a>            <span class="n">v_func_mod</span> <span class="o">=</span> <span class="n">v_func</span>
</span><span id="StarData-1359"><a href="#StarData-1359"><span class="linenos">1359</span></a>
</span><span id="StarData-1360"><a href="#StarData-1360"><span class="linenos">1360</span></a>        <span class="c1"># get R0 and R1 arrays</span>
</span><span id="StarData-1361"><a href="#StarData-1361"><span class="linenos">1361</span></a>        <span class="n">R0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__radius_from_vel_space_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">v_func_mod</span><span class="p">)</span>
</span><span id="StarData-1362"><a href="#StarData-1362"><span class="linenos">1362</span></a>        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_new_radius</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="StarData-1363"><a href="#StarData-1363"><span class="linenos">1363</span></a>
</span><span id="StarData-1364"><a href="#StarData-1364"><span class="linenos">1364</span></a>        <span class="n">R1</span><span class="p">[</span><span class="n">R1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># deal with neg radii</span>
</span><span id="StarData-1365"><a href="#StarData-1365"><span class="linenos">1365</span></a>
</span><span id="StarData-1366"><a href="#StarData-1366"><span class="linenos">1366</span></a>        <span class="n">new_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">R1</span><span class="o">/</span><span class="n">R0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1367"><a href="#StarData-1367"><span class="linenos">1367</span></a>        <span class="n">new_Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="o">*</span><span class="n">R1</span><span class="o">/</span><span class="n">R0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1368"><a href="#StarData-1368"><span class="linenos">1368</span></a>        <span class="k">if</span> <span class="n">v_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1369"><a href="#StarData-1369"><span class="linenos">1369</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1370"><a href="#StarData-1370"><span class="linenos">1370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1371"><a href="#StarData-1371"><span class="linenos">1371</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">v_func</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span><span class="o">/</span><span class="n">v_func</span><span class="p">(</span><span class="n">R0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1372"><a href="#StarData-1372"><span class="linenos">1372</span></a>
</span><span id="StarData-1373"><a href="#StarData-1373"><span class="linenos">1373</span></a>
</span><span id="StarData-1374"><a href="#StarData-1374"><span class="linenos">1374</span></a>        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
</span><span id="StarData-1375"><a href="#StarData-1375"><span class="linenos">1375</span></a>            <span class="n">finite_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_Y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_V</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1376"><a href="#StarData-1376"><span class="linenos">1376</span></a>            <span class="n">new_X</span> <span class="o">=</span> <span class="n">new_X</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="StarData-1377"><a href="#StarData-1377"><span class="linenos">1377</span></a>            <span class="n">new_Y</span> <span class="o">=</span> <span class="n">new_Y</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="StarData-1378"><a href="#StarData-1378"><span class="linenos">1378</span></a>            <span class="n">new_V</span> <span class="o">=</span> <span class="n">new_V</span><span class="p">[</span><span class="n">finite_idxs</span><span class="p">]</span>
</span><span id="StarData-1379"><a href="#StarData-1379"><span class="linenos">1379</span></a>
</span><span id="StarData-1380"><a href="#StarData-1380"><span class="linenos">1380</span></a>        <span class="k">return</span> <span class="n">new_X</span><span class="p">,</span> <span class="n">new_Y</span><span class="p">,</span> <span class="n">new_V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="StarData-1381"><a href="#StarData-1381"><span class="linenos">1381</span></a>
</span><span id="StarData-1382"><a href="#StarData-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_centre</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="StarData-1383"><a href="#StarData-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1384"><a href="#StarData-1384"><span class="linenos">1384</span></a><span class="sd">        Compute the expanded data cube after a given time interval.</span>
</span><span id="StarData-1385"><a href="#StarData-1385"><span class="linenos">1385</span></a>
</span><span id="StarData-1386"><a href="#StarData-1386"><span class="linenos">1386</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1387"><a href="#StarData-1387"><span class="linenos">1387</span></a>
</span><span id="StarData-1388"><a href="#StarData-1388"><span class="linenos">1388</span></a><span class="sd">        - `years` (`float` or `int`): Time interval in years.</span>
</span><span id="StarData-1389"><a href="#StarData-1389"><span class="linenos">1389</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`): Velocity law function or None (default is None, which uses constant expansion velocity).</span>
</span><span id="StarData-1390"><a href="#StarData-1390"><span class="linenos">1390</span></a><span class="sd">        - `remove_centre` (`float` or `int` or `None`, optional): If not None, remove all points within this many beam widths of the centre (default is 2).</span>
</span><span id="StarData-1391"><a href="#StarData-1391"><span class="linenos">1391</span></a><span class="sd">        - `new_shape` (`tuple`, optional): Shape of the output grid (default is (50, 250, 250)).</span>
</span><span id="StarData-1392"><a href="#StarData-1392"><span class="linenos">1392</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="StarData-1393"><a href="#StarData-1393"><span class="linenos">1393</span></a>
</span><span id="StarData-1394"><a href="#StarData-1394"><span class="linenos">1394</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData-1395"><a href="#StarData-1395"><span class="linenos">1395</span></a>
</span><span id="StarData-1396"><a href="#StarData-1396"><span class="linenos">1396</span></a><span class="sd">        - `info` (`CondensedData`): CondensedData object containing the expanded data and metadata.</span>
</span><span id="StarData-1397"><a href="#StarData-1397"><span class="linenos">1397</span></a><span class="sd">        &quot;&quot;&quot;</span>     
</span><span id="StarData-1398"><a href="#StarData-1398"><span class="linenos">1398</span></a>        
</span><span id="StarData-1399"><a href="#StarData-1399"><span class="linenos">1399</span></a>        <span class="n">use_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData-1400"><a href="#StarData-1400"><span class="linenos">1400</span></a>        <span class="k">if</span> <span class="n">remove_centre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1401"><a href="#StarData-1401"><span class="linenos">1401</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1402"><a href="#StarData-1402"><span class="linenos">1402</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing centre...&quot;</span><span class="p">)</span>
</span><span id="StarData-1403"><a href="#StarData-1403"><span class="linenos">1403</span></a>            <span class="c1"># get centre coords</span>
</span><span id="StarData-1404"><a href="#StarData-1404"><span class="linenos">1404</span></a>            <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-1405"><a href="#StarData-1405"><span class="linenos">1405</span></a>            <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-1406"><a href="#StarData-1406"><span class="linenos">1406</span></a>            
</span><span id="StarData-1407"><a href="#StarData-1407"><span class="linenos">1407</span></a>            <span class="c1"># proportion of the radius that the beam takes up</span>
</span><span id="StarData-1408"><a href="#StarData-1408"><span class="linenos">1408</span></a>            <span class="n">beam_rad_au</span> <span class="o">=</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="StarData-1409"><a href="#StarData-1409"><span class="linenos">1409</span></a>            <span class="n">beam_prop</span> <span class="o">=</span> <span class="n">beam_rad_au</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
</span><span id="StarData-1410"><a href="#StarData-1410"><span class="linenos">1410</span></a>            <span class="n">v_axis_removal</span> <span class="o">=</span> <span class="n">remove_centre</span><span class="o">*</span><span class="n">beam_prop</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="StarData-1411"><a href="#StarData-1411"><span class="linenos">1411</span></a>            <span class="n">v_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="StarData-1412"><a href="#StarData-1412"><span class="linenos">1412</span></a>            <span class="n">relevant_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="StarData-1413"><a href="#StarData-1413"><span class="linenos">1413</span></a>            <span class="n">proportions</span> <span class="o">=</span> <span class="n">remove_centre</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">relevant_vs</span><span class="o">/</span><span class="n">v_axis_removal</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData-1414"><a href="#StarData-1414"><span class="linenos">1414</span></a>            
</span><span id="StarData-1415"><a href="#StarData-1415"><span class="linenos">1415</span></a>            <span class="c1"># removing centre</span>
</span><span id="StarData-1416"><a href="#StarData-1416"><span class="linenos">1416</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_idxs</span><span class="p">)):</span>
</span><span id="StarData-1417"><a href="#StarData-1417"><span class="linenos">1417</span></a>                <span class="n">v_idx</span> <span class="o">=</span> <span class="n">v_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="StarData-1418"><a href="#StarData-1418"><span class="linenos">1418</span></a>                <span class="n">prop</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="StarData-1419"><a href="#StarData-1419"><span class="linenos">1419</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_beam</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
</span><span id="StarData-1420"><a href="#StarData-1420"><span class="linenos">1420</span></a>                <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="n">beam</span><span class="p">:</span>
</span><span id="StarData-1421"><a href="#StarData-1421"><span class="linenos">1421</span></a>                    <span class="n">use_data</span><span class="p">[</span><span class="n">v_idx</span><span class="p">][</span><span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-1422"><a href="#StarData-1422"><span class="linenos">1422</span></a>        
</span><span id="StarData-1423"><a href="#StarData-1423"><span class="linenos">1423</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1424"><a href="#StarData-1424"><span class="linenos">1424</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming coordinates...&quot;</span><span class="p">)</span>
</span><span id="StarData-1425"><a href="#StarData-1425"><span class="linenos">1425</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="StarData-1426"><a href="#StarData-1426"><span class="linenos">1426</span></a>        <span class="n">v_num</span><span class="p">,</span> <span class="n">y_num</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">new_shape</span>
</span><span id="StarData-1427"><a href="#StarData-1427"><span class="linenos">1427</span></a>
</span><span id="StarData-1428"><a href="#StarData-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1429"><a href="#StarData-1429"><span class="linenos">1429</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating grid for new object...&quot;</span><span class="p">)</span>
</span><span id="StarData-1430"><a href="#StarData-1430"><span class="linenos">1430</span></a>        <span class="n">gridv</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
</span><span id="StarData-1431"><a href="#StarData-1431"><span class="linenos">1431</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">v_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> 
</span><span id="StarData-1432"><a href="#StarData-1432"><span class="linenos">1432</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">y_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span>
</span><span id="StarData-1433"><a href="#StarData-1433"><span class="linenos">1433</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">x_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
</span><span id="StarData-1434"><a href="#StarData-1434"><span class="linenos">1434</span></a>        <span class="p">]</span> 
</span><span id="StarData-1435"><a href="#StarData-1435"><span class="linenos">1435</span></a>
</span><span id="StarData-1436"><a href="#StarData-1436"><span class="linenos">1436</span></a>
</span><span id="StarData-1437"><a href="#StarData-1437"><span class="linenos">1437</span></a>        <span class="c1"># get preimage of grid</span>
</span><span id="StarData-1438"><a href="#StarData-1438"><span class="linenos">1438</span></a>        <span class="n">small_gridx</span> <span class="o">=</span> <span class="n">gridx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="StarData-1439"><a href="#StarData-1439"><span class="linenos">1439</span></a>        <span class="n">small_gridy</span> <span class="o">=</span> <span class="n">gridy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-1440"><a href="#StarData-1440"><span class="linenos">1440</span></a>        <span class="n">small_gridv</span> <span class="o">=</span> <span class="n">gridv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-1441"><a href="#StarData-1441"><span class="linenos">1441</span></a>
</span><span id="StarData-1442"><a href="#StarData-1442"><span class="linenos">1442</span></a>        <span class="c1"># go backwards with negative years</span>
</span><span id="StarData-1443"><a href="#StarData-1443"><span class="linenos">1443</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1444"><a href="#StarData-1444"><span class="linenos">1444</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shrinking grid to original data bounds...&quot;</span><span class="p">)</span>
</span><span id="StarData-1445"><a href="#StarData-1445"><span class="linenos">1445</span></a>        <span class="n">prev_X</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_V</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="n">small_gridx</span><span class="p">,</span> <span class="n">small_gridy</span><span class="p">,</span> <span class="n">small_gridv</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span>  <span class="o">-</span><span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="StarData-1446"><a href="#StarData-1446"><span class="linenos">1446</span></a>        
</span><span id="StarData-1447"><a href="#StarData-1447"><span class="linenos">1447</span></a>        
</span><span id="StarData-1448"><a href="#StarData-1448"><span class="linenos">1448</span></a>        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData-1449"><a href="#StarData-1449"><span class="linenos">1449</span></a>                <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData-1450"><a href="#StarData-1450"><span class="linenos">1450</span></a>                <span class="p">(</span><span class="n">prev_X</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_X</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData-1451"><a href="#StarData-1451"><span class="linenos">1451</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_V</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_Y</span><span class="p">)</span>
</span><span id="StarData-1452"><a href="#StarData-1452"><span class="linenos">1452</span></a>        
</span><span id="StarData-1453"><a href="#StarData-1453"><span class="linenos">1453</span></a>        <span class="n">prev_V</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1454"><a href="#StarData-1454"><span class="linenos">1454</span></a>        <span class="n">prev_X</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1455"><a href="#StarData-1455"><span class="linenos">1455</span></a>        <span class="n">prev_Y</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1456"><a href="#StarData-1456"><span class="linenos">1456</span></a>
</span><span id="StarData-1457"><a href="#StarData-1457"><span class="linenos">1457</span></a>        <span class="c1"># interpolate regular data at these points</span>
</span><span id="StarData-1458"><a href="#StarData-1458"><span class="linenos">1458</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1459"><a href="#StarData-1459"><span class="linenos">1459</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating...&quot;</span><span class="p">)</span>
</span><span id="StarData-1460"><a href="#StarData-1460"><span class="linenos">1460</span></a>        <span class="n">interp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">prev_V</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_X</span><span class="p">))</span>
</span><span id="StarData-1461"><a href="#StarData-1461"><span class="linenos">1461</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">interp_points</span><span class="p">)</span>
</span><span id="StarData-1462"><a href="#StarData-1462"><span class="linenos">1462</span></a>        <span class="n">interp_data</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-1463"><a href="#StarData-1463"><span class="linenos">1463</span></a>        <span class="n">new_data</span> <span class="o">=</span> <span class="n">interp_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gridx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="StarData-1464"><a href="#StarData-1464"><span class="linenos">1464</span></a>
</span><span id="StarData-1465"><a href="#StarData-1465"><span class="linenos">1465</span></a>        <span class="n">non_nans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_data</span><span class="p">)])</span>
</span><span id="StarData-1466"><a href="#StarData-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1467"><a href="#StarData-1467"><span class="linenos">1467</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">non_nans</span><span class="si">}</span><span class="s2"> non-nan values remaining out of </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StarData-1468"><a href="#StarData-1468"><span class="linenos">1468</span></a>
</span><span id="StarData-1469"><a href="#StarData-1469"><span class="linenos">1469</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="StarData-1470"><a href="#StarData-1470"><span class="linenos">1470</span></a>            <span class="n">small_gridx</span><span class="p">,</span> 
</span><span id="StarData-1471"><a href="#StarData-1471"><span class="linenos">1471</span></a>            <span class="n">small_gridy</span><span class="p">,</span> 
</span><span id="StarData-1472"><a href="#StarData-1472"><span class="linenos">1472</span></a>            <span class="n">small_gridv</span><span class="p">,</span> 
</span><span id="StarData-1473"><a href="#StarData-1473"><span class="linenos">1473</span></a>            <span class="n">new_data</span><span class="p">,</span> 
</span><span id="StarData-1474"><a href="#StarData-1474"><span class="linenos">1474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span> 
</span><span id="StarData-1475"><a href="#StarData-1475"><span class="linenos">1475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span> 
</span><span id="StarData-1476"><a href="#StarData-1476"><span class="linenos">1476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span> 
</span><span id="StarData-1477"><a href="#StarData-1477"><span class="linenos">1477</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="StarData-1478"><a href="#StarData-1478"><span class="linenos">1478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="StarData-1479"><a href="#StarData-1479"><span class="linenos">1479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="StarData-1480"><a href="#StarData-1480"><span class="linenos">1480</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> 
</span><span id="StarData-1481"><a href="#StarData-1481"><span class="linenos">1481</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> 
</span><span id="StarData-1482"><a href="#StarData-1482"><span class="linenos">1482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="StarData-1483"><a href="#StarData-1483"><span class="linenos">1483</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="StarData-1484"><a href="#StarData-1484"><span class="linenos">1484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> 
</span><span id="StarData-1485"><a href="#StarData-1485"><span class="linenos">1485</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
</span><span id="StarData-1486"><a href="#StarData-1486"><span class="linenos">1486</span></a>        <span class="p">)</span>
</span><span id="StarData-1487"><a href="#StarData-1487"><span class="linenos">1487</span></a>
</span><span id="StarData-1488"><a href="#StarData-1488"><span class="linenos">1488</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1489"><a href="#StarData-1489"><span class="linenos">1489</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time expansion process complete!&quot;</span><span class="p">)</span>
</span><span id="StarData-1490"><a href="#StarData-1490"><span class="linenos">1490</span></a>        <span class="k">return</span> <span class="n">info</span>
</span><span id="StarData-1491"><a href="#StarData-1491"><span class="linenos">1491</span></a>
</span><span id="StarData-1492"><a href="#StarData-1492"><span class="linenos">1492</span></a>
</span><span id="StarData-1493"><a href="#StarData-1493"><span class="linenos">1493</span></a>    <span class="c1"># ---- PLOTTING ----</span>
</span><span id="StarData-1494"><a href="#StarData-1494"><span class="linenos">1494</span></a>
</span><span id="StarData-1495"><a href="#StarData-1495"><span class="linenos">1495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_velocity_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1496"><a href="#StarData-1496"><span class="linenos">1496</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1497"><a href="#StarData-1497"><span class="linenos">1497</span></a><span class="sd">        Plot velocity vs. intensity at the center of the xy plane.</span>
</span><span id="StarData-1498"><a href="#StarData-1498"><span class="linenos">1498</span></a>
</span><span id="StarData-1499"><a href="#StarData-1499"><span class="linenos">1499</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1500"><a href="#StarData-1500"><span class="linenos">1500</span></a>
</span><span id="StarData-1501"><a href="#StarData-1501"><span class="linenos">1501</span></a><span class="sd">        - `fit_parabola` (`bool`, optional): If True, fit and plot a parabola (default is True).</span>
</span><span id="StarData-1502"><a href="#StarData-1502"><span class="linenos">1502</span></a>
</span><span id="StarData-1503"><a href="#StarData-1503"><span class="linenos">1503</span></a><span class="sd">        **Notes**</span>
</span><span id="StarData-1504"><a href="#StarData-1504"><span class="linenos">1504</span></a>
</span><span id="StarData-1505"><a href="#StarData-1505"><span class="linenos">1505</span></a><span class="sd">        The well-fittedness of the parabola can help you visually determine </span>
</span><span id="StarData-1506"><a href="#StarData-1506"><span class="linenos">1506</span></a><span class="sd">        the accuracy of the calculated systemic and expansion velocity.</span>
</span><span id="StarData-1507"><a href="#StarData-1507"><span class="linenos">1507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1508"><a href="#StarData-1508"><span class="linenos">1508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_star_and_exp_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="o">=</span><span class="n">fit_parabola</span><span class="p">)</span>
</span><span id="StarData-1509"><a href="#StarData-1509"><span class="linenos">1509</span></a>
</span><span id="StarData-1510"><a href="#StarData-1510"><span class="linenos">1510</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1511"><a href="#StarData-1511"><span class="linenos">1511</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1512"><a href="#StarData-1512"><span class="linenos">1512</span></a><span class="sd">        Plot radius vs. intensity at the center of the xy plane.</span>
</span><span id="StarData-1513"><a href="#StarData-1513"><span class="linenos">1513</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1514"><a href="#StarData-1514"><span class="linenos">1514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_intensities</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="StarData-1515"><a href="#StarData-1515"><span class="linenos">1515</span></a>
</span><span id="StarData-1516"><a href="#StarData-1516"><span class="linenos">1516</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_beta_law</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1517"><a href="#StarData-1517"><span class="linenos">1517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1518"><a href="#StarData-1518"><span class="linenos">1518</span></a><span class="sd">        Plot radius vs. velocity at the center of the xy plane.</span>
</span><span id="StarData-1519"><a href="#StarData-1519"><span class="linenos">1519</span></a>
</span><span id="StarData-1520"><a href="#StarData-1520"><span class="linenos">1520</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1521"><a href="#StarData-1521"><span class="linenos">1521</span></a>
</span><span id="StarData-1522"><a href="#StarData-1522"><span class="linenos">1522</span></a><span class="sd">        - `fit_beta_law` (`bool`, optional): If True, fit and plot the beta law (default is True).</span>
</span><span id="StarData-1523"><a href="#StarData-1523"><span class="linenos">1523</span></a>
</span><span id="StarData-1524"><a href="#StarData-1524"><span class="linenos">1524</span></a><span class="sd">        **Notes**</span>
</span><span id="StarData-1525"><a href="#StarData-1525"><span class="linenos">1525</span></a>
</span><span id="StarData-1526"><a href="#StarData-1526"><span class="linenos">1526</span></a><span class="sd">        The well-fittedness of the beta law curve can help you visually determine </span>
</span><span id="StarData-1527"><a href="#StarData-1527"><span class="linenos">1527</span></a><span class="sd">        the accuracy of the calculated beta law parameters.</span>
</span><span id="StarData-1528"><a href="#StarData-1528"><span class="linenos">1528</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1529"><a href="#StarData-1529"><span class="linenos">1529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_beta_law</span><span class="o">=</span><span class="n">fit_beta_law</span><span class="p">)</span>
</span><span id="StarData-1530"><a href="#StarData-1530"><span class="linenos">1530</span></a>
</span><span id="StarData-1531"><a href="#StarData-1531"><span class="linenos">1531</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_channel_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="StarData-1532"><a href="#StarData-1532"><span class="linenos">1532</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1533"><a href="#StarData-1533"><span class="linenos">1533</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="StarData-1534"><a href="#StarData-1534"><span class="linenos">1534</span></a>        <span class="n">dimensions</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1535"><a href="#StarData-1535"><span class="linenos">1535</span></a>        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="StarData-1536"><a href="#StarData-1536"><span class="linenos">1536</span></a>        <span class="n">end</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1537"><a href="#StarData-1537"><span class="linenos">1537</span></a>        <span class="n">include_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
</span><span id="StarData-1538"><a href="#StarData-1538"><span class="linenos">1538</span></a>        <span class="n">text_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1539"><a href="#StarData-1539"><span class="linenos">1539</span></a>        <span class="n">beam_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1540"><a href="#StarData-1540"><span class="linenos">1540</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1541"><a href="#StarData-1541"><span class="linenos">1541</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span>
</span><span id="StarData-1542"><a href="#StarData-1542"><span class="linenos">1542</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1543"><a href="#StarData-1543"><span class="linenos">1543</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1544"><a href="#StarData-1544"><span class="linenos">1544</span></a><span class="sd">        Plot the data cube as a set of 2D channel maps.</span>
</span><span id="StarData-1545"><a href="#StarData-1545"><span class="linenos">1545</span></a>
</span><span id="StarData-1546"><a href="#StarData-1546"><span class="linenos">1546</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1547"><a href="#StarData-1547"><span class="linenos">1547</span></a>
</span><span id="StarData-1548"><a href="#StarData-1548"><span class="linenos">1548</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="StarData-1549"><a href="#StarData-1549"><span class="linenos">1549</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="StarData-1550"><a href="#StarData-1550"><span class="linenos">1550</span></a><span class="sd">        - `dimensions` (`tuple` of `int` or `None`, optional): Grid dimensions (nrows, ncols) for subplots (default is None).</span>
</span><span id="StarData-1551"><a href="#StarData-1551"><span class="linenos">1551</span></a><span class="sd">        - `start` (`int`, optional): Starting velocity channel index (default is 0).</span>
</span><span id="StarData-1552"><a href="#StarData-1552"><span class="linenos">1552</span></a><span class="sd">        - `end` (`int` or `None`, optional): Ending velocity channel index (default is None).</span>
</span><span id="StarData-1553"><a href="#StarData-1553"><span class="linenos">1553</span></a><span class="sd">        - `include_beam` (`bool`, optional): If True, plot the beam ellipse (default is True).</span>
</span><span id="StarData-1554"><a href="#StarData-1554"><span class="linenos">1554</span></a><span class="sd">        - `text_pos` (`tuple` of `float` or `None`, optional): Position for velocity text annotation (default is None).</span>
</span><span id="StarData-1555"><a href="#StarData-1555"><span class="linenos">1555</span></a><span class="sd">        - `beam_pos` (`tuple` of `float` or `None`, optional): Position for beam ellipse (default is None).</span>
</span><span id="StarData-1556"><a href="#StarData-1556"><span class="linenos">1556</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the name of the star).</span>
</span><span id="StarData-1557"><a href="#StarData-1557"><span class="linenos">1557</span></a><span class="sd">        - `cmap` (`str`, optional): Colormap for the plot (default is &quot;viridis&quot;). See https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
</span><span id="StarData-1558"><a href="#StarData-1558"><span class="linenos">1558</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1559"><a href="#StarData-1559"><span class="linenos">1559</span></a>
</span><span id="StarData-1560"><a href="#StarData-1560"><span class="linenos">1560</span></a>        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1561"><a href="#StarData-1561"><span class="linenos">1561</span></a>            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="StarData-1562"><a href="#StarData-1562"><span class="linenos">1562</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1563"><a href="#StarData-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="StarData-1564"><a href="#StarData-1564"><span class="linenos">1564</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="StarData-1565"><a href="#StarData-1565"><span class="linenos">1565</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="StarData-1566"><a href="#StarData-1566"><span class="linenos">1566</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="StarData-1567"><a href="#StarData-1567"><span class="linenos">1567</span></a>
</span><span id="StarData-1568"><a href="#StarData-1568"><span class="linenos">1568</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1569"><a href="#StarData-1569"><span class="linenos">1569</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="StarData-1570"><a href="#StarData-1570"><span class="linenos">1570</span></a>            <span class="k">if</span> <span class="n">filter_beam</span><span class="p">:</span>
</span><span id="StarData-1571"><a href="#StarData-1571"><span class="linenos">1571</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData-1572"><a href="#StarData-1572"><span class="linenos">1572</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1573"><a href="#StarData-1573"><span class="linenos">1573</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData-1574"><a href="#StarData-1574"><span class="linenos">1574</span></a>        
</span><span id="StarData-1575"><a href="#StarData-1575"><span class="linenos">1575</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the start of the data</span>
</span><span id="StarData-1576"><a href="#StarData-1576"><span class="linenos">1576</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData-1577"><a href="#StarData-1577"><span class="linenos">1577</span></a>
</span><span id="StarData-1578"><a href="#StarData-1578"><span class="linenos">1578</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1579"><a href="#StarData-1579"><span class="linenos">1579</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">+</span> <span class="s2">&quot; channel maps&quot;</span>
</span><span id="StarData-1580"><a href="#StarData-1580"><span class="linenos">1580</span></a>
</span><span id="StarData-1581"><a href="#StarData-1581"><span class="linenos">1581</span></a>        <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1582"><a href="#StarData-1582"><span class="linenos">1582</span></a>            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">dimensions</span>
</span><span id="StarData-1583"><a href="#StarData-1583"><span class="linenos">1583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1584"><a href="#StarData-1584"><span class="linenos">1584</span></a>            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)))</span>
</span><span id="StarData-1585"><a href="#StarData-1585"><span class="linenos">1585</span></a>            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nrows</span><span class="p">))</span>
</span><span id="StarData-1586"><a href="#StarData-1586"><span class="linenos">1586</span></a>
</span><span id="StarData-1587"><a href="#StarData-1587"><span class="linenos">1587</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">)</span>
</span><span id="StarData-1588"><a href="#StarData-1588"><span class="linenos">1588</span></a>        <span class="n">viridis</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">]</span>
</span><span id="StarData-1589"><a href="#StarData-1589"><span class="linenos">1589</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="StarData-1590"><a href="#StarData-1590"><span class="linenos">1590</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Right Ascension (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="StarData-1591"><a href="#StarData-1591"><span class="linenos">1591</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Declination (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="StarData-1592"><a href="#StarData-1592"><span class="linenos">1592</span></a>
</span><span id="StarData-1593"><a href="#StarData-1593"><span class="linenos">1593</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">start</span>
</span><span id="StarData-1594"><a href="#StarData-1594"><span class="linenos">1594</span></a>        <span class="n">extents</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">)</span>
</span><span id="StarData-1595"><a href="#StarData-1595"><span class="linenos">1595</span></a>        
</span><span id="StarData-1596"><a href="#StarData-1596"><span class="linenos">1596</span></a>        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StarData-1597"><a href="#StarData-1597"><span class="linenos">1597</span></a>        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
</span><span id="StarData-1598"><a href="#StarData-1598"><span class="linenos">1598</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
</span><span id="StarData-1599"><a href="#StarData-1599"><span class="linenos">1599</span></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]),</span> <span class="n">extent</span><span class="o">=</span><span class="n">extents</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="StarData-1600"><a href="#StarData-1600"><span class="linenos">1600</span></a>
</span><span id="StarData-1601"><a href="#StarData-1601"><span class="linenos">1601</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">viridis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="StarData-1602"><a href="#StarData-1602"><span class="linenos">1602</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="StarData-1603"><a href="#StarData-1603"><span class="linenos">1603</span></a>
</span><span id="StarData-1604"><a href="#StarData-1604"><span class="linenos">1604</span></a>                <span class="k">if</span> <span class="n">text_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1605"><a href="#StarData-1605"><span class="linenos">1605</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData-1606"><a href="#StarData-1606"><span class="linenos">1606</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1607"><a href="#StarData-1607"><span class="linenos">1607</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData-1608"><a href="#StarData-1608"><span class="linenos">1608</span></a>
</span><span id="StarData-1609"><a href="#StarData-1609"><span class="linenos">1609</span></a>                <span class="k">if</span> <span class="n">include_beam</span><span class="p">:</span>
</span><span id="StarData-1610"><a href="#StarData-1610"><span class="linenos">1610</span></a>                    <span class="n">bmaj</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">)</span>
</span><span id="StarData-1611"><a href="#StarData-1611"><span class="linenos">1611</span></a>                    <span class="n">bmin</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span>
</span><span id="StarData-1612"><a href="#StarData-1612"><span class="linenos">1612</span></a>                    <span class="n">bpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="StarData-1613"><a href="#StarData-1613"><span class="linenos">1613</span></a>
</span><span id="StarData-1614"><a href="#StarData-1614"><span class="linenos">1614</span></a>                    <span class="k">if</span> <span class="n">beam_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1615"><a href="#StarData-1615"><span class="linenos">1615</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData-1616"><a href="#StarData-1616"><span class="linenos">1616</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1617"><a href="#StarData-1617"><span class="linenos">1617</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData-1618"><a href="#StarData-1618"><span class="linenos">1618</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ellipse_artist</span><span class="p">)</span>
</span><span id="StarData-1619"><a href="#StarData-1619"><span class="linenos">1619</span></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="StarData-1620"><a href="#StarData-1620"><span class="linenos">1620</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">):</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData-1621"><a href="#StarData-1621"><span class="linenos">1621</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1622"><a href="#StarData-1622"><span class="linenos">1622</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="StarData-1623"><a href="#StarData-1623"><span class="linenos">1623</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</span><span id="StarData-1624"><a href="#StarData-1624"><span class="linenos">1624</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux Density (Jy/Beam)&quot;</span><span class="p">)</span>
</span><span id="StarData-1625"><a href="#StarData-1625"><span class="linenos">1625</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-1626"><a href="#StarData-1626"><span class="linenos">1626</span></a>
</span><span id="StarData-1627"><a href="#StarData-1627"><span class="linenos">1627</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial_crop</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="StarData-1628"><a href="#StarData-1628"><span class="linenos">1628</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1629"><a href="#StarData-1629"><span class="linenos">1629</span></a><span class="sd">        Launch an interactive mask creator for the data cube.</span>
</span><span id="StarData-1630"><a href="#StarData-1630"><span class="linenos">1630</span></a>
</span><span id="StarData-1631"><a href="#StarData-1631"><span class="linenos">1631</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1632"><a href="#StarData-1632"><span class="linenos">1632</span></a>
</span><span id="StarData-1633"><a href="#StarData-1633"><span class="linenos">1633</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to initially filter by (default is None).</span>
</span><span id="StarData-1634"><a href="#StarData-1634"><span class="linenos">1634</span></a><span class="sd">        - `savefile` (`str` or `None`, optional): Filename to save the selected mask (default is None). Should end in .npy.</span>
</span><span id="StarData-1635"><a href="#StarData-1635"><span class="linenos">1635</span></a><span class="sd">        - `initial_crop` (`tuple` or `None`, optional): Initial crop region as (v_lo, v_hi, y_lo, y_hi, x_lo, x_hi), using channel indices (default is None).</span>
</span><span id="StarData-1636"><a href="#StarData-1636"><span class="linenos">1636</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1637"><a href="#StarData-1637"><span class="linenos">1637</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1638"><a href="#StarData-1638"><span class="linenos">1638</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="StarData-1639"><a href="#StarData-1639"><span class="linenos">1639</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1640"><a href="#StarData-1640"><span class="linenos">1640</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData-1641"><a href="#StarData-1641"><span class="linenos">1641</span></a>
</span><span id="StarData-1642"><a href="#StarData-1642"><span class="linenos">1642</span></a>        <span class="k">if</span> <span class="n">initial_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1643"><a href="#StarData-1643"><span class="linenos">1643</span></a>            <span class="n">v_lo</span><span class="p">,</span> <span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">initial_crop</span>
</span><span id="StarData-1644"><a href="#StarData-1644"><span class="linenos">1644</span></a>            <span class="n">new_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span>
</span><span id="StarData-1645"><a href="#StarData-1645"><span class="linenos">1645</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</span><span id="StarData-1646"><a href="#StarData-1646"><span class="linenos">1646</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-1647"><a href="#StarData-1647"><span class="linenos">1647</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="StarData-1648"><a href="#StarData-1648"><span class="linenos">1648</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="StarData-1649"><a href="#StarData-1649"><span class="linenos">1649</span></a>
</span><span id="StarData-1650"><a href="#StarData-1650"><span class="linenos">1650</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1651"><a href="#StarData-1651"><span class="linenos">1651</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData-1652"><a href="#StarData-1652"><span class="linenos">1652</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData-1653"><a href="#StarData-1653"><span class="linenos">1653</span></a>        
</span><span id="StarData-1654"><a href="#StarData-1654"><span class="linenos">1654</span></a>            <span class="c1"># mask is complete now</span>
</span><span id="StarData-1655"><a href="#StarData-1655"><span class="linenos">1655</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="StarData-1656"><a href="#StarData-1656"><span class="linenos">1656</span></a>        
</span><span id="StarData-1657"><a href="#StarData-1657"><span class="linenos">1657</span></a>        <span class="c1"># save mask</span>
</span><span id="StarData-1658"><a href="#StarData-1658"><span class="linenos">1658</span></a>        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1659"><a href="#StarData-1659"><span class="linenos">1659</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="StarData-1660"><a href="#StarData-1660"><span class="linenos">1660</span></a>
</span><span id="StarData-1661"><a href="#StarData-1661"><span class="linenos">1661</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_3D</span><span class="p">(</span>
</span><span id="StarData-1662"><a href="#StarData-1662"><span class="linenos">1662</span></a>        <span class="bp">self</span><span class="p">,</span> 
</span><span id="StarData-1663"><a href="#StarData-1663"><span class="linenos">1663</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1664"><a href="#StarData-1664"><span class="linenos">1664</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="StarData-1665"><a href="#StarData-1665"><span class="linenos">1665</span></a>        <span class="n">z_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="StarData-1666"><a href="#StarData-1666"><span class="linenos">1666</span></a>        <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="StarData-1667"><a href="#StarData-1667"><span class="linenos">1667</span></a>        <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="StarData-1668"><a href="#StarData-1668"><span class="linenos">1668</span></a>        <span class="n">num_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="StarData-1669"><a href="#StarData-1669"><span class="linenos">1669</span></a>        <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="StarData-1670"><a href="#StarData-1670"><span class="linenos">1670</span></a>        <span class="n">opacityscale</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
</span><span id="StarData-1671"><a href="#StarData-1671"><span class="linenos">1671</span></a>        <span class="n">colorscale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
</span><span id="StarData-1672"><a href="#StarData-1672"><span class="linenos">1672</span></a>        <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData-1673"><a href="#StarData-1673"><span class="linenos">1673</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="StarData-1674"><a href="#StarData-1674"><span class="linenos">1674</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-1675"><a href="#StarData-1675"><span class="linenos">1675</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData-1676"><a href="#StarData-1676"><span class="linenos">1676</span></a>        <span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
</span><span id="StarData-1677"><a href="#StarData-1677"><span class="linenos">1677</span></a>        <span class="n">camera_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="StarData-1678"><a href="#StarData-1678"><span class="linenos">1678</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1679"><a href="#StarData-1679"><span class="linenos">1679</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData-1680"><a href="#StarData-1680"><span class="linenos">1680</span></a><span class="sd">        Plot a 3D volume rendering of the data cube using Plotly.</span>
</span><span id="StarData-1681"><a href="#StarData-1681"><span class="linenos">1681</span></a>
</span><span id="StarData-1682"><a href="#StarData-1682"><span class="linenos">1682</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData-1683"><a href="#StarData-1683"><span class="linenos">1683</span></a>
</span><span id="StarData-1684"><a href="#StarData-1684"><span class="linenos">1684</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="StarData-1685"><a href="#StarData-1685"><span class="linenos">1685</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="StarData-1686"><a href="#StarData-1686"><span class="linenos">1686</span></a><span class="sd">        - `z_cutoff` (`float` or `None`, optional): Cutoff for z values as a proportion of the largest x, y values (default is 1).</span>
</span><span id="StarData-1687"><a href="#StarData-1687"><span class="linenos">1687</span></a><span class="sd">        - `crop_leeway` (`int` or `float`, optional): Fractional leeway to expand the crop region (default is 0).</span>
</span><span id="StarData-1688"><a href="#StarData-1688"><span class="linenos">1688</span></a><span class="sd">        - `num_points` (`int`, optional): Number of points in each dimension for the grid (default is 50).</span>
</span><span id="StarData-1689"><a href="#StarData-1689"><span class="linenos">1689</span></a><span class="sd">        - `num_surfaces` (`int`, optional): Number of surfaces to draw when rendering the plot (default is 50).</span>
</span><span id="StarData-1690"><a href="#StarData-1690"><span class="linenos">1690</span></a><span class="sd">        - `opacity` (`float` or `int`, optional): Opacity of the volume rendering (default is 0.5).</span>
</span><span id="StarData-1691"><a href="#StarData-1691"><span class="linenos">1691</span></a><span class="sd">        - `opacityscale` (`list` of `list` of `float`, optional): Opacity scale, see https://plotly.com/python-api-reference/generated/plotly.graph_objects.Volume.html (default is [[0, 0], [1, 1]]).</span>
</span><span id="StarData-1692"><a href="#StarData-1692"><span class="linenos">1692</span></a><span class="sd">        - `colorscale` (`str`, optional): Colormap for the plot, see https://plotly.com/python/builtin-colorscales/ (default is &quot;Reds&quot;).</span>
</span><span id="StarData-1693"><a href="#StarData-1693"><span class="linenos">1693</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`, optional): Velocity law function (default is None, which uses constant expansion velocity).</span>
</span><span id="StarData-1694"><a href="#StarData-1694"><span class="linenos">1694</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="StarData-1695"><a href="#StarData-1695"><span class="linenos">1695</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the star name).</span>
</span><span id="StarData-1696"><a href="#StarData-1696"><span class="linenos">1696</span></a><span class="sd">        - `folder` (`str` or `None`, optional): If provided, generates successive frames and saves as png files to this folder (default is None).</span>
</span><span id="StarData-1697"><a href="#StarData-1697"><span class="linenos">1697</span></a><span class="sd">        - `num_angles` (`int`, optional): Number of angles for saving images (default is 24). Greater values give smoother animation.</span>
</span><span id="StarData-1698"><a href="#StarData-1698"><span class="linenos">1698</span></a><span class="sd">        - `camera_dist` (`float` or `int`, optional): Camera radius to use if generating frames (default is 2).</span>
</span><span id="StarData-1699"><a href="#StarData-1699"><span class="linenos">1699</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData-1700"><a href="#StarData-1700"><span class="linenos">1700</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1701"><a href="#StarData-1701"><span class="linenos">1701</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial filter and crop...&quot;</span><span class="p">)</span>
</span><span id="StarData-1702"><a href="#StarData-1702"><span class="linenos">1702</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_and_crop</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">,</span> <span class="n">filter_beam</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="StarData-1703"><a href="#StarData-1703"><span class="linenos">1703</span></a>        
</span><span id="StarData-1704"><a href="#StarData-1704"><span class="linenos">1704</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1705"><a href="#StarData-1705"><span class="linenos">1705</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="StarData-1706"><a href="#StarData-1706"><span class="linenos">1706</span></a>
</span><span id="StarData-1707"><a href="#StarData-1707"><span class="linenos">1707</span></a>        <span class="c1"># get small 1d arrays</span>
</span><span id="StarData-1708"><a href="#StarData-1708"><span class="linenos">1708</span></a>        <span class="n">x_small</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="StarData-1709"><a href="#StarData-1709"><span class="linenos">1709</span></a>        <span class="n">y_small</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-1710"><a href="#StarData-1710"><span class="linenos">1710</span></a>        <span class="n">v_small</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData-1711"><a href="#StarData-1711"><span class="linenos">1711</span></a>
</span><span id="StarData-1712"><a href="#StarData-1712"><span class="linenos">1712</span></a>        <span class="c1"># interpolate to grid</span>
</span><span id="StarData-1713"><a href="#StarData-1713"><span class="linenos">1713</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1714"><a href="#StarData-1714"><span class="linenos">1714</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating to grid...&quot;</span><span class="p">)</span>
</span><span id="StarData-1715"><a href="#StarData-1715"><span class="linenos">1715</span></a>
</span><span id="StarData-1716"><a href="#StarData-1716"><span class="linenos">1716</span></a>        <span class="n">z_bound</span> <span class="o">=</span> <span class="n">z_cutoff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_small</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_small</span><span class="p">)))</span>
</span><span id="StarData-1717"><a href="#StarData-1717"><span class="linenos">1717</span></a>        
</span><span id="StarData-1718"><a href="#StarData-1718"><span class="linenos">1718</span></a>        <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="o">-</span><span class="n">z_bound</span><span class="p">,</span> <span class="n">z_bound</span>
</span><span id="StarData-1719"><a href="#StarData-1719"><span class="linenos">1719</span></a>        <span class="n">gridx</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridz</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fast_interpolation</span><span class="p">((</span><span class="n">v_small</span><span class="p">,</span> <span class="n">y_small</span><span class="p">,</span> <span class="n">x_small</span><span class="p">),</span> <span class="p">(</span><span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="StarData-1720"><a href="#StarData-1720"><span class="linenos">1720</span></a>
</span><span id="StarData-1721"><a href="#StarData-1721"><span class="linenos">1721</span></a>
</span><span id="StarData-1722"><a href="#StarData-1722"><span class="linenos">1722</span></a>        <span class="c1"># filter by standard deviation</span>
</span><span id="StarData-1723"><a href="#StarData-1723"><span class="linenos">1723</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1724"><a href="#StarData-1724"><span class="linenos">1724</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">out</span> <span class="o">&lt;</span> <span class="n">filter_stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData-1725"><a href="#StarData-1725"><span class="linenos">1725</span></a>
</span><span id="StarData-1726"><a href="#StarData-1726"><span class="linenos">1726</span></a>        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Plotly cant deal with nans</span>
</span><span id="StarData-1727"><a href="#StarData-1727"><span class="linenos">1727</span></a>
</span><span id="StarData-1728"><a href="#StarData-1728"><span class="linenos">1728</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1729"><a href="#StarData-1729"><span class="linenos">1729</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> non-nan points.&quot;</span><span class="p">)</span>
</span><span id="StarData-1730"><a href="#StarData-1730"><span class="linenos">1730</span></a>
</span><span id="StarData-1731"><a href="#StarData-1731"><span class="linenos">1731</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData-1732"><a href="#StarData-1732"><span class="linenos">1732</span></a>        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
</span><span id="StarData-1733"><a href="#StarData-1733"><span class="linenos">1733</span></a>
</span><span id="StarData-1734"><a href="#StarData-1734"><span class="linenos">1734</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1735"><a href="#StarData-1735"><span class="linenos">1735</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting figure...&quot;</span><span class="p">)</span>
</span><span id="StarData-1736"><a href="#StarData-1736"><span class="linenos">1736</span></a>
</span><span id="StarData-1737"><a href="#StarData-1737"><span class="linenos">1737</span></a>        
</span><span id="StarData-1738"><a href="#StarData-1738"><span class="linenos">1738</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
</span><span id="StarData-1739"><a href="#StarData-1739"><span class="linenos">1739</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
</span><span id="StarData-1740"><a href="#StarData-1740"><span class="linenos">1740</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">gridx</span><span class="p">,</span>
</span><span id="StarData-1741"><a href="#StarData-1741"><span class="linenos">1741</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">gridy</span><span class="p">,</span>
</span><span id="StarData-1742"><a href="#StarData-1742"><span class="linenos">1742</span></a>                <span class="n">z</span><span class="o">=</span><span class="n">gridz</span><span class="p">,</span>
</span><span id="StarData-1743"><a href="#StarData-1743"><span class="linenos">1743</span></a>                <span class="n">value</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
</span><span id="StarData-1744"><a href="#StarData-1744"><span class="linenos">1744</span></a>                <span class="n">isomin</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">,</span>
</span><span id="StarData-1745"><a href="#StarData-1745"><span class="linenos">1745</span></a>                <span class="n">colorscale</span><span class="o">=</span> <span class="n">colorscale</span><span class="p">,</span>
</span><span id="StarData-1746"><a href="#StarData-1746"><span class="linenos">1746</span></a>                <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Flux Density (Jy/beam)&quot;</span><span class="p">),</span>
</span><span id="StarData-1747"><a href="#StarData-1747"><span class="linenos">1747</span></a>                <span class="n">opacityscale</span><span class="o">=</span><span class="n">opacityscale</span><span class="p">,</span>
</span><span id="StarData-1748"><a href="#StarData-1748"><span class="linenos">1748</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span> <span class="c1"># needs to be small to see through all surfaces</span>
</span><span id="StarData-1749"><a href="#StarData-1749"><span class="linenos">1749</span></a>                <span class="n">surface_count</span><span class="o">=</span><span class="n">num_surfaces</span><span class="p">,</span> <span class="c1"># needs to be a large number for good volume rendering</span>
</span><span id="StarData-1750"><a href="#StarData-1750"><span class="linenos">1750</span></a>                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="StarData-1751"><a href="#StarData-1751"><span class="linenos">1751</span></a>            <span class="p">),</span>
</span><span id="StarData-1752"><a href="#StarData-1752"><span class="linenos">1752</span></a>            <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
</span><span id="StarData-1753"><a href="#StarData-1753"><span class="linenos">1753</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StarData-1754"><a href="#StarData-1754"><span class="linenos">1754</span></a>                    <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="n">title</span><span class="p">,</span>
</span><span id="StarData-1755"><a href="#StarData-1755"><span class="linenos">1755</span></a>                    <span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="StarData-1756"><a href="#StarData-1756"><span class="linenos">1756</span></a>                    <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="mf">0.95</span><span class="p">,</span>
</span><span id="StarData-1757"><a href="#StarData-1757"><span class="linenos">1757</span></a>                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="StarData-1758"><a href="#StarData-1758"><span class="linenos">1758</span></a>                    <span class="s2">&quot;font&quot;</span><span class="p">:{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">}</span>
</span><span id="StarData-1759"><a href="#StarData-1759"><span class="linenos">1759</span></a>                <span class="p">},</span>
</span><span id="StarData-1760"><a href="#StarData-1760"><span class="linenos">1760</span></a>                <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1761"><a href="#StarData-1761"><span class="linenos">1761</span></a>                      <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1762"><a href="#StarData-1762"><span class="linenos">1762</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1763"><a href="#StarData-1763"><span class="linenos">1763</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;X (AU)&#39;</span>
</span><span id="StarData-1764"><a href="#StarData-1764"><span class="linenos">1764</span></a>                          <span class="p">)</span>
</span><span id="StarData-1765"><a href="#StarData-1765"><span class="linenos">1765</span></a>                      <span class="p">),</span>
</span><span id="StarData-1766"><a href="#StarData-1766"><span class="linenos">1766</span></a>                      <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1767"><a href="#StarData-1767"><span class="linenos">1767</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1768"><a href="#StarData-1768"><span class="linenos">1768</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Y (AU)&#39;</span>
</span><span id="StarData-1769"><a href="#StarData-1769"><span class="linenos">1769</span></a>                          <span class="p">)</span>
</span><span id="StarData-1770"><a href="#StarData-1770"><span class="linenos">1770</span></a>                      <span class="p">),</span>
</span><span id="StarData-1771"><a href="#StarData-1771"><span class="linenos">1771</span></a>                      <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1772"><a href="#StarData-1772"><span class="linenos">1772</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData-1773"><a href="#StarData-1773"><span class="linenos">1773</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Z (AU)&#39;</span>
</span><span id="StarData-1774"><a href="#StarData-1774"><span class="linenos">1774</span></a>                          <span class="p">)</span>
</span><span id="StarData-1775"><a href="#StarData-1775"><span class="linenos">1775</span></a>                      <span class="p">),</span>
</span><span id="StarData-1776"><a href="#StarData-1776"><span class="linenos">1776</span></a>                      <span class="n">aspectmode</span> <span class="o">=</span> <span class="s2">&quot;cube&quot;</span>
</span><span id="StarData-1777"><a href="#StarData-1777"><span class="linenos">1777</span></a>                    <span class="p">),</span>
</span><span id="StarData-1778"><a href="#StarData-1778"><span class="linenos">1778</span></a>            <span class="p">)</span>
</span><span id="StarData-1779"><a href="#StarData-1779"><span class="linenos">1779</span></a>        <span class="p">)</span>
</span><span id="StarData-1780"><a href="#StarData-1780"><span class="linenos">1780</span></a>
</span><span id="StarData-1781"><a href="#StarData-1781"><span class="linenos">1781</span></a>
</span><span id="StarData-1782"><a href="#StarData-1782"><span class="linenos">1782</span></a>
</span><span id="StarData-1783"><a href="#StarData-1783"><span class="linenos">1783</span></a>        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData-1784"><a href="#StarData-1784"><span class="linenos">1784</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1785"><a href="#StarData-1785"><span class="linenos">1785</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating frames...&quot;</span><span class="p">)</span>
</span><span id="StarData-1786"><a href="#StarData-1786"><span class="linenos">1786</span></a>            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="n">num_angles</span><span class="p">)</span>
</span><span id="StarData-1787"><a href="#StarData-1787"><span class="linenos">1787</span></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="StarData-1788"><a href="#StarData-1788"><span class="linenos">1788</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
</span><span id="StarData-1789"><a href="#StarData-1789"><span class="linenos">1789</span></a>                <span class="n">eye</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">z</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
</span><span id="StarData-1790"><a href="#StarData-1790"><span class="linenos">1790</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera_eye</span> <span class="o">=</span> <span class="n">eye</span><span class="p">)</span>
</span><span id="StarData-1791"><a href="#StarData-1791"><span class="linenos">1791</span></a>                <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
</span><span id="StarData-1792"><a href="#StarData-1792"><span class="linenos">1792</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/angle</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="StarData-1793"><a href="#StarData-1793"><span class="linenos">1793</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1794"><a href="#StarData-1794"><span class="linenos">1794</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="StarData-1795"><a href="#StarData-1795"><span class="linenos">1795</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData-1796"><a href="#StarData-1796"><span class="linenos">1796</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating frames: </span><span class="si">{</span><span class="n">a</span><span class="o">/</span><span class="mi">360</span><span class="si">}</span><span class="s2">% complete.&quot;</span><span class="p">)</span>
</span><span id="StarData-1797"><a href="#StarData-1797"><span class="linenos">1797</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData-1798"><a href="#StarData-1798"><span class="linenos">1798</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Class for manipulating and analyzing astronomical data cubes of radially expanding circumstellar envelopes.</p>

<p>The StarData class provides a comprehensive interface for loading, processing, analyzing, and visualizing
3D data cubes (typically from FITS files) representing the emission from expanding circumstellar shells.
It supports both direct loading from FITS files and from preprocessed CondensedData objects, and manages
all relevant metadata and derived quantities.</p>

<h2 id="key-features">Key Features</h2>

<ul>
<li><strong>Data Loading:</strong> Supports initialization from FITS files or CondensedData objects.</li>
<li><strong>Metadata Management:</strong> Stores and exposes all relevant observational and physical parameters, including
beam properties, systemic and expansion velocities, beta velocity law parameters, and FITS header information.</li>
<li><strong>Noise Estimation:</strong> Automatically computes mean and standard deviation of background noise for filtering.</li>
<li><strong>Filtering:</strong> Provides methods to filter data by significance (standard deviations) and to remove small clumps
of points that fit within the beam (beam filtering).</li>
<li><strong>Coordinate Transformations:</strong> Handles conversion between velocity space and spatial (cartesian) coordinates,
supporting both constant velocity models and general velocity laws.</li>
<li><strong>Time Evolution:</strong> Can compute the expansion of the envelope over time, transforming the data cube accordingly.</li>
<li><strong>Visualization:</strong> Includes a variety of plotting methods:
<ul>
<li>Channel maps (2D slices through velocity channels)</li>
<li>3D volume rendering (with Plotly)</li>
<li>Diagnostic plots for velocity/intensity and radius/velocity relationships</li>
</ul></li>
<li><strong>Interactive Masking:</strong> Supports interactive creation of masks for manual data cleaning.</li>
</ul>

<h2 id="attributes">Attributes</h2>

<ul>
<li><code><a href="#StarData.data">data</a></code> (<code><a href="#DataArray3D">DataArray3D</a></code>): The main data cube (v, y, x) containing intensity values.</li>
<li><code><a href="#StarData.X">X</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of x-coordinates (offsets) in AU.</li>
<li><code><a href="#StarData.Y">Y</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of y-coordinates (offsets) in AU.</li>
<li><code><a href="#StarData.V">V</a></code> (<code><a href="#DataArray1D">DataArray1D</a></code>): 1D array of velocity offsets in km/s.</li>
<li><code><a href="#StarData.distance_to_star">distance_to_star</a></code> (<code>float</code>): Distance to the star in AU.</li>
<li><code><a href="#StarData.beam_maj">beam_maj</a></code> (<code>float</code>): Major axis of the beam in degrees.</li>
<li><code><a href="#StarData.beam_min">beam_min</a></code> (<code>float</code>): Minor axis of the beam in degrees.</li>
<li><code><a href="#StarData.beam_angle">beam_angle</a></code> (<code>float</code>): Beam position angle in degrees.</li>
<li><code><a href="#StarData.mean">mean</a></code> (<code>float</code>): Mean intensity of the background noise.</li>
<li><code><a href="#StarData.std">std</a></code> (<code>float</code>): Standard deviation of the background noise.</li>
<li><code><a href="#StarData.v_sys">v_sys</a></code> (<code>float</code>): Systemic velocity in km/s.</li>
<li><code><a href="#StarData.v_exp">v_exp</a></code> (<code>float</code>): Expansion velocity in km/s.</li>
<li><code><a href="#StarData.beta">beta</a></code> (<code>float</code>): Beta parameter of the velocity law.</li>
<li><code><a href="#StarData.r_dust">r_dust</a></code> (<code>float</code>): Dust formation radius in AU.</li>
<li><code><a href="#StarData.radius">radius</a></code> (<code>float</code>): Characteristic radius (e.g., maximum intensity change) in AU.</li>
<li><code><a href="#StarData.beta_velocity_law">beta_velocity_law</a></code> (<code><a href="#VelocityModel">VelocityModel</a></code>): Callable implementing the beta velocity law with the current object's parameters.</li>
<li><code>star_name</code> (<code>str</code>): Name of the star or object.</li>
</ul>

<h2 id="methods">Methods</h2>

<ul>
<li><code>export() -&gt; CondensedData</code>: Export all defining attributes to a CondensedData object.</li>
<li><code>get_filtered_data(stds=5)</code>: Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</li>
<li><code>beam_filter(filtered_data)</code>: Remove clumps of points that fit inside the beam, setting these values to np.nan.</li>
<li><code>get_expansion(years, v_func, ...)</code>: Compute the expanded data cube after a given time interval.</li>
<li><code>plot_channel_maps(...)</code>: Plot the data cube as a set of 2D channel maps.</li>
<li><code>plot_3D(...)</code>: Plot a 3D volume rendering of the data cube using Plotly.</li>
<li><code>plot_velocity_vs_intensity(...)</code>: Plot velocity vs. intensity at the center of the xy plane.</li>
<li><code><a href="#StarData.plot_radius_vs_intensity">plot_radius_vs_intensity()</a></code>: Plot radius vs. intensity at the center of the xy plane.</li>
<li><code>plot_radius_vs_velocity(...)</code>: Plot radius vs. velocity at the center of the xy plane.</li>
<li><code>create_mask(...)</code>: Launch an interactive mask creator for the data cube.</li>
</ul>
</div>


                            <div id="StarData.__init__" class="classattr">
                                        <input id="StarData.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StarData</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">info_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">AGB</span><span class="o">-</span><span class="n">Star</span><span class="o">-</span><span class="n">Deprojection</span><span class="o">.</span><span class="n">CondensedData</span>,</span><span class="param">	<span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">rest_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">maskfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">beta_law_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="StarData.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.__init__-153"><a href="#StarData.__init__-153"><span class="linenos">153</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StarData.__init__-154"><a href="#StarData.__init__-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StarData.__init__-155"><a href="#StarData.__init__-155"><span class="linenos">155</span></a>        <span class="n">info_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">CondensedData</span><span class="p">,</span>
</span><span id="StarData.__init__-156"><a href="#StarData.__init__-156"><span class="linenos">156</span></a>        <span class="n">distance_to_star</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-157"><a href="#StarData.__init__-157"><span class="linenos">157</span></a>        <span class="n">rest_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-158"><a href="#StarData.__init__-158"><span class="linenos">158</span></a>        <span class="n">maskfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-159"><a href="#StarData.__init__-159"><span class="linenos">159</span></a>        <span class="n">beta_law_params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-160"><a href="#StarData.__init__-160"><span class="linenos">160</span></a>        <span class="n">v_exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-161"><a href="#StarData.__init__-161"><span class="linenos">161</span></a>        <span class="n">v_sys</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.__init__-162"><a href="#StarData.__init__-162"><span class="linenos">162</span></a>        <span class="n">absolute_star_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StarData.__init__-163"><a href="#StarData.__init__-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.__init__-164"><a href="#StarData.__init__-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.__init__-165"><a href="#StarData.__init__-165"><span class="linenos">165</span></a><span class="sd">        Initialize a StarData object by reading data from a FITS file or a CondensedData object.</span>
</span><span id="StarData.__init__-166"><a href="#StarData.__init__-166"><span class="linenos">166</span></a>
</span><span id="StarData.__init__-167"><a href="#StarData.__init__-167"><span class="linenos">167</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.__init__-168"><a href="#StarData.__init__-168"><span class="linenos">168</span></a>
</span><span id="StarData.__init__-169"><a href="#StarData.__init__-169"><span class="linenos">169</span></a><span class="sd">        - `info_source` (`str` or `CondensedData`): Path to a FITS file or a CondensedData object containing preprocessed data.</span>
</span><span id="StarData.__init__-170"><a href="#StarData.__init__-170"><span class="linenos">170</span></a><span class="sd">        - `distance_to_star` (`float` or `None`, optional): Distance to the star in AU (required if info_source is a FITS file).</span>
</span><span id="StarData.__init__-171"><a href="#StarData.__init__-171"><span class="linenos">171</span></a><span class="sd">        - `rest_frequency` (`float` or `None`, optional): Rest frequency in Hz (required if info_source is a FITS file).</span>
</span><span id="StarData.__init__-172"><a href="#StarData.__init__-172"><span class="linenos">172</span></a><span class="sd">        - `maskfile` (`str` or `None`, optional): Path to a .npy file containing a mask to apply to the data.</span>
</span><span id="StarData.__init__-173"><a href="#StarData.__init__-173"><span class="linenos">173</span></a><span class="sd">        - `beta_law_params` (`tuple` of `float` or `None`, optional): (r_dust (AU), beta) parameters for the beta velocity law. If None, will be fit from data.</span>
</span><span id="StarData.__init__-174"><a href="#StarData.__init__-174"><span class="linenos">174</span></a><span class="sd">        - `v_exp` (`float` or `None`, optional): Expansion velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData.__init__-175"><a href="#StarData.__init__-175"><span class="linenos">175</span></a><span class="sd">        - `v_sys` (`float` or `None`, optional): Systemic velocity in km/s. If None, will be fit from data.</span>
</span><span id="StarData.__init__-176"><a href="#StarData.__init__-176"><span class="linenos">176</span></a><span class="sd">        - `absolute_star_pos` (`tuple` of `float` or `None`, optional): Absolute (RA, Dec) position of the star in degrees. If None, taken to be the centre of the image.</span>
</span><span id="StarData.__init__-177"><a href="#StarData.__init__-177"><span class="linenos">177</span></a>
</span><span id="StarData.__init__-178"><a href="#StarData.__init__-178"><span class="linenos">178</span></a><span class="sd">        **Raises**</span>
</span><span id="StarData.__init__-179"><a href="#StarData.__init__-179"><span class="linenos">179</span></a>
</span><span id="StarData.__init__-180"><a href="#StarData.__init__-180"><span class="linenos">180</span></a><span class="sd">        - `ValueError`: If required parameters are missing when reading from a FITS file.</span>
</span><span id="StarData.__init__-181"><a href="#StarData.__init__-181"><span class="linenos">181</span></a><span class="sd">        - `FITSHeaderError`: If any attribute in the FITS file header is an incorrect type.</span>
</span><span id="StarData.__init__-182"><a href="#StarData.__init__-182"><span class="linenos">182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.__init__-183"><a href="#StarData.__init__-183"><span class="linenos">183</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="StarData.__init__-184"><a href="#StarData.__init__-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="n">distance_to_star</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rest_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.__init__-185"><a href="#StarData.__init__-185"><span class="linenos">185</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distance to star and rest frequency required when reading from FITS file.&quot;</span><span class="p">)</span>
</span><span id="StarData.__init__-186"><a href="#StarData.__init__-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__load_from_fits_file</span><span class="p">(</span><span class="n">info_source</span><span class="p">,</span> <span class="n">distance_to_star</span><span class="p">,</span> <span class="n">rest_frequency</span><span class="p">,</span> <span class="n">absolute_star_pos</span><span class="p">,</span> <span class="n">v_sys</span> <span class="o">=</span> <span class="n">v_sys</span><span class="p">,</span> <span class="n">v_exp</span> <span class="o">=</span> <span class="n">v_exp</span><span class="p">)</span>
</span><span id="StarData.__init__-187"><a href="#StarData.__init__-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.__init__-188"><a href="#StarData.__init__-188"><span class="linenos">188</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">()</span>
</span><span id="StarData.__init__-189"><a href="#StarData.__init__-189"><span class="linenos">189</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.__init__-190"><a href="#StarData.__init__-190"><span class="linenos">190</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">beta_law_params</span>
</span><span id="StarData.__init__-191"><a href="#StarData.__init__-191"><span class="linenos">191</span></a>
</span><span id="StarData.__init__-192"><a href="#StarData.__init__-192"><span class="linenos">192</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.__init__-193"><a href="#StarData.__init__-193"><span class="linenos">193</span></a>            <span class="c1"># load from CondensedData</span>
</span><span id="StarData.__init__-194"><a href="#StarData.__init__-194"><span class="linenos">194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">x_offsets</span>
</span><span id="StarData.__init__-195"><a href="#StarData.__init__-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">y_offsets</span>
</span><span id="StarData.__init__-196"><a href="#StarData.__init__-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_V</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_offsets</span>
</span><span id="StarData.__init__-197"><a href="#StarData.__init__-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData.__init__-198"><a href="#StarData.__init__-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="StarData.__init__-199"><a href="#StarData.__init__-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="StarData.__init__-200"><a href="#StarData.__init__-200"><span class="linenos">200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_exp</span> <span class="k">if</span> <span class="n">v_exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_exp</span>
</span><span id="StarData.__init__-201"><a href="#StarData.__init__-201"><span class="linenos">201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">v_sys</span> <span class="k">if</span> <span class="n">v_sys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v_sys</span>
</span><span id="StarData.__init__-202"><a href="#StarData.__init__-202"><span class="linenos">202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">r_dust</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StarData.__init__-203"><a href="#StarData.__init__-203"><span class="linenos">203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beta</span> <span class="k">if</span> <span class="n">beta_law_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta_law_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="StarData.__init__-204"><a href="#StarData.__init__-204"><span class="linenos">204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_maj</span>
</span><span id="StarData.__init__-205"><a href="#StarData.__init__-205"><span class="linenos">205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_min</span>
</span><span id="StarData.__init__-206"><a href="#StarData.__init__-206"><span class="linenos">206</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="StarData.__init__-207"><a href="#StarData.__init__-207"><span class="linenos">207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">header</span>
</span><span id="StarData.__init__-208"><a href="#StarData.__init__-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__process_beam</span><span class="p">()</span>
</span><span id="StarData.__init__-209"><a href="#StarData.__init__-209"><span class="linenos">209</span></a>
</span><span id="StarData.__init__-210"><a href="#StarData.__init__-210"><span class="linenos">210</span></a>            <span class="c1"># compute mean and standard deviation</span>
</span><span id="StarData.__init__-211"><a href="#StarData.__init__-211"><span class="linenos">211</span></a>            <span class="k">if</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.__init__-212"><a href="#StarData.__init__-212"><span class="linenos">212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mean_and_std</span><span class="p">()</span>
</span><span id="StarData.__init__-213"><a href="#StarData.__init__-213"><span class="linenos">213</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.__init__-214"><a href="#StarData.__init__-214"><span class="linenos">214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">mean</span>
</span><span id="StarData.__init__-215"><a href="#StarData.__init__-215"><span class="linenos">215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_std</span> <span class="o">=</span> <span class="n">info_source</span><span class="o">.</span><span class="n">std</span>
</span><span id="StarData.__init__-216"><a href="#StarData.__init__-216"><span class="linenos">216</span></a>
</span><span id="StarData.__init__-217"><a href="#StarData.__init__-217"><span class="linenos">217</span></a>
</span><span id="StarData.__init__-218"><a href="#StarData.__init__-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">maskfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.__init__-219"><a href="#StarData.__init__-219"><span class="linenos">219</span></a>            <span class="c1"># mask data (permanent)</span>
</span><span id="StarData.__init__-220"><a href="#StarData.__init__-220"><span class="linenos">220</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">maskfile</span><span class="p">)</span>
</span><span id="StarData.__init__-221"><a href="#StarData.__init__-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">*</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a StarData object by reading data from a FITS file or a CondensedData object.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>info_source</code> (<code>str</code> or <code><a href="#CondensedData">CondensedData</a></code>): Path to a FITS file or a CondensedData object containing preprocessed data.</li>
<li><code><a href="#StarData.distance_to_star">distance_to_star</a></code> (<code>float</code> or <code>None</code>, optional): Distance to the star in AU (required if info_source is a FITS file).</li>
<li><code>rest_frequency</code> (<code>float</code> or <code>None</code>, optional): Rest frequency in Hz (required if info_source is a FITS file).</li>
<li><code>maskfile</code> (<code>str</code> or <code>None</code>, optional): Path to a .npy file containing a mask to apply to the data.</li>
<li><code>beta_law_params</code> (<code>tuple</code> of <code>float</code> or <code>None</code>, optional): (r_dust (AU), beta) parameters for the beta velocity law. If None, will be fit from data.</li>
<li><code><a href="#StarData.v_exp">v_exp</a></code> (<code>float</code> or <code>None</code>, optional): Expansion velocity in km/s. If None, will be fit from data.</li>
<li><code><a href="#StarData.v_sys">v_sys</a></code> (<code>float</code> or <code>None</code>, optional): Systemic velocity in km/s. If None, will be fit from data.</li>
<li><code>absolute_star_pos</code> (<code>tuple</code> of <code>float</code> or <code>None</code>, optional): Absolute (RA, Dec) position of the star in degrees. If None, taken to be the centre of the image.</li>
</ul>

<p><strong>Raises</strong></p>

<ul>
<li><code>ValueError</code>: If required parameters are missing when reading from a FITS file.</li>
<li><code><a href="#FITSHeaderError">FITSHeaderError</a></code>: If any attribute in the FITS file header is an incorrect type.</li>
</ul>
</div>


                            </div>
                            <div id="StarData.v0" class="classattr">
                                <div class="attr variable">
            <span class="name">v0</span>        =
<span class="default_value">3</span>

        
    </div>
    <a class="headerlink" href="#StarData.v0"></a>
    
    

                            </div>
                            <div id="StarData.data" class="classattr">
                                        <input id="StarData.data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">data</span><span class="annotation">: numpy.ndarray[tuple[int, int, int], numpy.dtype[numpy.float64]]</span>

                <label class="view-source-button" for="StarData.data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.data-225"><a href="#StarData.data-225"><span class="linenos">225</span></a>    <span class="nd">@property</span>
</span><span id="StarData.data-226"><a href="#StarData.data-226"><span class="linenos">226</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData.data-227"><a href="#StarData.data-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.data-228"><a href="#StarData.data-228"><span class="linenos">228</span></a><span class="sd">        DataArray3D </span>
</span><span id="StarData.data-229"><a href="#StarData.data-229"><span class="linenos">229</span></a><span class="sd">        </span>
</span><span id="StarData.data-230"><a href="#StarData.data-230"><span class="linenos">230</span></a><span class="sd">        Stores the intensity of light at each data point.</span>
</span><span id="StarData.data-231"><a href="#StarData.data-231"><span class="linenos">231</span></a><span class="sd">        </span>
</span><span id="StarData.data-232"><a href="#StarData.data-232"><span class="linenos">232</span></a><span class="sd">        Dimensions: k x m x n, where k is the number of frequency channels,</span>
</span><span id="StarData.data-233"><a href="#StarData.data-233"><span class="linenos">233</span></a><span class="sd">        m is the number of declination channels, and n is the number of right ascension channels.</span>
</span><span id="StarData.data-234"><a href="#StarData.data-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.data-235"><a href="#StarData.data-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></pre></div>


            <div class="docstring"><p>DataArray3D </p>

<p>Stores the intensity of light at each data point.</p>

<p>Dimensions: k x m x n, where k is the number of frequency channels,
m is the number of declination channels, and n is the number of right ascension channels.</p>
</div>


                            </div>
                            <div id="StarData.X" class="classattr">
                                        <input id="StarData.X-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">X</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

                <label class="view-source-button" for="StarData.X-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.X"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.X-237"><a href="#StarData.X-237"><span class="linenos">237</span></a>    <span class="nd">@property</span>
</span><span id="StarData.X-238"><a href="#StarData.X-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData.X-239"><a href="#StarData.X-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.X-240"><a href="#StarData.X-240"><span class="linenos">240</span></a><span class="sd">        DataArray1D </span>
</span><span id="StarData.X-241"><a href="#StarData.X-241"><span class="linenos">241</span></a><span class="sd">        </span>
</span><span id="StarData.X-242"><a href="#StarData.X-242"><span class="linenos">242</span></a><span class="sd">        Stores the x-coordinates relative to the centre in AU.</span>
</span><span id="StarData.X-243"><a href="#StarData.X-243"><span class="linenos">243</span></a><span class="sd">        Obtained from right ascension coordinates.</span>
</span><span id="StarData.X-244"><a href="#StarData.X-244"><span class="linenos">244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.X-245"><a href="#StarData.X-245"><span class="linenos">245</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>
</span></pre></div>


            <div class="docstring"><p>DataArray1D </p>

<p>Stores the x-coordinates relative to the centre in AU.
Obtained from right ascension coordinates.</p>
</div>


                            </div>
                            <div id="StarData.Y" class="classattr">
                                        <input id="StarData.Y-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">Y</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

                <label class="view-source-button" for="StarData.Y-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.Y"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.Y-247"><a href="#StarData.Y-247"><span class="linenos">247</span></a>    <span class="nd">@property</span>
</span><span id="StarData.Y-248"><a href="#StarData.Y-248"><span class="linenos">248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData.Y-249"><a href="#StarData.Y-249"><span class="linenos">249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.Y-250"><a href="#StarData.Y-250"><span class="linenos">250</span></a><span class="sd">        DataArray1D</span>
</span><span id="StarData.Y-251"><a href="#StarData.Y-251"><span class="linenos">251</span></a><span class="sd">         </span>
</span><span id="StarData.Y-252"><a href="#StarData.Y-252"><span class="linenos">252</span></a><span class="sd">        Stores the y-coordinates relative to the centre in AU.</span>
</span><span id="StarData.Y-253"><a href="#StarData.Y-253"><span class="linenos">253</span></a><span class="sd">        Obtained from declination coordinates.</span>
</span><span id="StarData.Y-254"><a href="#StarData.Y-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.Y-255"><a href="#StarData.Y-255"><span class="linenos">255</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>
</span></pre></div>


            <div class="docstring"><p>DataArray1D</p>

<p>Stores the y-coordinates relative to the centre in AU.
Obtained from declination coordinates.</p>
</div>


                            </div>
                            <div id="StarData.V" class="classattr">
                                        <input id="StarData.V-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">V</span><span class="annotation">: numpy.ndarray[tuple[int], numpy.dtype[numpy.float64]]</span>

                <label class="view-source-button" for="StarData.V-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.V"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.V-257"><a href="#StarData.V-257"><span class="linenos">257</span></a>    <span class="nd">@property</span>
</span><span id="StarData.V-258"><a href="#StarData.V-258"><span class="linenos">258</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">V</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray1D</span><span class="p">:</span>
</span><span id="StarData.V-259"><a href="#StarData.V-259"><span class="linenos">259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.V-260"><a href="#StarData.V-260"><span class="linenos">260</span></a><span class="sd">        DataArray1D</span>
</span><span id="StarData.V-261"><a href="#StarData.V-261"><span class="linenos">261</span></a><span class="sd">        </span>
</span><span id="StarData.V-262"><a href="#StarData.V-262"><span class="linenos">262</span></a><span class="sd">        Stores the velocity offsets relative to the star velocity in km/s.</span>
</span><span id="StarData.V-263"><a href="#StarData.V-263"><span class="linenos">263</span></a><span class="sd">        Obtained from frequency channels.</span>
</span><span id="StarData.V-264"><a href="#StarData.V-264"><span class="linenos">264</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.V-265"><a href="#StarData.V-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_V</span>
</span></pre></div>


            <div class="docstring"><p>DataArray1D</p>

<p>Stores the velocity offsets relative to the star velocity in km/s.
Obtained from frequency channels.</p>
</div>


                            </div>
                            <div id="StarData.distance_to_star" class="classattr">
                                        <input id="StarData.distance_to_star-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">distance_to_star</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.distance_to_star-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.distance_to_star"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.distance_to_star-267"><a href="#StarData.distance_to_star-267"><span class="linenos">267</span></a>    <span class="nd">@property</span>
</span><span id="StarData.distance_to_star-268"><a href="#StarData.distance_to_star-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">distance_to_star</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.distance_to_star-269"><a href="#StarData.distance_to_star-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.distance_to_star-270"><a href="#StarData.distance_to_star-270"><span class="linenos">270</span></a><span class="sd">        Distance to star in AU.</span>
</span><span id="StarData.distance_to_star-271"><a href="#StarData.distance_to_star-271"><span class="linenos">271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.distance_to_star-272"><a href="#StarData.distance_to_star-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_to_star</span>
</span></pre></div>


            <div class="docstring"><p>Distance to star in AU.</p>
</div>


                            </div>
                            <div id="StarData.B" class="classattr">
                                        <input id="StarData.B-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">B</span><span class="annotation">: numpy.ndarray[tuple[typing.Literal[2], typing.Literal[2]], numpy.dtype[numpy.float64]]</span>

                <label class="view-source-button" for="StarData.B-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.B"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.B-274"><a href="#StarData.B-274"><span class="linenos">274</span></a>    <span class="nd">@property</span>
</span><span id="StarData.B-275"><a href="#StarData.B-275"><span class="linenos">275</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix2x2</span><span class="p">:</span>
</span><span id="StarData.B-276"><a href="#StarData.B-276"><span class="linenos">276</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.B-277"><a href="#StarData.B-277"><span class="linenos">277</span></a><span class="sd">        Matrix2x2</span>
</span><span id="StarData.B-278"><a href="#StarData.B-278"><span class="linenos">278</span></a>
</span><span id="StarData.B-279"><a href="#StarData.B-279"><span class="linenos">279</span></a><span class="sd">        Ellipse matrix of beam. For 1x2 vectors v, w with coordinates (ra, dec) in degrees,</span>
</span><span id="StarData.B-280"><a href="#StarData.B-280"><span class="linenos">280</span></a><span class="sd">        if (v-w)^T B (v-w) &lt; 1, then v is within the beam centred at w.</span>
</span><span id="StarData.B-281"><a href="#StarData.B-281"><span class="linenos">281</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.B-282"><a href="#StarData.B-282"><span class="linenos">282</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B</span>
</span></pre></div>


            <div class="docstring"><p>Matrix2x2</p>

<p>Ellipse matrix of beam. For 1x2 vectors v, w with coordinates (ra, dec) in degrees,
if (v-w)^T B (v-w) &lt; 1, then v is within the beam centred at w.</p>
</div>


                            </div>
                            <div id="StarData.beam_maj" class="classattr">
                                        <input id="StarData.beam_maj-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beam_maj</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.beam_maj-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beam_maj"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beam_maj-284"><a href="#StarData.beam_maj-284"><span class="linenos">284</span></a>    <span class="nd">@property</span>
</span><span id="StarData.beam_maj-285"><a href="#StarData.beam_maj-285"><span class="linenos">285</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_maj</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.beam_maj-286"><a href="#StarData.beam_maj-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beam_maj-287"><a href="#StarData.beam_maj-287"><span class="linenos">287</span></a><span class="sd">        Major axis of the beam in degrees.</span>
</span><span id="StarData.beam_maj-288"><a href="#StarData.beam_maj-288"><span class="linenos">288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beam_maj-289"><a href="#StarData.beam_maj-289"><span class="linenos">289</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_maj</span>
</span></pre></div>


            <div class="docstring"><p>Major axis of the beam in degrees.</p>
</div>


                            </div>
                            <div id="StarData.beam_min" class="classattr">
                                        <input id="StarData.beam_min-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beam_min</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.beam_min-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beam_min"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beam_min-291"><a href="#StarData.beam_min-291"><span class="linenos">291</span></a>    <span class="nd">@property</span>
</span><span id="StarData.beam_min-292"><a href="#StarData.beam_min-292"><span class="linenos">292</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.beam_min-293"><a href="#StarData.beam_min-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beam_min-294"><a href="#StarData.beam_min-294"><span class="linenos">294</span></a><span class="sd">        Minor axis of the beam in degrees.</span>
</span><span id="StarData.beam_min-295"><a href="#StarData.beam_min-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beam_min-296"><a href="#StarData.beam_min-296"><span class="linenos">296</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_min</span>
</span></pre></div>


            <div class="docstring"><p>Minor axis of the beam in degrees.</p>
</div>


                            </div>
                            <div id="StarData.beam_angle" class="classattr">
                                        <input id="StarData.beam_angle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beam_angle</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.beam_angle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beam_angle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beam_angle-298"><a href="#StarData.beam_angle-298"><span class="linenos">298</span></a>    <span class="nd">@property</span>
</span><span id="StarData.beam_angle-299"><a href="#StarData.beam_angle-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.beam_angle-300"><a href="#StarData.beam_angle-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beam_angle-301"><a href="#StarData.beam_angle-301"><span class="linenos">301</span></a><span class="sd">        Beam position angle in degrees.</span>
</span><span id="StarData.beam_angle-302"><a href="#StarData.beam_angle-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beam_angle-303"><a href="#StarData.beam_angle-303"><span class="linenos">303</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_angle</span>
</span></pre></div>


            <div class="docstring"><p>Beam position angle in degrees.</p>
</div>


                            </div>
                            <div id="StarData.mean" class="classattr">
                                        <input id="StarData.mean-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">mean</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.mean-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.mean"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.mean-305"><a href="#StarData.mean-305"><span class="linenos">305</span></a>    <span class="nd">@property</span>
</span><span id="StarData.mean-306"><a href="#StarData.mean-306"><span class="linenos">306</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.mean-307"><a href="#StarData.mean-307"><span class="linenos">307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.mean-308"><a href="#StarData.mean-308"><span class="linenos">308</span></a><span class="sd">        The mean intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="StarData.mean-309"><a href="#StarData.mean-309"><span class="linenos">309</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.mean-310"><a href="#StarData.mean-310"><span class="linenos">310</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span>
</span></pre></div>


            <div class="docstring"><p>The mean intensity of the light, taken over coordinates away from the centre.</p>
</div>


                            </div>
                            <div id="StarData.std" class="classattr">
                                        <input id="StarData.std-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">std</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.std-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.std"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.std-312"><a href="#StarData.std-312"><span class="linenos">312</span></a>    <span class="nd">@property</span>
</span><span id="StarData.std-313"><a href="#StarData.std-313"><span class="linenos">313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.std-314"><a href="#StarData.std-314"><span class="linenos">314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.std-315"><a href="#StarData.std-315"><span class="linenos">315</span></a><span class="sd">        The standard deviation of the intensity of the light, taken over coordinates away from the centre.</span>
</span><span id="StarData.std-316"><a href="#StarData.std-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.std-317"><a href="#StarData.std-317"><span class="linenos">317</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std</span>
</span></pre></div>


            <div class="docstring"><p>The standard deviation of the intensity of the light, taken over coordinates away from the centre.</p>
</div>


                            </div>
                            <div id="StarData.v_sys" class="classattr">
                                        <input id="StarData.v_sys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">v_sys</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.v_sys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.v_sys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.v_sys-319"><a href="#StarData.v_sys-319"><span class="linenos">319</span></a>    <span class="nd">@property</span>
</span><span id="StarData.v_sys-320"><a href="#StarData.v_sys-320"><span class="linenos">320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.v_sys-321"><a href="#StarData.v_sys-321"><span class="linenos">321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.v_sys-322"><a href="#StarData.v_sys-322"><span class="linenos">322</span></a><span class="sd">        The systemic velocity of the star in km/s.</span>
</span><span id="StarData.v_sys-323"><a href="#StarData.v_sys-323"><span class="linenos">323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.v_sys-324"><a href="#StarData.v_sys-324"><span class="linenos">324</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_sys</span>
</span></pre></div>


            <div class="docstring"><p>The systemic velocity of the star in km/s.</p>
</div>


                            </div>
                            <div id="StarData.v_exp" class="classattr">
                                        <input id="StarData.v_exp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">v_exp</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.v_exp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.v_exp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.v_exp-326"><a href="#StarData.v_exp-326"><span class="linenos">326</span></a>    <span class="nd">@property</span>
</span><span id="StarData.v_exp-327"><a href="#StarData.v_exp-327"><span class="linenos">327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">v_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.v_exp-328"><a href="#StarData.v_exp-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.v_exp-329"><a href="#StarData.v_exp-329"><span class="linenos">329</span></a><span class="sd">        The maximum radial expansion speed in km/s.</span>
</span><span id="StarData.v_exp-330"><a href="#StarData.v_exp-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.v_exp-331"><a href="#StarData.v_exp-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_exp</span>
</span></pre></div>


            <div class="docstring"><p>The maximum radial expansion speed in km/s.</p>
</div>


                            </div>
                            <div id="StarData.beta" class="classattr">
                                        <input id="StarData.beta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beta</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.beta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beta-333"><a href="#StarData.beta-333"><span class="linenos">333</span></a>    <span class="nd">@property</span>
</span><span id="StarData.beta-334"><a href="#StarData.beta-334"><span class="linenos">334</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.beta-335"><a href="#StarData.beta-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beta-336"><a href="#StarData.beta-336"><span class="linenos">336</span></a><span class="sd">        Beta parameter of the velocity law.</span>
</span><span id="StarData.beta-337"><a href="#StarData.beta-337"><span class="linenos">337</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beta-338"><a href="#StarData.beta-338"><span class="linenos">338</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span></pre></div>


            <div class="docstring"><p>Beta parameter of the velocity law.</p>
</div>


                            </div>
                            <div id="StarData.r_dust" class="classattr">
                                        <input id="StarData.r_dust-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">r_dust</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.r_dust-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.r_dust"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.r_dust-340"><a href="#StarData.r_dust-340"><span class="linenos">340</span></a>    <span class="nd">@property</span>
</span><span id="StarData.r_dust-341"><a href="#StarData.r_dust-341"><span class="linenos">341</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">r_dust</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.r_dust-342"><a href="#StarData.r_dust-342"><span class="linenos">342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.r_dust-343"><a href="#StarData.r_dust-343"><span class="linenos">343</span></a><span class="sd">        Dust formation radius in AU.</span>
</span><span id="StarData.r_dust-344"><a href="#StarData.r_dust-344"><span class="linenos">344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.r_dust-345"><a href="#StarData.r_dust-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_dust</span>
</span></pre></div>


            <div class="docstring"><p>Dust formation radius in AU.</p>
</div>


                            </div>
                            <div id="StarData.radius" class="classattr">
                                        <input id="StarData.radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">radius</span><span class="annotation">: float</span>

                <label class="view-source-button" for="StarData.radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.radius-347"><a href="#StarData.radius-347"><span class="linenos">347</span></a>    <span class="nd">@property</span>
</span><span id="StarData.radius-348"><a href="#StarData.radius-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StarData.radius-349"><a href="#StarData.radius-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.radius-350"><a href="#StarData.radius-350"><span class="linenos">350</span></a><span class="sd">        Characteristic radius (e.g., maximum intensity change).</span>
</span><span id="StarData.radius-351"><a href="#StarData.radius-351"><span class="linenos">351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.radius-352"><a href="#StarData.radius-352"><span class="linenos">352</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span>
</span></pre></div>


            <div class="docstring"><p>Characteristic radius (e.g., maximum intensity change).</p>
</div>


                            </div>
                            <div id="StarData.beta_velocity_law" class="classattr">
                                        <input id="StarData.beta_velocity_law-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beta_velocity_law</span><span class="annotation">: Callable[[numpy.ndarray], numpy.ndarray]</span>

                <label class="view-source-button" for="StarData.beta_velocity_law-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beta_velocity_law"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beta_velocity_law-354"><a href="#StarData.beta_velocity_law-354"><span class="linenos">354</span></a>    <span class="nd">@property</span>
</span><span id="StarData.beta_velocity_law-355"><a href="#StarData.beta_velocity_law-355"><span class="linenos">355</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta_velocity_law</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VelocityModel</span><span class="p">:</span>
</span><span id="StarData.beta_velocity_law-356"><a href="#StarData.beta_velocity_law-356"><span class="linenos">356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beta_velocity_law-357"><a href="#StarData.beta_velocity_law-357"><span class="linenos">357</span></a><span class="sd">        VelocityModel</span>
</span><span id="StarData.beta_velocity_law-358"><a href="#StarData.beta_velocity_law-358"><span class="linenos">358</span></a>
</span><span id="StarData.beta_velocity_law-359"><a href="#StarData.beta_velocity_law-359"><span class="linenos">359</span></a><span class="sd">        Returns a callable implementing the beta velocity law with the current object&#39;s parameters.</span>
</span><span id="StarData.beta_velocity_law-360"><a href="#StarData.beta_velocity_law-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beta_velocity_law-361"><a href="#StarData.beta_velocity_law-361"><span class="linenos">361</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">law</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span><span id="StarData.beta_velocity_law-362"><a href="#StarData.beta_velocity_law-362"><span class="linenos">362</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__general_beta_velocity_law</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
</span><span id="StarData.beta_velocity_law-363"><a href="#StarData.beta_velocity_law-363"><span class="linenos">363</span></a>        <span class="k">return</span> <span class="n">law</span>
</span></pre></div>


            <div class="docstring"><p>VelocityModel</p>

<p>Returns a callable implementing the beta velocity law with the current object's parameters.</p>
</div>


                            </div>
                            <div id="StarData.export" class="classattr">
                                        <input id="StarData.export-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">AGB</span><span class="o">-</span><span class="n">Star</span><span class="o">-</span><span class="n">Deprojection</span><span class="o">.</span><span class="n">CondensedData</span>:</span></span>

                <label class="view-source-button" for="StarData.export-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.export"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.export-367"><a href="#StarData.export-367"><span class="linenos">367</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="StarData.export-368"><a href="#StarData.export-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.export-369"><a href="#StarData.export-369"><span class="linenos">369</span></a><span class="sd">        Export all defining attributes to a CondensedData object.</span>
</span><span id="StarData.export-370"><a href="#StarData.export-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.export-371"><a href="#StarData.export-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="StarData.export-372"><a href="#StarData.export-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
</span><span id="StarData.export-373"><a href="#StarData.export-373"><span class="linenos">373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
</span><span id="StarData.export-374"><a href="#StarData.export-374"><span class="linenos">374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
</span><span id="StarData.export-375"><a href="#StarData.export-375"><span class="linenos">375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
</span><span id="StarData.export-376"><a href="#StarData.export-376"><span class="linenos">376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span>
</span><span id="StarData.export-377"><a href="#StarData.export-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span>
</span><span id="StarData.export-378"><a href="#StarData.export-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span>
</span><span id="StarData.export-379"><a href="#StarData.export-379"><span class="linenos">379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="StarData.export-380"><a href="#StarData.export-380"><span class="linenos">380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="StarData.export-381"><a href="#StarData.export-381"><span class="linenos">381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="StarData.export-382"><a href="#StarData.export-382"><span class="linenos">382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span>
</span><span id="StarData.export-383"><a href="#StarData.export-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span>
</span><span id="StarData.export-384"><a href="#StarData.export-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="StarData.export-385"><a href="#StarData.export-385"><span class="linenos">385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="StarData.export-386"><a href="#StarData.export-386"><span class="linenos">386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="StarData.export-387"><a href="#StarData.export-387"><span class="linenos">387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span> 
</span><span id="StarData.export-388"><a href="#StarData.export-388"><span class="linenos">388</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export all defining attributes to a CondensedData object.</p>
</div>


                            </div>
                            <div id="StarData.get_filtered_data" class="classattr">
                                        <input id="StarData.get_filtered_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_filtered_data</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="StarData.get_filtered_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.get_filtered_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.get_filtered_data-930"><a href="#StarData.get_filtered_data-930"><span class="linenos">930</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_filtered_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData.get_filtered_data-931"><a href="#StarData.get_filtered_data-931"><span class="linenos">931</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.get_filtered_data-932"><a href="#StarData.get_filtered_data-932"><span class="linenos">932</span></a><span class="sd">        Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</span>
</span><span id="StarData.get_filtered_data-933"><a href="#StarData.get_filtered_data-933"><span class="linenos">933</span></a>
</span><span id="StarData.get_filtered_data-934"><a href="#StarData.get_filtered_data-934"><span class="linenos">934</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.get_filtered_data-935"><a href="#StarData.get_filtered_data-935"><span class="linenos">935</span></a>
</span><span id="StarData.get_filtered_data-936"><a href="#StarData.get_filtered_data-936"><span class="linenos">936</span></a><span class="sd">        - `stds` (`float` or `int`, optional): Number of standard deviations to filter by (default is 5).</span>
</span><span id="StarData.get_filtered_data-937"><a href="#StarData.get_filtered_data-937"><span class="linenos">937</span></a>
</span><span id="StarData.get_filtered_data-938"><a href="#StarData.get_filtered_data-938"><span class="linenos">938</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData.get_filtered_data-939"><a href="#StarData.get_filtered_data-939"><span class="linenos">939</span></a>
</span><span id="StarData.get_filtered_data-940"><a href="#StarData.get_filtered_data-940"><span class="linenos">940</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): Filtered data array.</span>
</span><span id="StarData.get_filtered_data-941"><a href="#StarData.get_filtered_data-941"><span class="linenos">941</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.get_filtered_data-942"><a href="#StarData.get_filtered_data-942"><span class="linenos">942</span></a>        <span class="n">filtered_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># creates a deep copy</span>
</span><span id="StarData.get_filtered_data-943"><a href="#StarData.get_filtered_data-943"><span class="linenos">943</span></a>        <span class="n">filtered_data</span><span class="p">[</span><span class="n">filtered_data</span> <span class="o">&lt;</span> <span class="n">stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData.get_filtered_data-944"><a href="#StarData.get_filtered_data-944"><span class="linenos">944</span></a>        <span class="k">return</span> <span class="n">filtered_data</span>
</span></pre></div>


            <div class="docstring"><p>Return a copy of the data, with values below the specified number of standard deviations set to np.nan.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>stds</code> (<code>float</code> or <code>int</code>, optional): Number of standard deviations to filter by (default is 5).</li>
</ul>

<p><strong>Returns</strong></p>

<ul>
<li><code>filtered_data</code> (<code><a href="#DataArray3D">DataArray3D</a></code>): Filtered data array.</li>
</ul>
</div>


                            </div>
                            <div id="StarData.beam_filter" class="classattr">
                                        <input id="StarData.beam_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">beam_filter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filtered_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="StarData.beam_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.beam_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.beam_filter-946"><a href="#StarData.beam_filter-946"><span class="linenos">946</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beam_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtered_data</span><span class="p">:</span> <span class="n">DataArray3D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray3D</span><span class="p">:</span>
</span><span id="StarData.beam_filter-947"><a href="#StarData.beam_filter-947"><span class="linenos">947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.beam_filter-948"><a href="#StarData.beam_filter-948"><span class="linenos">948</span></a><span class="sd">        Remove clumps of points that fit inside the beam, setting these values to np.nan.</span>
</span><span id="StarData.beam_filter-949"><a href="#StarData.beam_filter-949"><span class="linenos">949</span></a>
</span><span id="StarData.beam_filter-950"><a href="#StarData.beam_filter-950"><span class="linenos">950</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.beam_filter-951"><a href="#StarData.beam_filter-951"><span class="linenos">951</span></a>
</span><span id="StarData.beam_filter-952"><a href="#StarData.beam_filter-952"><span class="linenos">952</span></a><span class="sd">        - `filtered_data` (`DataArray3D`): 3-D array with the same dimensions as the data array.</span>
</span><span id="StarData.beam_filter-953"><a href="#StarData.beam_filter-953"><span class="linenos">953</span></a>
</span><span id="StarData.beam_filter-954"><a href="#StarData.beam_filter-954"><span class="linenos">954</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData.beam_filter-955"><a href="#StarData.beam_filter-955"><span class="linenos">955</span></a>
</span><span id="StarData.beam_filter-956"><a href="#StarData.beam_filter-956"><span class="linenos">956</span></a><span class="sd">        - `beam_filtered_data` (`DataArray3D`): 3-D array with small clumps of points removed.</span>
</span><span id="StarData.beam_filter-957"><a href="#StarData.beam_filter-957"><span class="linenos">957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.beam_filter-958"><a href="#StarData.beam_filter-958"><span class="linenos">958</span></a>        <span class="n">beam_filtered_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData.beam_filter-959"><a href="#StarData.beam_filter-959"><span class="linenos">959</span></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)):</span>
</span><span id="StarData.beam_filter-960"><a href="#StarData.beam_filter-960"><span class="linenos">960</span></a>            <span class="k">for</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">])):</span>
</span><span id="StarData.beam_filter-961"><a href="#StarData.beam_filter-961"><span class="linenos">961</span></a>                <span class="k">for</span> <span class="n">x_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">])):</span>
</span><span id="StarData.beam_filter-962"><a href="#StarData.beam_filter-962"><span class="linenos">962</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_idx</span><span class="p">][</span><span class="n">x_idx</span><span class="p">]):</span>  <span class="c1"># ignore empty points</span>
</span><span id="StarData.beam_filter-963"><a href="#StarData.beam_filter-963"><span class="linenos">963</span></a>                        <span class="k">continue</span>
</span><span id="StarData.beam_filter-964"><a href="#StarData.beam_filter-964"><span class="linenos">964</span></a>                    
</span><span id="StarData.beam_filter-965"><a href="#StarData.beam_filter-965"><span class="linenos">965</span></a>                    <span class="c1"># filled point that we are searching around</span>
</span><span id="StarData.beam_filter-966"><a href="#StarData.beam_filter-966"><span class="linenos">966</span></a>                
</span><span id="StarData.beam_filter-967"><a href="#StarData.beam_filter-967"><span class="linenos">967</span></a>                    <span class="n">erase</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData.beam_filter-968"><a href="#StarData.beam_filter-968"><span class="linenos">968</span></a>
</span><span id="StarData.beam_filter-969"><a href="#StarData.beam_filter-969"><span class="linenos">969</span></a>                    <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_offset</span><span class="p">:</span>
</span><span id="StarData.beam_filter-970"><a href="#StarData.beam_filter-970"><span class="linenos">970</span></a>                        <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="StarData.beam_filter-971"><a href="#StarData.beam_filter-971"><span class="linenos">971</span></a>                        <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="StarData.beam_filter-972"><a href="#StarData.beam_filter-972"><span class="linenos">972</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="StarData.beam_filter-973"><a href="#StarData.beam_filter-973"><span class="linenos">973</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]):</span>
</span><span id="StarData.beam_filter-974"><a href="#StarData.beam_filter-974"><span class="linenos">974</span></a>                                <span class="n">erase</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># there is something present on the border - saved!</span>
</span><span id="StarData.beam_filter-975"><a href="#StarData.beam_filter-975"><span class="linenos">975</span></a>                                <span class="k">break</span>
</span><span id="StarData.beam_filter-976"><a href="#StarData.beam_filter-976"><span class="linenos">976</span></a>                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># in case x_check, y_check are out of range</span>
</span><span id="StarData.beam_filter-977"><a href="#StarData.beam_filter-977"><span class="linenos">977</span></a>                            <span class="k">pass</span>
</span><span id="StarData.beam_filter-978"><a href="#StarData.beam_filter-978"><span class="linenos">978</span></a>
</span><span id="StarData.beam_filter-979"><a href="#StarData.beam_filter-979"><span class="linenos">979</span></a>                    <span class="k">if</span> <span class="n">erase</span><span class="p">:</span>  <span class="c1"># consider ellipse to be an anomaly</span>
</span><span id="StarData.beam_filter-980"><a href="#StarData.beam_filter-980"><span class="linenos">980</span></a>                        <span class="c1"># erase entire inside of ellipse centred at w</span>
</span><span id="StarData.beam_filter-981"><a href="#StarData.beam_filter-981"><span class="linenos">981</span></a>                        <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_in_beam</span><span class="p">:</span>
</span><span id="StarData.beam_filter-982"><a href="#StarData.beam_filter-982"><span class="linenos">982</span></a>                            <span class="n">x_check</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span>
</span><span id="StarData.beam_filter-983"><a href="#StarData.beam_filter-983"><span class="linenos">983</span></a>                            <span class="n">y_check</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span>
</span><span id="StarData.beam_filter-984"><a href="#StarData.beam_filter-984"><span class="linenos">984</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="StarData.beam_filter-985"><a href="#StarData.beam_filter-985"><span class="linenos">985</span></a>                                <span class="n">beam_filtered_data</span><span class="p">[</span><span class="n">frame</span><span class="p">][</span><span class="n">y_check</span><span class="p">][</span><span class="n">x_check</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># erase</span>
</span><span id="StarData.beam_filter-986"><a href="#StarData.beam_filter-986"><span class="linenos">986</span></a>                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="StarData.beam_filter-987"><a href="#StarData.beam_filter-987"><span class="linenos">987</span></a>                                <span class="k">pass</span>
</span><span id="StarData.beam_filter-988"><a href="#StarData.beam_filter-988"><span class="linenos">988</span></a>            
</span><span id="StarData.beam_filter-989"><a href="#StarData.beam_filter-989"><span class="linenos">989</span></a>        <span class="k">return</span> <span class="n">beam_filtered_data</span>
</span></pre></div>


            <div class="docstring"><p>Remove clumps of points that fit inside the beam, setting these values to np.nan.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>filtered_data</code> (<code><a href="#DataArray3D">DataArray3D</a></code>): 3-D array with the same dimensions as the data array.</li>
</ul>

<p><strong>Returns</strong></p>

<ul>
<li><code>beam_filtered_data</code> (<code><a href="#DataArray3D">DataArray3D</a></code>): 3-D array with small clumps of points removed.</li>
</ul>
</div>


                            </div>
                            <div id="StarData.get_expansion" class="classattr">
                                        <input id="StarData.get_expansion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_expansion</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">v_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">remove_centre</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">new_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">AGB</span><span class="o">-</span><span class="n">Star</span><span class="o">-</span><span class="n">Deprojection</span><span class="o">.</span><span class="n">CondensedData</span>:</span></span>

                <label class="view-source-button" for="StarData.get_expansion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.get_expansion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.get_expansion-1382"><a href="#StarData.get_expansion-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remove_centre</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CondensedData</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1383"><a href="#StarData.get_expansion-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.get_expansion-1384"><a href="#StarData.get_expansion-1384"><span class="linenos">1384</span></a><span class="sd">        Compute the expanded data cube after a given time interval.</span>
</span><span id="StarData.get_expansion-1385"><a href="#StarData.get_expansion-1385"><span class="linenos">1385</span></a>
</span><span id="StarData.get_expansion-1386"><a href="#StarData.get_expansion-1386"><span class="linenos">1386</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.get_expansion-1387"><a href="#StarData.get_expansion-1387"><span class="linenos">1387</span></a>
</span><span id="StarData.get_expansion-1388"><a href="#StarData.get_expansion-1388"><span class="linenos">1388</span></a><span class="sd">        - `years` (`float` or `int`): Time interval in years.</span>
</span><span id="StarData.get_expansion-1389"><a href="#StarData.get_expansion-1389"><span class="linenos">1389</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`): Velocity law function or None (default is None, which uses constant expansion velocity).</span>
</span><span id="StarData.get_expansion-1390"><a href="#StarData.get_expansion-1390"><span class="linenos">1390</span></a><span class="sd">        - `remove_centre` (`float` or `int` or `None`, optional): If not None, remove all points within this many beam widths of the centre (default is 2).</span>
</span><span id="StarData.get_expansion-1391"><a href="#StarData.get_expansion-1391"><span class="linenos">1391</span></a><span class="sd">        - `new_shape` (`tuple`, optional): Shape of the output grid (default is (50, 250, 250)).</span>
</span><span id="StarData.get_expansion-1392"><a href="#StarData.get_expansion-1392"><span class="linenos">1392</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="StarData.get_expansion-1393"><a href="#StarData.get_expansion-1393"><span class="linenos">1393</span></a>
</span><span id="StarData.get_expansion-1394"><a href="#StarData.get_expansion-1394"><span class="linenos">1394</span></a><span class="sd">        **Returns**</span>
</span><span id="StarData.get_expansion-1395"><a href="#StarData.get_expansion-1395"><span class="linenos">1395</span></a>
</span><span id="StarData.get_expansion-1396"><a href="#StarData.get_expansion-1396"><span class="linenos">1396</span></a><span class="sd">        - `info` (`CondensedData`): CondensedData object containing the expanded data and metadata.</span>
</span><span id="StarData.get_expansion-1397"><a href="#StarData.get_expansion-1397"><span class="linenos">1397</span></a><span class="sd">        &quot;&quot;&quot;</span>     
</span><span id="StarData.get_expansion-1398"><a href="#StarData.get_expansion-1398"><span class="linenos">1398</span></a>        
</span><span id="StarData.get_expansion-1399"><a href="#StarData.get_expansion-1399"><span class="linenos">1399</span></a>        <span class="n">use_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="StarData.get_expansion-1400"><a href="#StarData.get_expansion-1400"><span class="linenos">1400</span></a>        <span class="k">if</span> <span class="n">remove_centre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1401"><a href="#StarData.get_expansion-1401"><span class="linenos">1401</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1402"><a href="#StarData.get_expansion-1402"><span class="linenos">1402</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing centre...&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1403"><a href="#StarData.get_expansion-1403"><span class="linenos">1403</span></a>            <span class="c1"># get centre coords</span>
</span><span id="StarData.get_expansion-1404"><a href="#StarData.get_expansion-1404"><span class="linenos">1404</span></a>            <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1405"><a href="#StarData.get_expansion-1405"><span class="linenos">1405</span></a>            <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1406"><a href="#StarData.get_expansion-1406"><span class="linenos">1406</span></a>            
</span><span id="StarData.get_expansion-1407"><a href="#StarData.get_expansion-1407"><span class="linenos">1407</span></a>            <span class="c1"># proportion of the radius that the beam takes up</span>
</span><span id="StarData.get_expansion-1408"><a href="#StarData.get_expansion-1408"><span class="linenos">1408</span></a>            <span class="n">beam_rad_au</span> <span class="o">=</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span>
</span><span id="StarData.get_expansion-1409"><a href="#StarData.get_expansion-1409"><span class="linenos">1409</span></a>            <span class="n">beam_prop</span> <span class="o">=</span> <span class="n">beam_rad_au</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
</span><span id="StarData.get_expansion-1410"><a href="#StarData.get_expansion-1410"><span class="linenos">1410</span></a>            <span class="n">v_axis_removal</span> <span class="o">=</span> <span class="n">remove_centre</span><span class="o">*</span><span class="n">beam_prop</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span>
</span><span id="StarData.get_expansion-1411"><a href="#StarData.get_expansion-1411"><span class="linenos">1411</span></a>            <span class="n">v_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1412"><a href="#StarData.get_expansion-1412"><span class="linenos">1412</span></a>            <span class="n">relevant_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v_axis_removal</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1413"><a href="#StarData.get_expansion-1413"><span class="linenos">1413</span></a>            <span class="n">proportions</span> <span class="o">=</span> <span class="n">remove_centre</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">relevant_vs</span><span class="o">/</span><span class="n">v_axis_removal</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1414"><a href="#StarData.get_expansion-1414"><span class="linenos">1414</span></a>            
</span><span id="StarData.get_expansion-1415"><a href="#StarData.get_expansion-1415"><span class="linenos">1415</span></a>            <span class="c1"># removing centre</span>
</span><span id="StarData.get_expansion-1416"><a href="#StarData.get_expansion-1416"><span class="linenos">1416</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_idxs</span><span class="p">)):</span>
</span><span id="StarData.get_expansion-1417"><a href="#StarData.get_expansion-1417"><span class="linenos">1417</span></a>                <span class="n">v_idx</span> <span class="o">=</span> <span class="n">v_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1418"><a href="#StarData.get_expansion-1418"><span class="linenos">1418</span></a>                <span class="n">prop</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1419"><a href="#StarData.get_expansion-1419"><span class="linenos">1419</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_beam</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1420"><a href="#StarData.get_expansion-1420"><span class="linenos">1420</span></a>                <span class="k">for</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span> <span class="ow">in</span> <span class="n">beam</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1421"><a href="#StarData.get_expansion-1421"><span class="linenos">1421</span></a>                    <span class="n">use_data</span><span class="p">[</span><span class="n">v_idx</span><span class="p">][</span><span class="n">y_idx</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">][</span><span class="n">x_idx</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData.get_expansion-1422"><a href="#StarData.get_expansion-1422"><span class="linenos">1422</span></a>        
</span><span id="StarData.get_expansion-1423"><a href="#StarData.get_expansion-1423"><span class="linenos">1423</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1424"><a href="#StarData.get_expansion-1424"><span class="linenos">1424</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming coordinates...&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1425"><a href="#StarData.get_expansion-1425"><span class="linenos">1425</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1426"><a href="#StarData.get_expansion-1426"><span class="linenos">1426</span></a>        <span class="n">v_num</span><span class="p">,</span> <span class="n">y_num</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">new_shape</span>
</span><span id="StarData.get_expansion-1427"><a href="#StarData.get_expansion-1427"><span class="linenos">1427</span></a>
</span><span id="StarData.get_expansion-1428"><a href="#StarData.get_expansion-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1429"><a href="#StarData.get_expansion-1429"><span class="linenos">1429</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating grid for new object...&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1430"><a href="#StarData.get_expansion-1430"><span class="linenos">1430</span></a>        <span class="n">gridv</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
</span><span id="StarData.get_expansion-1431"><a href="#StarData.get_expansion-1431"><span class="linenos">1431</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">):</span><span class="n">v_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1432"><a href="#StarData.get_expansion-1432"><span class="linenos">1432</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span><span class="n">y_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1433"><a href="#StarData.get_expansion-1433"><span class="linenos">1433</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">):</span><span class="n">x_num</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
</span><span id="StarData.get_expansion-1434"><a href="#StarData.get_expansion-1434"><span class="linenos">1434</span></a>        <span class="p">]</span> 
</span><span id="StarData.get_expansion-1435"><a href="#StarData.get_expansion-1435"><span class="linenos">1435</span></a>
</span><span id="StarData.get_expansion-1436"><a href="#StarData.get_expansion-1436"><span class="linenos">1436</span></a>
</span><span id="StarData.get_expansion-1437"><a href="#StarData.get_expansion-1437"><span class="linenos">1437</span></a>        <span class="c1"># get preimage of grid</span>
</span><span id="StarData.get_expansion-1438"><a href="#StarData.get_expansion-1438"><span class="linenos">1438</span></a>        <span class="n">small_gridx</span> <span class="o">=</span> <span class="n">gridx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="StarData.get_expansion-1439"><a href="#StarData.get_expansion-1439"><span class="linenos">1439</span></a>        <span class="n">small_gridy</span> <span class="o">=</span> <span class="n">gridy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1440"><a href="#StarData.get_expansion-1440"><span class="linenos">1440</span></a>        <span class="n">small_gridv</span> <span class="o">=</span> <span class="n">gridv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData.get_expansion-1441"><a href="#StarData.get_expansion-1441"><span class="linenos">1441</span></a>
</span><span id="StarData.get_expansion-1442"><a href="#StarData.get_expansion-1442"><span class="linenos">1442</span></a>        <span class="c1"># go backwards with negative years</span>
</span><span id="StarData.get_expansion-1443"><a href="#StarData.get_expansion-1443"><span class="linenos">1443</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1444"><a href="#StarData.get_expansion-1444"><span class="linenos">1444</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shrinking grid to original data bounds...&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1445"><a href="#StarData.get_expansion-1445"><span class="linenos">1445</span></a>        <span class="n">prev_X</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_V</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_expansion_transform</span><span class="p">(</span><span class="n">small_gridx</span><span class="p">,</span> <span class="n">small_gridy</span><span class="p">,</span> <span class="n">small_gridv</span><span class="p">,</span> <span class="n">use_data</span><span class="p">,</span>  <span class="o">-</span><span class="n">years</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1446"><a href="#StarData.get_expansion-1446"><span class="linenos">1446</span></a>        
</span><span id="StarData.get_expansion-1447"><a href="#StarData.get_expansion-1447"><span class="linenos">1447</span></a>        
</span><span id="StarData.get_expansion-1448"><a href="#StarData.get_expansion-1448"><span class="linenos">1448</span></a>        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_V</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData.get_expansion-1449"><a href="#StarData.get_expansion-1449"><span class="linenos">1449</span></a>                <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_Y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData.get_expansion-1450"><a href="#StarData.get_expansion-1450"><span class="linenos">1450</span></a>                <span class="p">(</span><span class="n">prev_X</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">prev_X</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">|</span> \
</span><span id="StarData.get_expansion-1451"><a href="#StarData.get_expansion-1451"><span class="linenos">1451</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_V</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prev_Y</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1452"><a href="#StarData.get_expansion-1452"><span class="linenos">1452</span></a>        
</span><span id="StarData.get_expansion-1453"><a href="#StarData.get_expansion-1453"><span class="linenos">1453</span></a>        <span class="n">prev_V</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData.get_expansion-1454"><a href="#StarData.get_expansion-1454"><span class="linenos">1454</span></a>        <span class="n">prev_X</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData.get_expansion-1455"><a href="#StarData.get_expansion-1455"><span class="linenos">1455</span></a>        <span class="n">prev_Y</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData.get_expansion-1456"><a href="#StarData.get_expansion-1456"><span class="linenos">1456</span></a>
</span><span id="StarData.get_expansion-1457"><a href="#StarData.get_expansion-1457"><span class="linenos">1457</span></a>        <span class="c1"># interpolate regular data at these points</span>
</span><span id="StarData.get_expansion-1458"><a href="#StarData.get_expansion-1458"><span class="linenos">1458</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1459"><a href="#StarData.get_expansion-1459"><span class="linenos">1459</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating...&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1460"><a href="#StarData.get_expansion-1460"><span class="linenos">1460</span></a>        <span class="n">interp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">prev_V</span><span class="p">,</span> <span class="n">prev_Y</span><span class="p">,</span> <span class="n">prev_X</span><span class="p">))</span>
</span><span id="StarData.get_expansion-1461"><a href="#StarData.get_expansion-1461"><span class="linenos">1461</span></a>        <span class="n">interp_data</span> <span class="o">=</span> <span class="n">interpn</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">interp_points</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1462"><a href="#StarData.get_expansion-1462"><span class="linenos">1462</span></a>        <span class="n">interp_data</span><span class="p">[</span><span class="n">bad_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData.get_expansion-1463"><a href="#StarData.get_expansion-1463"><span class="linenos">1463</span></a>        <span class="n">new_data</span> <span class="o">=</span> <span class="n">interp_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gridx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1464"><a href="#StarData.get_expansion-1464"><span class="linenos">1464</span></a>
</span><span id="StarData.get_expansion-1465"><a href="#StarData.get_expansion-1465"><span class="linenos">1465</span></a>        <span class="n">non_nans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">new_data</span><span class="p">)])</span>
</span><span id="StarData.get_expansion-1466"><a href="#StarData.get_expansion-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1467"><a href="#StarData.get_expansion-1467"><span class="linenos">1467</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">non_nans</span><span class="si">}</span><span class="s2"> non-nan values remaining out of </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1468"><a href="#StarData.get_expansion-1468"><span class="linenos">1468</span></a>
</span><span id="StarData.get_expansion-1469"><a href="#StarData.get_expansion-1469"><span class="linenos">1469</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">CondensedData</span><span class="p">(</span>
</span><span id="StarData.get_expansion-1470"><a href="#StarData.get_expansion-1470"><span class="linenos">1470</span></a>            <span class="n">small_gridx</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1471"><a href="#StarData.get_expansion-1471"><span class="linenos">1471</span></a>            <span class="n">small_gridy</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1472"><a href="#StarData.get_expansion-1472"><span class="linenos">1472</span></a>            <span class="n">small_gridv</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1473"><a href="#StarData.get_expansion-1473"><span class="linenos">1473</span></a>            <span class="n">new_data</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1474"><a href="#StarData.get_expansion-1474"><span class="linenos">1474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1475"><a href="#StarData.get_expansion-1475"><span class="linenos">1475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1476"><a href="#StarData.get_expansion-1476"><span class="linenos">1476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_exp</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1477"><a href="#StarData.get_expansion-1477"><span class="linenos">1477</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">v_sys</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1478"><a href="#StarData.get_expansion-1478"><span class="linenos">1478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1479"><a href="#StarData.get_expansion-1479"><span class="linenos">1479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">r_dust</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1480"><a href="#StarData.get_expansion-1480"><span class="linenos">1480</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1481"><a href="#StarData.get_expansion-1481"><span class="linenos">1481</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1482"><a href="#StarData.get_expansion-1482"><span class="linenos">1482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1483"><a href="#StarData.get_expansion-1483"><span class="linenos">1483</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
</span><span id="StarData.get_expansion-1484"><a href="#StarData.get_expansion-1484"><span class="linenos">1484</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> 
</span><span id="StarData.get_expansion-1485"><a href="#StarData.get_expansion-1485"><span class="linenos">1485</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
</span><span id="StarData.get_expansion-1486"><a href="#StarData.get_expansion-1486"><span class="linenos">1486</span></a>        <span class="p">)</span>
</span><span id="StarData.get_expansion-1487"><a href="#StarData.get_expansion-1487"><span class="linenos">1487</span></a>
</span><span id="StarData.get_expansion-1488"><a href="#StarData.get_expansion-1488"><span class="linenos">1488</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.get_expansion-1489"><a href="#StarData.get_expansion-1489"><span class="linenos">1489</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time expansion process complete!&quot;</span><span class="p">)</span>
</span><span id="StarData.get_expansion-1490"><a href="#StarData.get_expansion-1490"><span class="linenos">1490</span></a>        <span class="k">return</span> <span class="n">info</span>
</span></pre></div>


            <div class="docstring"><p>Compute the expanded data cube after a given time interval.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>years</code> (<code>float</code> or <code>int</code>): Time interval in years.</li>
<li><code>v_func</code> (<code><a href="#VelocityModel">VelocityModel</a></code> or <code>None</code>): Velocity law function or None (default is None, which uses constant expansion velocity).</li>
<li><code>remove_centre</code> (<code>float</code> or <code>int</code> or <code>None</code>, optional): If not None, remove all points within this many beam widths of the centre (default is 2).</li>
<li><code>new_shape</code> (<code>tuple</code>, optional): Shape of the output grid (default is (50, 250, 250)).</li>
<li><code>verbose</code> (<code>bool</code>, optional): If True, print progress (default is False).</li>
</ul>

<p><strong>Returns</strong></p>

<ul>
<li><code>info</code> (<code><a href="#CondensedData">CondensedData</a></code>): CondensedData object containing the expanded data and metadata.</li>
</ul>
</div>


                            </div>
                            <div id="StarData.plot_velocity_vs_intensity" class="classattr">
                                        <input id="StarData.plot_velocity_vs_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_velocity_vs_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StarData.plot_velocity_vs_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.plot_velocity_vs_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.plot_velocity_vs_intensity-1495"><a href="#StarData.plot_velocity_vs_intensity-1495"><span class="linenos">1495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_velocity_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_velocity_vs_intensity-1496"><a href="#StarData.plot_velocity_vs_intensity-1496"><span class="linenos">1496</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.plot_velocity_vs_intensity-1497"><a href="#StarData.plot_velocity_vs_intensity-1497"><span class="linenos">1497</span></a><span class="sd">        Plot velocity vs. intensity at the center of the xy plane.</span>
</span><span id="StarData.plot_velocity_vs_intensity-1498"><a href="#StarData.plot_velocity_vs_intensity-1498"><span class="linenos">1498</span></a>
</span><span id="StarData.plot_velocity_vs_intensity-1499"><a href="#StarData.plot_velocity_vs_intensity-1499"><span class="linenos">1499</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.plot_velocity_vs_intensity-1500"><a href="#StarData.plot_velocity_vs_intensity-1500"><span class="linenos">1500</span></a>
</span><span id="StarData.plot_velocity_vs_intensity-1501"><a href="#StarData.plot_velocity_vs_intensity-1501"><span class="linenos">1501</span></a><span class="sd">        - `fit_parabola` (`bool`, optional): If True, fit and plot a parabola (default is True).</span>
</span><span id="StarData.plot_velocity_vs_intensity-1502"><a href="#StarData.plot_velocity_vs_intensity-1502"><span class="linenos">1502</span></a>
</span><span id="StarData.plot_velocity_vs_intensity-1503"><a href="#StarData.plot_velocity_vs_intensity-1503"><span class="linenos">1503</span></a><span class="sd">        **Notes**</span>
</span><span id="StarData.plot_velocity_vs_intensity-1504"><a href="#StarData.plot_velocity_vs_intensity-1504"><span class="linenos">1504</span></a>
</span><span id="StarData.plot_velocity_vs_intensity-1505"><a href="#StarData.plot_velocity_vs_intensity-1505"><span class="linenos">1505</span></a><span class="sd">        The well-fittedness of the parabola can help you visually determine </span>
</span><span id="StarData.plot_velocity_vs_intensity-1506"><a href="#StarData.plot_velocity_vs_intensity-1506"><span class="linenos">1506</span></a><span class="sd">        the accuracy of the calculated systemic and expansion velocity.</span>
</span><span id="StarData.plot_velocity_vs_intensity-1507"><a href="#StarData.plot_velocity_vs_intensity-1507"><span class="linenos">1507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.plot_velocity_vs_intensity-1508"><a href="#StarData.plot_velocity_vs_intensity-1508"><span class="linenos">1508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_star_and_exp_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_parabola</span><span class="o">=</span><span class="n">fit_parabola</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot velocity vs. intensity at the center of the xy plane.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>fit_parabola</code> (<code>bool</code>, optional): If True, fit and plot a parabola (default is True).</li>
</ul>

<p><strong>Notes</strong></p>

<p>The well-fittedness of the parabola can help you visually determine 
the accuracy of the calculated systemic and expansion velocity.</p>
</div>


                            </div>
                            <div id="StarData.plot_radius_vs_intensity" class="classattr">
                                        <input id="StarData.plot_radius_vs_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_radius_vs_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StarData.plot_radius_vs_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.plot_radius_vs_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.plot_radius_vs_intensity-1510"><a href="#StarData.plot_radius_vs_intensity-1510"><span class="linenos">1510</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_radius_vs_intensity-1511"><a href="#StarData.plot_radius_vs_intensity-1511"><span class="linenos">1511</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.plot_radius_vs_intensity-1512"><a href="#StarData.plot_radius_vs_intensity-1512"><span class="linenos">1512</span></a><span class="sd">        Plot radius vs. intensity at the center of the xy plane.</span>
</span><span id="StarData.plot_radius_vs_intensity-1513"><a href="#StarData.plot_radius_vs_intensity-1513"><span class="linenos">1513</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.plot_radius_vs_intensity-1514"><a href="#StarData.plot_radius_vs_intensity-1514"><span class="linenos">1514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_intensities</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot radius vs. intensity at the center of the xy plane.</p>
</div>


                            </div>
                            <div id="StarData.plot_radius_vs_velocity" class="classattr">
                                        <input id="StarData.plot_radius_vs_velocity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_radius_vs_velocity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fit_beta_law</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StarData.plot_radius_vs_velocity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.plot_radius_vs_velocity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.plot_radius_vs_velocity-1516"><a href="#StarData.plot_radius_vs_velocity-1516"><span class="linenos">1516</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_radius_vs_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_beta_law</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_radius_vs_velocity-1517"><a href="#StarData.plot_radius_vs_velocity-1517"><span class="linenos">1517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.plot_radius_vs_velocity-1518"><a href="#StarData.plot_radius_vs_velocity-1518"><span class="linenos">1518</span></a><span class="sd">        Plot radius vs. velocity at the center of the xy plane.</span>
</span><span id="StarData.plot_radius_vs_velocity-1519"><a href="#StarData.plot_radius_vs_velocity-1519"><span class="linenos">1519</span></a>
</span><span id="StarData.plot_radius_vs_velocity-1520"><a href="#StarData.plot_radius_vs_velocity-1520"><span class="linenos">1520</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.plot_radius_vs_velocity-1521"><a href="#StarData.plot_radius_vs_velocity-1521"><span class="linenos">1521</span></a>
</span><span id="StarData.plot_radius_vs_velocity-1522"><a href="#StarData.plot_radius_vs_velocity-1522"><span class="linenos">1522</span></a><span class="sd">        - `fit_beta_law` (`bool`, optional): If True, fit and plot the beta law (default is True).</span>
</span><span id="StarData.plot_radius_vs_velocity-1523"><a href="#StarData.plot_radius_vs_velocity-1523"><span class="linenos">1523</span></a>
</span><span id="StarData.plot_radius_vs_velocity-1524"><a href="#StarData.plot_radius_vs_velocity-1524"><span class="linenos">1524</span></a><span class="sd">        **Notes**</span>
</span><span id="StarData.plot_radius_vs_velocity-1525"><a href="#StarData.plot_radius_vs_velocity-1525"><span class="linenos">1525</span></a>
</span><span id="StarData.plot_radius_vs_velocity-1526"><a href="#StarData.plot_radius_vs_velocity-1526"><span class="linenos">1526</span></a><span class="sd">        The well-fittedness of the beta law curve can help you visually determine </span>
</span><span id="StarData.plot_radius_vs_velocity-1527"><a href="#StarData.plot_radius_vs_velocity-1527"><span class="linenos">1527</span></a><span class="sd">        the accuracy of the calculated beta law parameters.</span>
</span><span id="StarData.plot_radius_vs_velocity-1528"><a href="#StarData.plot_radius_vs_velocity-1528"><span class="linenos">1528</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.plot_radius_vs_velocity-1529"><a href="#StarData.plot_radius_vs_velocity-1529"><span class="linenos">1529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__get_beta_law</span><span class="p">(</span><span class="n">plot_velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_beta_law</span><span class="o">=</span><span class="n">fit_beta_law</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot radius vs. velocity at the center of the xy plane.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>fit_beta_law</code> (<code>bool</code>, optional): If True, fit and plot the beta law (default is True).</li>
</ul>

<p><strong>Notes</strong></p>

<p>The well-fittedness of the beta law curve can help you visually determine 
the accuracy of the calculated beta law parameters.</p>
</div>


                            </div>
                            <div id="StarData.plot_channel_maps" class="classattr">
                                        <input id="StarData.plot_channel_maps-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_channel_maps</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">dimensions</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">include_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">text_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">beam_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StarData.plot_channel_maps-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.plot_channel_maps"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.plot_channel_maps-1531"><a href="#StarData.plot_channel_maps-1531"><span class="linenos">1531</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_channel_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1532"><a href="#StarData.plot_channel_maps-1532"><span class="linenos">1532</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1533"><a href="#StarData.plot_channel_maps-1533"><span class="linenos">1533</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1534"><a href="#StarData.plot_channel_maps-1534"><span class="linenos">1534</span></a>        <span class="n">dimensions</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1535"><a href="#StarData.plot_channel_maps-1535"><span class="linenos">1535</span></a>        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1536"><a href="#StarData.plot_channel_maps-1536"><span class="linenos">1536</span></a>        <span class="n">end</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1537"><a href="#StarData.plot_channel_maps-1537"><span class="linenos">1537</span></a>        <span class="n">include_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1538"><a href="#StarData.plot_channel_maps-1538"><span class="linenos">1538</span></a>        <span class="n">text_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1539"><a href="#StarData.plot_channel_maps-1539"><span class="linenos">1539</span></a>        <span class="n">beam_pos</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1540"><a href="#StarData.plot_channel_maps-1540"><span class="linenos">1540</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_channel_maps-1541"><a href="#StarData.plot_channel_maps-1541"><span class="linenos">1541</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span>
</span><span id="StarData.plot_channel_maps-1542"><a href="#StarData.plot_channel_maps-1542"><span class="linenos">1542</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1543"><a href="#StarData.plot_channel_maps-1543"><span class="linenos">1543</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.plot_channel_maps-1544"><a href="#StarData.plot_channel_maps-1544"><span class="linenos">1544</span></a><span class="sd">        Plot the data cube as a set of 2D channel maps.</span>
</span><span id="StarData.plot_channel_maps-1545"><a href="#StarData.plot_channel_maps-1545"><span class="linenos">1545</span></a>
</span><span id="StarData.plot_channel_maps-1546"><a href="#StarData.plot_channel_maps-1546"><span class="linenos">1546</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.plot_channel_maps-1547"><a href="#StarData.plot_channel_maps-1547"><span class="linenos">1547</span></a>
</span><span id="StarData.plot_channel_maps-1548"><a href="#StarData.plot_channel_maps-1548"><span class="linenos">1548</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="StarData.plot_channel_maps-1549"><a href="#StarData.plot_channel_maps-1549"><span class="linenos">1549</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="StarData.plot_channel_maps-1550"><a href="#StarData.plot_channel_maps-1550"><span class="linenos">1550</span></a><span class="sd">        - `dimensions` (`tuple` of `int` or `None`, optional): Grid dimensions (nrows, ncols) for subplots (default is None).</span>
</span><span id="StarData.plot_channel_maps-1551"><a href="#StarData.plot_channel_maps-1551"><span class="linenos">1551</span></a><span class="sd">        - `start` (`int`, optional): Starting velocity channel index (default is 0).</span>
</span><span id="StarData.plot_channel_maps-1552"><a href="#StarData.plot_channel_maps-1552"><span class="linenos">1552</span></a><span class="sd">        - `end` (`int` or `None`, optional): Ending velocity channel index (default is None).</span>
</span><span id="StarData.plot_channel_maps-1553"><a href="#StarData.plot_channel_maps-1553"><span class="linenos">1553</span></a><span class="sd">        - `include_beam` (`bool`, optional): If True, plot the beam ellipse (default is True).</span>
</span><span id="StarData.plot_channel_maps-1554"><a href="#StarData.plot_channel_maps-1554"><span class="linenos">1554</span></a><span class="sd">        - `text_pos` (`tuple` of `float` or `None`, optional): Position for velocity text annotation (default is None).</span>
</span><span id="StarData.plot_channel_maps-1555"><a href="#StarData.plot_channel_maps-1555"><span class="linenos">1555</span></a><span class="sd">        - `beam_pos` (`tuple` of `float` or `None`, optional): Position for beam ellipse (default is None).</span>
</span><span id="StarData.plot_channel_maps-1556"><a href="#StarData.plot_channel_maps-1556"><span class="linenos">1556</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the name of the star).</span>
</span><span id="StarData.plot_channel_maps-1557"><a href="#StarData.plot_channel_maps-1557"><span class="linenos">1557</span></a><span class="sd">        - `cmap` (`str`, optional): Colormap for the plot (default is &quot;viridis&quot;). See https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
</span><span id="StarData.plot_channel_maps-1558"><a href="#StarData.plot_channel_maps-1558"><span class="linenos">1558</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.plot_channel_maps-1559"><a href="#StarData.plot_channel_maps-1559"><span class="linenos">1559</span></a>
</span><span id="StarData.plot_channel_maps-1560"><a href="#StarData.plot_channel_maps-1560"><span class="linenos">1560</span></a>        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1561"><a href="#StarData.plot_channel_maps-1561"><span class="linenos">1561</span></a>            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="StarData.plot_channel_maps-1562"><a href="#StarData.plot_channel_maps-1562"><span class="linenos">1562</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1563"><a href="#StarData.plot_channel_maps-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="StarData.plot_channel_maps-1564"><a href="#StarData.plot_channel_maps-1564"><span class="linenos">1564</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="StarData.plot_channel_maps-1565"><a href="#StarData.plot_channel_maps-1565"><span class="linenos">1565</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the end of the data</span>
</span><span id="StarData.plot_channel_maps-1566"><a href="#StarData.plot_channel_maps-1566"><span class="linenos">1566</span></a>                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> 
</span><span id="StarData.plot_channel_maps-1567"><a href="#StarData.plot_channel_maps-1567"><span class="linenos">1567</span></a>
</span><span id="StarData.plot_channel_maps-1568"><a href="#StarData.plot_channel_maps-1568"><span class="linenos">1568</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1569"><a href="#StarData.plot_channel_maps-1569"><span class="linenos">1569</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1570"><a href="#StarData.plot_channel_maps-1570"><span class="linenos">1570</span></a>            <span class="k">if</span> <span class="n">filter_beam</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1571"><a href="#StarData.plot_channel_maps-1571"><span class="linenos">1571</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1572"><a href="#StarData.plot_channel_maps-1572"><span class="linenos">1572</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1573"><a href="#StarData.plot_channel_maps-1573"><span class="linenos">1573</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData.plot_channel_maps-1574"><a href="#StarData.plot_channel_maps-1574"><span class="linenos">1574</span></a>        
</span><span id="StarData.plot_channel_maps-1575"><a href="#StarData.plot_channel_maps-1575"><span class="linenos">1575</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#invalid so set to the start of the data</span>
</span><span id="StarData.plot_channel_maps-1576"><a href="#StarData.plot_channel_maps-1576"><span class="linenos">1576</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="StarData.plot_channel_maps-1577"><a href="#StarData.plot_channel_maps-1577"><span class="linenos">1577</span></a>
</span><span id="StarData.plot_channel_maps-1578"><a href="#StarData.plot_channel_maps-1578"><span class="linenos">1578</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1579"><a href="#StarData.plot_channel_maps-1579"><span class="linenos">1579</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span> <span class="o">+</span> <span class="s2">&quot; channel maps&quot;</span>
</span><span id="StarData.plot_channel_maps-1580"><a href="#StarData.plot_channel_maps-1580"><span class="linenos">1580</span></a>
</span><span id="StarData.plot_channel_maps-1581"><a href="#StarData.plot_channel_maps-1581"><span class="linenos">1581</span></a>        <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1582"><a href="#StarData.plot_channel_maps-1582"><span class="linenos">1582</span></a>            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">dimensions</span>
</span><span id="StarData.plot_channel_maps-1583"><a href="#StarData.plot_channel_maps-1583"><span class="linenos">1583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1584"><a href="#StarData.plot_channel_maps-1584"><span class="linenos">1584</span></a>            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)))</span>
</span><span id="StarData.plot_channel_maps-1585"><a href="#StarData.plot_channel_maps-1585"><span class="linenos">1585</span></a>            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nrows</span><span class="p">))</span>
</span><span id="StarData.plot_channel_maps-1586"><a href="#StarData.plot_channel_maps-1586"><span class="linenos">1586</span></a>
</span><span id="StarData.plot_channel_maps-1587"><a href="#StarData.plot_channel_maps-1587"><span class="linenos">1587</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1588"><a href="#StarData.plot_channel_maps-1588"><span class="linenos">1588</span></a>        <span class="n">viridis</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">]</span>
</span><span id="StarData.plot_channel_maps-1589"><a href="#StarData.plot_channel_maps-1589"><span class="linenos">1589</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1590"><a href="#StarData.plot_channel_maps-1590"><span class="linenos">1590</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Right Ascension (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1591"><a href="#StarData.plot_channel_maps-1591"><span class="linenos">1591</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Declination (Arcseconds)&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1592"><a href="#StarData.plot_channel_maps-1592"><span class="linenos">1592</span></a>
</span><span id="StarData.plot_channel_maps-1593"><a href="#StarData.plot_channel_maps-1593"><span class="linenos">1593</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">start</span>
</span><span id="StarData.plot_channel_maps-1594"><a href="#StarData.plot_channel_maps-1594"><span class="linenos">1594</span></a>        <span class="n">extents</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_to_star</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1595"><a href="#StarData.plot_channel_maps-1595"><span class="linenos">1595</span></a>        
</span><span id="StarData.plot_channel_maps-1596"><a href="#StarData.plot_channel_maps-1596"><span class="linenos">1596</span></a>        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StarData.plot_channel_maps-1597"><a href="#StarData.plot_channel_maps-1597"><span class="linenos">1597</span></a>        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1598"><a href="#StarData.plot_channel_maps-1598"><span class="linenos">1598</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1599"><a href="#StarData.plot_channel_maps-1599"><span class="linenos">1599</span></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]),</span> <span class="n">extent</span><span class="o">=</span><span class="n">extents</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1600"><a href="#StarData.plot_channel_maps-1600"><span class="linenos">1600</span></a>
</span><span id="StarData.plot_channel_maps-1601"><a href="#StarData.plot_channel_maps-1601"><span class="linenos">1601</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">viridis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="StarData.plot_channel_maps-1602"><a href="#StarData.plot_channel_maps-1602"><span class="linenos">1602</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1603"><a href="#StarData.plot_channel_maps-1603"><span class="linenos">1603</span></a>
</span><span id="StarData.plot_channel_maps-1604"><a href="#StarData.plot_channel_maps-1604"><span class="linenos">1604</span></a>                <span class="k">if</span> <span class="n">text_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1605"><a href="#StarData.plot_channel_maps-1605"><span class="linenos">1605</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1606"><a href="#StarData.plot_channel_maps-1606"><span class="linenos">1606</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1607"><a href="#StarData.plot_channel_maps-1607"><span class="linenos">1607</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">text_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1608"><a href="#StarData.plot_channel_maps-1608"><span class="linenos">1608</span></a>
</span><span id="StarData.plot_channel_maps-1609"><a href="#StarData.plot_channel_maps-1609"><span class="linenos">1609</span></a>                <span class="k">if</span> <span class="n">include_beam</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1610"><a href="#StarData.plot_channel_maps-1610"><span class="linenos">1610</span></a>                    <span class="n">bmaj</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1611"><a href="#StarData.plot_channel_maps-1611"><span class="linenos">1611</span></a>                    <span class="n">bmin</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1612"><a href="#StarData.plot_channel_maps-1612"><span class="linenos">1612</span></a>                    <span class="n">bpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_angle</span>
</span><span id="StarData.plot_channel_maps-1613"><a href="#StarData.plot_channel_maps-1613"><span class="linenos">1613</span></a>
</span><span id="StarData.plot_channel_maps-1614"><a href="#StarData.plot_channel_maps-1614"><span class="linenos">1614</span></a>                    <span class="k">if</span> <span class="n">beam_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1615"><a href="#StarData.plot_channel_maps-1615"><span class="linenos">1615</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1616"><a href="#StarData.plot_channel_maps-1616"><span class="linenos">1616</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1617"><a href="#StarData.plot_channel_maps-1617"><span class="linenos">1617</span></a>                        <span class="n">ellipse_artist</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">beam_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">width</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span><span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1618"><a href="#StarData.plot_channel_maps-1618"><span class="linenos">1618</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ellipse_artist</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1619"><a href="#StarData.plot_channel_maps-1619"><span class="linenos">1619</span></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="StarData.plot_channel_maps-1620"><a href="#StarData.plot_channel_maps-1620"><span class="linenos">1620</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">):</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StarData.plot_channel_maps-1621"><a href="#StarData.plot_channel_maps-1621"><span class="linenos">1621</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_channel_maps-1622"><a href="#StarData.plot_channel_maps-1622"><span class="linenos">1622</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1623"><a href="#StarData.plot_channel_maps-1623"><span class="linenos">1623</span></a>        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</span><span id="StarData.plot_channel_maps-1624"><a href="#StarData.plot_channel_maps-1624"><span class="linenos">1624</span></a>        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux Density (Jy/Beam)&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_channel_maps-1625"><a href="#StarData.plot_channel_maps-1625"><span class="linenos">1625</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the data cube as a set of 2D channel maps.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>filter_stds</code> (<code>float</code> or <code>int</code> or <code>None</code>, optional): Number of standard deviations to filter by (default is None).</li>
<li><code>filter_beam</code> (<code>bool</code>, optional): If True, apply beam filtering (default is False).</li>
<li><code>dimensions</code> (<code>tuple</code> of <code>int</code> or <code>None</code>, optional): Grid dimensions (nrows, ncols) for subplots (default is None).</li>
<li><code>start</code> (<code>int</code>, optional): Starting velocity channel index (default is 0).</li>
<li><code>end</code> (<code>int</code> or <code>None</code>, optional): Ending velocity channel index (default is None).</li>
<li><code>include_beam</code> (<code>bool</code>, optional): If True, plot the beam ellipse (default is True).</li>
<li><code>text_pos</code> (<code>tuple</code> of <code>float</code> or <code>None</code>, optional): Position for velocity text annotation (default is None).</li>
<li><code>beam_pos</code> (<code>tuple</code> of <code>float</code> or <code>None</code>, optional): Position for beam ellipse (default is None).</li>
<li><code>title</code> (<code>str</code> or <code>None</code>, optional): Plot title (default is None, which uses the name of the star).</li>
<li><code>cmap</code> (<code>str</code>, optional): Colormap for the plot (default is "viridis"). See <a href="https://matplotlib.org/stable/users/explain/colors/colormaps.html">https://matplotlib.org/stable/users/explain/colors/colormaps.html</a></li>
</ul>
</div>


                            </div>
                            <div id="StarData.create_mask" class="classattr">
                                        <input id="StarData.create_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">savefile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">initial_crop</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StarData.create_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.create_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.create_mask-1627"><a href="#StarData.create_mask-1627"><span class="linenos">1627</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">savefile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial_crop</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="StarData.create_mask-1628"><a href="#StarData.create_mask-1628"><span class="linenos">1628</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.create_mask-1629"><a href="#StarData.create_mask-1629"><span class="linenos">1629</span></a><span class="sd">        Launch an interactive mask creator for the data cube.</span>
</span><span id="StarData.create_mask-1630"><a href="#StarData.create_mask-1630"><span class="linenos">1630</span></a>
</span><span id="StarData.create_mask-1631"><a href="#StarData.create_mask-1631"><span class="linenos">1631</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.create_mask-1632"><a href="#StarData.create_mask-1632"><span class="linenos">1632</span></a>
</span><span id="StarData.create_mask-1633"><a href="#StarData.create_mask-1633"><span class="linenos">1633</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to initially filter by (default is None).</span>
</span><span id="StarData.create_mask-1634"><a href="#StarData.create_mask-1634"><span class="linenos">1634</span></a><span class="sd">        - `savefile` (`str` or `None`, optional): Filename to save the selected mask (default is None). Should end in .npy.</span>
</span><span id="StarData.create_mask-1635"><a href="#StarData.create_mask-1635"><span class="linenos">1635</span></a><span class="sd">        - `initial_crop` (`tuple` or `None`, optional): Initial crop region as (v_lo, v_hi, y_lo, y_hi, x_lo, x_hi), using channel indices (default is None).</span>
</span><span id="StarData.create_mask-1636"><a href="#StarData.create_mask-1636"><span class="linenos">1636</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.create_mask-1637"><a href="#StarData.create_mask-1637"><span class="linenos">1637</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.create_mask-1638"><a href="#StarData.create_mask-1638"><span class="linenos">1638</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_data</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">)</span>
</span><span id="StarData.create_mask-1639"><a href="#StarData.create_mask-1639"><span class="linenos">1639</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.create_mask-1640"><a href="#StarData.create_mask-1640"><span class="linenos">1640</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="StarData.create_mask-1641"><a href="#StarData.create_mask-1641"><span class="linenos">1641</span></a>
</span><span id="StarData.create_mask-1642"><a href="#StarData.create_mask-1642"><span class="linenos">1642</span></a>        <span class="k">if</span> <span class="n">initial_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.create_mask-1643"><a href="#StarData.create_mask-1643"><span class="linenos">1643</span></a>            <span class="n">v_lo</span><span class="p">,</span> <span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">initial_crop</span>
</span><span id="StarData.create_mask-1644"><a href="#StarData.create_mask-1644"><span class="linenos">1644</span></a>            <span class="n">new_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span>
</span><span id="StarData.create_mask-1645"><a href="#StarData.create_mask-1645"><span class="linenos">1645</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</span><span id="StarData.create_mask-1646"><a href="#StarData.create_mask-1646"><span class="linenos">1646</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData.create_mask-1647"><a href="#StarData.create_mask-1647"><span class="linenos">1647</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="StarData.create_mask-1648"><a href="#StarData.create_mask-1648"><span class="linenos">1648</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">v_lo</span><span class="p">:</span><span class="n">v_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">:</span><span class="n">y_hi</span><span class="p">,</span> <span class="n">x_lo</span><span class="p">:</span><span class="n">x_hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="StarData.create_mask-1649"><a href="#StarData.create_mask-1649"><span class="linenos">1649</span></a>
</span><span id="StarData.create_mask-1650"><a href="#StarData.create_mask-1650"><span class="linenos">1650</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.create_mask-1651"><a href="#StarData.create_mask-1651"><span class="linenos">1651</span></a>            <span class="n">selector</span> <span class="o">=</span> <span class="n">_PointsSelector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="StarData.create_mask-1652"><a href="#StarData.create_mask-1652"><span class="linenos">1652</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="StarData.create_mask-1653"><a href="#StarData.create_mask-1653"><span class="linenos">1653</span></a>        
</span><span id="StarData.create_mask-1654"><a href="#StarData.create_mask-1654"><span class="linenos">1654</span></a>            <span class="c1"># mask is complete now</span>
</span><span id="StarData.create_mask-1655"><a href="#StarData.create_mask-1655"><span class="linenos">1655</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">mask</span>
</span><span id="StarData.create_mask-1656"><a href="#StarData.create_mask-1656"><span class="linenos">1656</span></a>        
</span><span id="StarData.create_mask-1657"><a href="#StarData.create_mask-1657"><span class="linenos">1657</span></a>        <span class="c1"># save mask</span>
</span><span id="StarData.create_mask-1658"><a href="#StarData.create_mask-1658"><span class="linenos">1658</span></a>        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.create_mask-1659"><a href="#StarData.create_mask-1659"><span class="linenos">1659</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Launch an interactive mask creator for the data cube.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>filter_stds</code> (<code>float</code> or <code>int</code> or <code>None</code>, optional): Number of standard deviations to initially filter by (default is None).</li>
<li><code>savefile</code> (<code>str</code> or <code>None</code>, optional): Filename to save the selected mask (default is None). Should end in .npy.</li>
<li><code>initial_crop</code> (<code>tuple</code> or <code>None</code>, optional): Initial crop region as (v_lo, v_hi, y_lo, y_hi, x_lo, x_hi), using channel indices (default is None).</li>
</ul>
</div>


                            </div>
                            <div id="StarData.plot_3D" class="classattr">
                                        <input id="StarData.plot_3D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_3D</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">z_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">num_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">opacityscale</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>,</span><span class="param">	<span class="n">colorscale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span>,</span><span class="param">	<span class="n">v_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span>,</span><span class="param">	<span class="n">camera_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StarData.plot_3D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StarData.plot_3D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StarData.plot_3D-1661"><a href="#StarData.plot_3D-1661"><span class="linenos">1661</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_3D</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1662"><a href="#StarData.plot_3D-1662"><span class="linenos">1662</span></a>        <span class="bp">self</span><span class="p">,</span> 
</span><span id="StarData.plot_3D-1663"><a href="#StarData.plot_3D-1663"><span class="linenos">1663</span></a>        <span class="n">filter_stds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_3D-1664"><a href="#StarData.plot_3D-1664"><span class="linenos">1664</span></a>        <span class="n">filter_beam</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="StarData.plot_3D-1665"><a href="#StarData.plot_3D-1665"><span class="linenos">1665</span></a>        <span class="n">z_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1666"><a href="#StarData.plot_3D-1666"><span class="linenos">1666</span></a>        <span class="n">crop_leeway</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1667"><a href="#StarData.plot_3D-1667"><span class="linenos">1667</span></a>        <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1668"><a href="#StarData.plot_3D-1668"><span class="linenos">1668</span></a>        <span class="n">num_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1669"><a href="#StarData.plot_3D-1669"><span class="linenos">1669</span></a>        <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1670"><a href="#StarData.plot_3D-1670"><span class="linenos">1670</span></a>        <span class="n">opacityscale</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
</span><span id="StarData.plot_3D-1671"><a href="#StarData.plot_3D-1671"><span class="linenos">1671</span></a>        <span class="n">colorscale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1672"><a href="#StarData.plot_3D-1672"><span class="linenos">1672</span></a>        <span class="n">v_func</span><span class="p">:</span> <span class="n">VelocityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="StarData.plot_3D-1673"><a href="#StarData.plot_3D-1673"><span class="linenos">1673</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1674"><a href="#StarData.plot_3D-1674"><span class="linenos">1674</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1675"><a href="#StarData.plot_3D-1675"><span class="linenos">1675</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1676"><a href="#StarData.plot_3D-1676"><span class="linenos">1676</span></a>        <span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1677"><a href="#StarData.plot_3D-1677"><span class="linenos">1677</span></a>        <span class="n">camera_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="StarData.plot_3D-1678"><a href="#StarData.plot_3D-1678"><span class="linenos">1678</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1679"><a href="#StarData.plot_3D-1679"><span class="linenos">1679</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StarData.plot_3D-1680"><a href="#StarData.plot_3D-1680"><span class="linenos">1680</span></a><span class="sd">        Plot a 3D volume rendering of the data cube using Plotly.</span>
</span><span id="StarData.plot_3D-1681"><a href="#StarData.plot_3D-1681"><span class="linenos">1681</span></a>
</span><span id="StarData.plot_3D-1682"><a href="#StarData.plot_3D-1682"><span class="linenos">1682</span></a><span class="sd">        **Parameters**</span>
</span><span id="StarData.plot_3D-1683"><a href="#StarData.plot_3D-1683"><span class="linenos">1683</span></a>
</span><span id="StarData.plot_3D-1684"><a href="#StarData.plot_3D-1684"><span class="linenos">1684</span></a><span class="sd">        - `filter_stds` (`float` or `int` or `None`, optional): Number of standard deviations to filter by (default is None).</span>
</span><span id="StarData.plot_3D-1685"><a href="#StarData.plot_3D-1685"><span class="linenos">1685</span></a><span class="sd">        - `filter_beam` (`bool`, optional): If True, apply beam filtering (default is False).</span>
</span><span id="StarData.plot_3D-1686"><a href="#StarData.plot_3D-1686"><span class="linenos">1686</span></a><span class="sd">        - `z_cutoff` (`float` or `None`, optional): Cutoff for z values as a proportion of the largest x, y values (default is 1).</span>
</span><span id="StarData.plot_3D-1687"><a href="#StarData.plot_3D-1687"><span class="linenos">1687</span></a><span class="sd">        - `crop_leeway` (`int` or `float`, optional): Fractional leeway to expand the crop region (default is 0).</span>
</span><span id="StarData.plot_3D-1688"><a href="#StarData.plot_3D-1688"><span class="linenos">1688</span></a><span class="sd">        - `num_points` (`int`, optional): Number of points in each dimension for the grid (default is 50).</span>
</span><span id="StarData.plot_3D-1689"><a href="#StarData.plot_3D-1689"><span class="linenos">1689</span></a><span class="sd">        - `num_surfaces` (`int`, optional): Number of surfaces to draw when rendering the plot (default is 50).</span>
</span><span id="StarData.plot_3D-1690"><a href="#StarData.plot_3D-1690"><span class="linenos">1690</span></a><span class="sd">        - `opacity` (`float` or `int`, optional): Opacity of the volume rendering (default is 0.5).</span>
</span><span id="StarData.plot_3D-1691"><a href="#StarData.plot_3D-1691"><span class="linenos">1691</span></a><span class="sd">        - `opacityscale` (`list` of `list` of `float`, optional): Opacity scale, see https://plotly.com/python-api-reference/generated/plotly.graph_objects.Volume.html (default is [[0, 0], [1, 1]]).</span>
</span><span id="StarData.plot_3D-1692"><a href="#StarData.plot_3D-1692"><span class="linenos">1692</span></a><span class="sd">        - `colorscale` (`str`, optional): Colormap for the plot, see https://plotly.com/python/builtin-colorscales/ (default is &quot;Reds&quot;).</span>
</span><span id="StarData.plot_3D-1693"><a href="#StarData.plot_3D-1693"><span class="linenos">1693</span></a><span class="sd">        - `v_func` (`VelocityModel` or `None`, optional): Velocity law function (default is None, which uses constant expansion velocity).</span>
</span><span id="StarData.plot_3D-1694"><a href="#StarData.plot_3D-1694"><span class="linenos">1694</span></a><span class="sd">        - `verbose` (`bool`, optional): If True, print progress (default is False).</span>
</span><span id="StarData.plot_3D-1695"><a href="#StarData.plot_3D-1695"><span class="linenos">1695</span></a><span class="sd">        - `title` (`str` or `None`, optional): Plot title (default is None, which uses the star name).</span>
</span><span id="StarData.plot_3D-1696"><a href="#StarData.plot_3D-1696"><span class="linenos">1696</span></a><span class="sd">        - `folder` (`str` or `None`, optional): If provided, generates successive frames and saves as png files to this folder (default is None).</span>
</span><span id="StarData.plot_3D-1697"><a href="#StarData.plot_3D-1697"><span class="linenos">1697</span></a><span class="sd">        - `num_angles` (`int`, optional): Number of angles for saving images (default is 24). Greater values give smoother animation.</span>
</span><span id="StarData.plot_3D-1698"><a href="#StarData.plot_3D-1698"><span class="linenos">1698</span></a><span class="sd">        - `camera_dist` (`float` or `int`, optional): Camera radius to use if generating frames (default is 2).</span>
</span><span id="StarData.plot_3D-1699"><a href="#StarData.plot_3D-1699"><span class="linenos">1699</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StarData.plot_3D-1700"><a href="#StarData.plot_3D-1700"><span class="linenos">1700</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1701"><a href="#StarData.plot_3D-1701"><span class="linenos">1701</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial filter and crop...&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1702"><a href="#StarData.plot_3D-1702"><span class="linenos">1702</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_and_crop</span><span class="p">(</span><span class="n">filter_stds</span><span class="p">,</span> <span class="n">filter_beam</span><span class="p">,</span> <span class="n">crop_leeway</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1703"><a href="#StarData.plot_3D-1703"><span class="linenos">1703</span></a>        
</span><span id="StarData.plot_3D-1704"><a href="#StarData.plot_3D-1704"><span class="linenos">1704</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1705"><a href="#StarData.plot_3D-1705"><span class="linenos">1705</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_name</span>
</span><span id="StarData.plot_3D-1706"><a href="#StarData.plot_3D-1706"><span class="linenos">1706</span></a>
</span><span id="StarData.plot_3D-1707"><a href="#StarData.plot_3D-1707"><span class="linenos">1707</span></a>        <span class="c1"># get small 1d arrays</span>
</span><span id="StarData.plot_3D-1708"><a href="#StarData.plot_3D-1708"><span class="linenos">1708</span></a>        <span class="n">x_small</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="StarData.plot_3D-1709"><a href="#StarData.plot_3D-1709"><span class="linenos">1709</span></a>        <span class="n">y_small</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData.plot_3D-1710"><a href="#StarData.plot_3D-1710"><span class="linenos">1710</span></a>        <span class="n">v_small</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="StarData.plot_3D-1711"><a href="#StarData.plot_3D-1711"><span class="linenos">1711</span></a>
</span><span id="StarData.plot_3D-1712"><a href="#StarData.plot_3D-1712"><span class="linenos">1712</span></a>        <span class="c1"># interpolate to grid</span>
</span><span id="StarData.plot_3D-1713"><a href="#StarData.plot_3D-1713"><span class="linenos">1713</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1714"><a href="#StarData.plot_3D-1714"><span class="linenos">1714</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolating to grid...&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1715"><a href="#StarData.plot_3D-1715"><span class="linenos">1715</span></a>
</span><span id="StarData.plot_3D-1716"><a href="#StarData.plot_3D-1716"><span class="linenos">1716</span></a>        <span class="n">z_bound</span> <span class="o">=</span> <span class="n">z_cutoff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_small</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_small</span><span class="p">)))</span>
</span><span id="StarData.plot_3D-1717"><a href="#StarData.plot_3D-1717"><span class="linenos">1717</span></a>        
</span><span id="StarData.plot_3D-1718"><a href="#StarData.plot_3D-1718"><span class="linenos">1718</span></a>        <span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">,</span> <span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_small</span><span class="p">),</span> <span class="o">-</span><span class="n">z_bound</span><span class="p">,</span> <span class="n">z_bound</span>
</span><span id="StarData.plot_3D-1719"><a href="#StarData.plot_3D-1719"><span class="linenos">1719</span></a>        <span class="n">gridx</span><span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">gridz</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fast_interpolation</span><span class="p">((</span><span class="n">v_small</span><span class="p">,</span> <span class="n">y_small</span><span class="p">,</span> <span class="n">x_small</span><span class="p">),</span> <span class="p">(</span><span class="n">x_lo</span><span class="p">,</span> <span class="n">x_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">y_lo</span><span class="p">,</span> <span class="n">y_hi</span><span class="p">),</span> <span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">v_func</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1720"><a href="#StarData.plot_3D-1720"><span class="linenos">1720</span></a>
</span><span id="StarData.plot_3D-1721"><a href="#StarData.plot_3D-1721"><span class="linenos">1721</span></a>
</span><span id="StarData.plot_3D-1722"><a href="#StarData.plot_3D-1722"><span class="linenos">1722</span></a>        <span class="c1"># filter by standard deviation</span>
</span><span id="StarData.plot_3D-1723"><a href="#StarData.plot_3D-1723"><span class="linenos">1723</span></a>        <span class="k">if</span> <span class="n">filter_stds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1724"><a href="#StarData.plot_3D-1724"><span class="linenos">1724</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">out</span> <span class="o">&lt;</span> <span class="n">filter_stds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StarData.plot_3D-1725"><a href="#StarData.plot_3D-1725"><span class="linenos">1725</span></a>
</span><span id="StarData.plot_3D-1726"><a href="#StarData.plot_3D-1726"><span class="linenos">1726</span></a>        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Plotly cant deal with nans</span>
</span><span id="StarData.plot_3D-1727"><a href="#StarData.plot_3D-1727"><span class="linenos">1727</span></a>
</span><span id="StarData.plot_3D-1728"><a href="#StarData.plot_3D-1728"><span class="linenos">1728</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1729"><a href="#StarData.plot_3D-1729"><span class="linenos">1729</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> non-nan points.&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1730"><a href="#StarData.plot_3D-1730"><span class="linenos">1730</span></a>
</span><span id="StarData.plot_3D-1731"><a href="#StarData.plot_3D-1731"><span class="linenos">1731</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="StarData.plot_3D-1732"><a href="#StarData.plot_3D-1732"><span class="linenos">1732</span></a>        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
</span><span id="StarData.plot_3D-1733"><a href="#StarData.plot_3D-1733"><span class="linenos">1733</span></a>
</span><span id="StarData.plot_3D-1734"><a href="#StarData.plot_3D-1734"><span class="linenos">1734</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1735"><a href="#StarData.plot_3D-1735"><span class="linenos">1735</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting figure...&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1736"><a href="#StarData.plot_3D-1736"><span class="linenos">1736</span></a>
</span><span id="StarData.plot_3D-1737"><a href="#StarData.plot_3D-1737"><span class="linenos">1737</span></a>        
</span><span id="StarData.plot_3D-1738"><a href="#StarData.plot_3D-1738"><span class="linenos">1738</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1739"><a href="#StarData.plot_3D-1739"><span class="linenos">1739</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1740"><a href="#StarData.plot_3D-1740"><span class="linenos">1740</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">gridx</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1741"><a href="#StarData.plot_3D-1741"><span class="linenos">1741</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">gridy</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1742"><a href="#StarData.plot_3D-1742"><span class="linenos">1742</span></a>                <span class="n">z</span><span class="o">=</span><span class="n">gridz</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1743"><a href="#StarData.plot_3D-1743"><span class="linenos">1743</span></a>                <span class="n">value</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1744"><a href="#StarData.plot_3D-1744"><span class="linenos">1744</span></a>                <span class="n">isomin</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1745"><a href="#StarData.plot_3D-1745"><span class="linenos">1745</span></a>                <span class="n">colorscale</span><span class="o">=</span> <span class="n">colorscale</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1746"><a href="#StarData.plot_3D-1746"><span class="linenos">1746</span></a>                <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Flux Density (Jy/beam)&quot;</span><span class="p">),</span>
</span><span id="StarData.plot_3D-1747"><a href="#StarData.plot_3D-1747"><span class="linenos">1747</span></a>                <span class="n">opacityscale</span><span class="o">=</span><span class="n">opacityscale</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1748"><a href="#StarData.plot_3D-1748"><span class="linenos">1748</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span> <span class="c1"># needs to be small to see through all surfaces</span>
</span><span id="StarData.plot_3D-1749"><a href="#StarData.plot_3D-1749"><span class="linenos">1749</span></a>                <span class="n">surface_count</span><span class="o">=</span><span class="n">num_surfaces</span><span class="p">,</span> <span class="c1"># needs to be a large number for good volume rendering</span>
</span><span id="StarData.plot_3D-1750"><a href="#StarData.plot_3D-1750"><span class="linenos">1750</span></a>                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="StarData.plot_3D-1751"><a href="#StarData.plot_3D-1751"><span class="linenos">1751</span></a>            <span class="p">),</span>
</span><span id="StarData.plot_3D-1752"><a href="#StarData.plot_3D-1752"><span class="linenos">1752</span></a>            <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1753"><a href="#StarData.plot_3D-1753"><span class="linenos">1753</span></a>                <span class="n">title</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StarData.plot_3D-1754"><a href="#StarData.plot_3D-1754"><span class="linenos">1754</span></a>                    <span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="n">title</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1755"><a href="#StarData.plot_3D-1755"><span class="linenos">1755</span></a>                    <span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1756"><a href="#StarData.plot_3D-1756"><span class="linenos">1756</span></a>                    <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="mf">0.95</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1757"><a href="#StarData.plot_3D-1757"><span class="linenos">1757</span></a>                    <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
</span><span id="StarData.plot_3D-1758"><a href="#StarData.plot_3D-1758"><span class="linenos">1758</span></a>                    <span class="s2">&quot;font&quot;</span><span class="p">:{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">}</span>
</span><span id="StarData.plot_3D-1759"><a href="#StarData.plot_3D-1759"><span class="linenos">1759</span></a>                <span class="p">},</span>
</span><span id="StarData.plot_3D-1760"><a href="#StarData.plot_3D-1760"><span class="linenos">1760</span></a>                <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1761"><a href="#StarData.plot_3D-1761"><span class="linenos">1761</span></a>                      <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1762"><a href="#StarData.plot_3D-1762"><span class="linenos">1762</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1763"><a href="#StarData.plot_3D-1763"><span class="linenos">1763</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;X (AU)&#39;</span>
</span><span id="StarData.plot_3D-1764"><a href="#StarData.plot_3D-1764"><span class="linenos">1764</span></a>                          <span class="p">)</span>
</span><span id="StarData.plot_3D-1765"><a href="#StarData.plot_3D-1765"><span class="linenos">1765</span></a>                      <span class="p">),</span>
</span><span id="StarData.plot_3D-1766"><a href="#StarData.plot_3D-1766"><span class="linenos">1766</span></a>                      <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1767"><a href="#StarData.plot_3D-1767"><span class="linenos">1767</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1768"><a href="#StarData.plot_3D-1768"><span class="linenos">1768</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Y (AU)&#39;</span>
</span><span id="StarData.plot_3D-1769"><a href="#StarData.plot_3D-1769"><span class="linenos">1769</span></a>                          <span class="p">)</span>
</span><span id="StarData.plot_3D-1770"><a href="#StarData.plot_3D-1770"><span class="linenos">1770</span></a>                      <span class="p">),</span>
</span><span id="StarData.plot_3D-1771"><a href="#StarData.plot_3D-1771"><span class="linenos">1771</span></a>                      <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1772"><a href="#StarData.plot_3D-1772"><span class="linenos">1772</span></a>                          <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="StarData.plot_3D-1773"><a href="#StarData.plot_3D-1773"><span class="linenos">1773</span></a>                              <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Z (AU)&#39;</span>
</span><span id="StarData.plot_3D-1774"><a href="#StarData.plot_3D-1774"><span class="linenos">1774</span></a>                          <span class="p">)</span>
</span><span id="StarData.plot_3D-1775"><a href="#StarData.plot_3D-1775"><span class="linenos">1775</span></a>                      <span class="p">),</span>
</span><span id="StarData.plot_3D-1776"><a href="#StarData.plot_3D-1776"><span class="linenos">1776</span></a>                      <span class="n">aspectmode</span> <span class="o">=</span> <span class="s2">&quot;cube&quot;</span>
</span><span id="StarData.plot_3D-1777"><a href="#StarData.plot_3D-1777"><span class="linenos">1777</span></a>                    <span class="p">),</span>
</span><span id="StarData.plot_3D-1778"><a href="#StarData.plot_3D-1778"><span class="linenos">1778</span></a>            <span class="p">)</span>
</span><span id="StarData.plot_3D-1779"><a href="#StarData.plot_3D-1779"><span class="linenos">1779</span></a>        <span class="p">)</span>
</span><span id="StarData.plot_3D-1780"><a href="#StarData.plot_3D-1780"><span class="linenos">1780</span></a>
</span><span id="StarData.plot_3D-1781"><a href="#StarData.plot_3D-1781"><span class="linenos">1781</span></a>
</span><span id="StarData.plot_3D-1782"><a href="#StarData.plot_3D-1782"><span class="linenos">1782</span></a>
</span><span id="StarData.plot_3D-1783"><a href="#StarData.plot_3D-1783"><span class="linenos">1783</span></a>        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1784"><a href="#StarData.plot_3D-1784"><span class="linenos">1784</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1785"><a href="#StarData.plot_3D-1785"><span class="linenos">1785</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating frames...&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1786"><a href="#StarData.plot_3D-1786"><span class="linenos">1786</span></a>            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="n">num_angles</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1787"><a href="#StarData.plot_3D-1787"><span class="linenos">1787</span></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1788"><a href="#StarData.plot_3D-1788"><span class="linenos">1788</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
</span><span id="StarData.plot_3D-1789"><a href="#StarData.plot_3D-1789"><span class="linenos">1789</span></a>                <span class="n">eye</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="n">camera_dist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">z</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1790"><a href="#StarData.plot_3D-1790"><span class="linenos">1790</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera_eye</span> <span class="o">=</span> <span class="n">eye</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1791"><a href="#StarData.plot_3D-1791"><span class="linenos">1791</span></a>                <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1792"><a href="#StarData.plot_3D-1792"><span class="linenos">1792</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/angle</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1793"><a href="#StarData.plot_3D-1793"><span class="linenos">1793</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1794"><a href="#StarData.plot_3D-1794"><span class="linenos">1794</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1795"><a href="#StarData.plot_3D-1795"><span class="linenos">1795</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1796"><a href="#StarData.plot_3D-1796"><span class="linenos">1796</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating frames: </span><span class="si">{</span><span class="n">a</span><span class="o">/</span><span class="mi">360</span><span class="si">}</span><span class="s2">% complete.&quot;</span><span class="p">)</span>
</span><span id="StarData.plot_3D-1797"><a href="#StarData.plot_3D-1797"><span class="linenos">1797</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StarData.plot_3D-1798"><a href="#StarData.plot_3D-1798"><span class="linenos">1798</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot a 3D volume rendering of the data cube using Plotly.</p>

<p><strong>Parameters</strong></p>

<ul>
<li><code>filter_stds</code> (<code>float</code> or <code>int</code> or <code>None</code>, optional): Number of standard deviations to filter by (default is None).</li>
<li><code>filter_beam</code> (<code>bool</code>, optional): If True, apply beam filtering (default is False).</li>
<li><code>z_cutoff</code> (<code>float</code> or <code>None</code>, optional): Cutoff for z values as a proportion of the largest x, y values (default is 1).</li>
<li><code>crop_leeway</code> (<code>int</code> or <code>float</code>, optional): Fractional leeway to expand the crop region (default is 0).</li>
<li><code>num_points</code> (<code>int</code>, optional): Number of points in each dimension for the grid (default is 50).</li>
<li><code>num_surfaces</code> (<code>int</code>, optional): Number of surfaces to draw when rendering the plot (default is 50).</li>
<li><code>opacity</code> (<code>float</code> or <code>int</code>, optional): Opacity of the volume rendering (default is 0.5).</li>
<li><code>opacityscale</code> (<code>list</code> of <code>list</code> of <code>float</code>, optional): Opacity scale, see <a href="https://plotly.com/python-api-reference/generated/plotly.graph_objects.Volume.html">https://plotly.com/python-api-reference/generated/plotly.graph_objects.Volume.html</a> (default is [[0, 0], [1, 1]]).</li>
<li><code>colorscale</code> (<code>str</code>, optional): Colormap for the plot, see <a href="https://plotly.com/python/builtin-colorscales/">https://plotly.com/python/builtin-colorscales/</a> (default is "Reds").</li>
<li><code>v_func</code> (<code><a href="#VelocityModel">VelocityModel</a></code> or <code>None</code>, optional): Velocity law function (default is None, which uses constant expansion velocity).</li>
<li><code>verbose</code> (<code>bool</code>, optional): If True, print progress (default is False).</li>
<li><code>title</code> (<code>str</code> or <code>None</code>, optional): Plot title (default is None, which uses the star name).</li>
<li><code>folder</code> (<code>str</code> or <code>None</code>, optional): If provided, generates successive frames and saves as png files to this folder (default is None).</li>
<li><code>num_angles</code> (<code>int</code>, optional): Number of angles for saving images (default is 24). Greater values give smoother animation.</li>
<li><code>camera_dist</code> (<code>float</code> or <code>int</code>, optional): Camera radius to use if generating frames (default is 2).</li>
</ul>
</div>


                            </div>
                </section>
    </main>
</body>
</html>